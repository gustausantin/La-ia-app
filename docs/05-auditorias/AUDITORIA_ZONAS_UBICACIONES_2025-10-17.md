# üè¢ AUDITOR√çA COMPLETA: SISTEMA DE ZONAS/UBICACIONES
**Fecha:** 17 de Octubre 2025  
**Objetivo:** Estandarizar zonas de mesas a 4 opciones (Interior, Terraza, Barra, Privado)  
**Estado:** üìã AUDITOR√çA COMPLETA - PENDIENTE IMPLEMENTACI√ìN

---

## üìã **CHECKLIST OBLIGATORIO CUMPLIDO**

‚úÖ **NORMA 1:** Ajuste quir√∫rgico - No degradar calidad  
‚úÖ **NORMA 2:** Todos los datos de BD - No inventar  
‚úÖ **NORMA 3:** Multi-tenant - restaurant_id en todas las queries  
‚úÖ **NORMA 4:** Schema revisado ANTES de modificar

‚úÖ **Lectura previa:** Documentaci√≥n completa le√≠da  
‚úÖ **Datos verificados:** Schema de BD confirmado  
‚úÖ **Origen confirmado:** Zonas actuales identificadas

---

## üéØ **SITUACI√ìN ACTUAL**

### **1. BASE DE DATOS**

#### **Tabla `tables`:**
```sql
tables (
  id uuid PRIMARY KEY,
  restaurant_id uuid NOT NULL,
  table_number text NOT NULL,
  name varchar,
  capacity integer NOT NULL,
  location text,               ‚Üê Campo texto libre (NO se usa actualmente)
  zone varchar DEFAULT 'main', ‚Üê Campo categor√≠a (ESTE SE USA)
  status text DEFAULT 'available',
  position_x float8,
  position_y float8,
  notes text,
  is_active boolean DEFAULT true,
  created_at timestamptz,
  updated_at timestamptz
)
```

**Estado:**
- ‚úÖ Campo `zone` existe y se usa
- ‚ùå NO hay constraint CHECK (puede tener cualquier valor)
- ‚ùå NO hay ENUM (es VARCHAR libre)
- ‚ùå Valores inconsistentes: "Sal√≥n principal", "main", "Terraza", etc.

#### **Tabla `reservations`:**
```sql
reservations (
  id uuid PRIMARY KEY,
  restaurant_id uuid NOT NULL,
  customer_id uuid,
  customer_name varchar NOT NULL,
  customer_email varchar,
  customer_phone varchar,
  reservation_date date NOT NULL,
  reservation_time time NOT NULL,
  party_size integer NOT NULL,
  table_id uuid,                        ‚Üê FK a tables (puede ser NULL)
  table_number varchar,
  status varchar DEFAULT 'confirmed',
  channel varchar DEFAULT 'web',
  source varchar DEFAULT 'web',
  reservation_source varchar DEFAULT 'manual',
  notes text,
  special_requests text,                ‚Üê Se usa para guardar preferencias
  spend_amount numeric DEFAULT 0.00,
  created_at timestamptz,
  updated_at timestamptz
)
```

**Estado:**
- ‚ùå **NO existe campo `preferred_zone`**
- ‚ùå **NO existe campo `zone`**
- ‚úÖ Actualmente se guarda en `special_requests` (texto libre)

#### **Tabla `availability_slots`:**
```sql
availability_slots (
  id uuid PRIMARY KEY,
  restaurant_id uuid NOT NULL,
  table_id uuid NOT NULL,        ‚Üê FK a tables (hereda zone)
  slot_date date NOT NULL,
  start_time time NOT NULL,
  end_time time NOT NULL,
  status text DEFAULT 'free',
  source text DEFAULT 'system',
  shift_name text,
  is_available boolean DEFAULT true,
  metadata jsonb DEFAULT '{}',
  created_at timestamptz,
  updated_at timestamptz
)
```

**Estado:**
- ‚úÖ NO necesita cambios (hereda zone de `tables`)
- ‚úÖ Sistema de disponibilidades NO se ve afectado

---

### **2. FRONTEND**

#### **P√°gina `Mesas.jsx` (l√≠neas 1718-1727):**
```jsx
<select value={formData.zone} ...>
  <option value="">Seleccionar zona...</option>
  <option value="Sal√≥n principal">Sal√≥n principal</option>
  <option value="Sal√≥n secundario">Sal√≥n secundario</option>
  <option value="Terraza">Terraza</option>
  <option value="Privado">Privado</option>
  <option value="Exterior">Exterior</option>
  <option value="Barra">Barra</option>
  <option value="VIP">Zona VIP</option>
  <option value="Otros">Otros</option>
</select>
```

**Problemas:**
- ‚ùå **8 opciones** (demasiadas)
- ‚ùå Inconsistencia: "Sal√≥n principal" vs "Interior"
- ‚ùå Redundancia: "Exterior" = "Terraza", "VIP" = "Privado"
- ‚ùå Valores hardcodeados (no vienen de constantes)

#### **Hook `useReservationWizard.js` (l√≠neas 36, 49, 220-308):**
```javascript
// Estado del wizard
const [formData, setFormData] = useState({
  ...
  zone: initialData?.zone || null,  // ‚Üê Campo zone existe
  tableIds: initialData?.table_ids || [],
  ...
});

// Validaci√≥n de zona
const [validations, setValidations] = useState({
  ...
  zone: { valid: null, message: '', zones: [] },  // ‚Üê Validaci√≥n existe
  ...
});

// Funci√≥n validateZone() (l√≠nea 220)
const validateZone = useCallback(async (partySize, date, time) => {
  // Agrupa mesas disponibles por zona
  const zoneCapacity = {};
  availableTables.forEach(table => {
    const zone = table.zone || 'main';  // ‚Üê Usa tables.zone
    ...
  });
  ...
});
```

**Estado:**
- ‚úÖ Sistema de zonas YA implementado en wizard
- ‚úÖ Validaci√≥n de zona existe
- ‚úÖ Filtrado por zona funciona
- ‚ùå NO se guarda en `reservations` (solo en `special_requests`)

#### **Componente `ReservationWizard.jsx` (l√≠neas 659-705):**
```jsx
// PASO 5: ZONA
const StepZone = ({ formData, validation, isLoading, onChange }) => {
  const zones = validation?.zones || [];
  
  return (
    <div className="space-y-6">
      <h3>üìç Selecciona la Zona</h3>
      <p>¬øD√≥nde prefieres sentarte?</p>
      
      {zones.map((zone) => (
        <button
          key={zone.zone}
          onClick={() => zone.sufficient && onChange('zone', zone.zone)}
          disabled={!zone.sufficient}
          className={...}
        >
          <span className="capitalize">{zone.zone}</span>
          ...
        </button>
      ))}
    </div>
  );
};
```

**Estado:**
- ‚úÖ **PASO 5 del wizard ya existe**
- ‚úÖ Muestra zonas din√°micamente basadas en disponibilidad
- ‚úÖ Permite seleccionar zona
- ‚ùå Muestra TODAS las zonas encontradas (no filtradas)

---

### **3. N8N WORKFLOWS**

#### **Workflow `3-super-agent-hibrido-FINAL-CORREGIDO.json`:**

**Tool `check_availability`:**
```json
{
  "name": "check_availability",
  "description": "Verifica disponibilidad en el restaurante",
  "fields": {
    "values": [
      {"name": "date"},
      {"name": "time"},
      {"name": "party_size"},
      {"name": "restaurant_id"}
    ]
  }
}
```

**Estado:**
- ‚ùå **NO incluye par√°metro `preferred_zone`**
- ‚ùå NO filtra por zona

**Tool `create_reservation`:**
```json
{
  "name": "create_reservation",
  "description": "Crea una nueva reserva en el restaurante",
  "fields": {
    "values": [
      {"name": "reservation_date"},
      {"name": "reservation_time"},
      {"name": "party_size"},
      {"name": "special_requests"}
    ]
  }
}
```

**Estado:**
- ‚ùå **NO incluye par√°metro `preferred_zone`**
- ‚úÖ Usa `special_requests` (donde actualmente se guarda)

#### **Workflow `Tool - check-availability.json`:**
```javascript
const input = $input.first().json;
const fecha = input.date || input.reservation_date || '';
const hora = input.time || input.reservation_time || '';
const personas = parseInt(input.party_size || input.people || 0);
const ubicacion = input.reservation_location || input.location || null; // ‚Üê YA PREPARADO
const restaurant_id = input.restaurant_id || '';
```

**Estado:**
- ‚úÖ **Ya captura `ubicacion`** pero NO la usa
- ‚ùå NO filtra mesas por zona en la query
- ‚ùå NO valida valores de zona

---

### **4. PROMPTS DEL AGENTE**

#### **`PROMPT-SUPER-AGENT-v3-PERFECTO.txt`:**

**Estado:**
- ‚ùå **NO menciona zonas** en ning√∫n paso
- ‚ùå NO pregunta por ubicaci√≥n/zona
- ‚ùå NO incluye zona en ejemplos de tools
- ‚ùå Checklist no incluye paso de zona

**Tool `check_availability` en prompt (l√≠neas 84-91):**
```markdown
**Par√°metros obligatorios:**
```json
{
  "date": "2025-10-19",
  "time": "20:00",
  "party_size": 4,
  "restaurant_id": "{{ $json.restaurant_id }}"
}
```
```

**Estado:**
- ‚ùå NO incluye `preferred_zone`

---

## üéØ **DECISIONES TOMADAS (ACORDADO CON USUARIO)**

### **1. Zonas a implementar (4):**
```
1. Interior    ‚Üê Engloba "Sal√≥n principal", "Sal√≥n secundario", "main"
2. Terraza     ‚Üê Engloba "Exterior", "Terraza"
3. Barra       ‚Üê Se mantiene igual
4. Privado     ‚Üê Engloba "Sala reservada", "Zona VIP", "Privado"
```

### **2. Comportamiento del agente:**
- ‚úÖ Ofrece por defecto: **Interior, Terraza, Barra** (3 opciones)
- ‚úÖ **Privado** solo se sugiere cuando:
  - Grupo ‚â• 8 personas
  - Cliente menciona keywords: "tranquilo", "√≠ntimo", "rom√°ntico", "privado", "discreto"
  - Cliente pregunta expl√≠citamente por zona privada

### **3. Zona como campo opcional:**
- ‚úÖ Si cliente NO especifica ‚Üí Asignaci√≥n autom√°tica (cualquier zona)
- ‚úÖ Si cliente especifica ‚Üí Filtrar disponibilidad por esa zona
- ‚úÖ Si zona solicitada NO tiene disponibilidad ‚Üí Sugerir alternativa

---

## üìù **PLAN DE IMPLEMENTACI√ìN QUIR√öRGICO**

### **FASE 1: BASE DE DATOS** (CR√çTICO)

#### **1.1. Migraci√≥n: Normalizar valores existentes**
```sql
-- Archivo: supabase/migrations/20251017_001_normalize_table_zones.sql

-- PASO 1: Normalizar valores existentes
UPDATE tables
SET zone = CASE
  WHEN zone ILIKE '%terraza%' OR zone ILIKE '%exterior%' THEN 'terraza'
  WHEN zone ILIKE '%privado%' OR zone ILIKE '%vip%' THEN 'privado'
  WHEN zone ILIKE '%barra%' THEN 'barra'
  ELSE 'interior'
END
WHERE restaurant_id IS NOT NULL;

-- PASO 2: Crear ENUM de zonas
CREATE TYPE zone_type AS ENUM ('interior', 'terraza', 'barra', 'privado');

-- PASO 3: Convertir columna a ENUM
ALTER TABLE tables 
ALTER COLUMN zone TYPE zone_type USING zone::zone_type;

-- PASO 4: Establecer DEFAULT
ALTER TABLE tables 
ALTER COLUMN zone SET DEFAULT 'interior'::zone_type;

-- PASO 5: Agregar NOT NULL constraint
ALTER TABLE tables 
ALTER COLUMN zone SET NOT NULL;
```

**Impacto:**
- ‚úÖ Estandariza valores existentes
- ‚úÖ Previene valores inv√°lidos futuros
- ‚úÖ Compatible con datos actuales
- ‚ö†Ô∏è **CR√çTICO:** Ejecutar en horario de bajo tr√°fico

**Rollback:**
```sql
-- Si algo falla, revertir
ALTER TABLE tables ALTER COLUMN zone TYPE varchar USING zone::varchar;
DROP TYPE zone_type;
```

#### **1.2. Migraci√≥n: Agregar `preferred_zone` a reservations**
```sql
-- Archivo: supabase/migrations/20251017_002_add_preferred_zone_to_reservations.sql

-- Agregar columna preferred_zone
ALTER TABLE reservations
ADD COLUMN IF NOT EXISTS preferred_zone zone_type;

-- √çndice para consultas por zona
CREATE INDEX IF NOT EXISTS idx_reservations_preferred_zone
ON reservations(restaurant_id, preferred_zone)
WHERE preferred_zone IS NOT NULL;
```

**Impacto:**
- ‚úÖ Permite guardar preferencia de zona
- ‚úÖ No afecta reservas existentes (NULL)
- ‚úÖ Indexado para consultas r√°pidas
- ‚úÖ Compatible con multi-tenant

---

### **FASE 2: FRONTEND** (CIRUG√çA DE PRECISI√ìN)

#### **2.1. Crear constante de zonas**
```javascript
// Archivo: src/constants/zones.js

export const ZONE_OPTIONS = {
  INTERIOR: 'interior',
  TERRAZA: 'terraza',
  BARRA: 'barra',
  PRIVADO: 'privado'
};

export const ZONE_LABELS = {
  [ZONE_OPTIONS.INTERIOR]: 'Interior',
  [ZONE_OPTIONS.TERRAZA]: 'Terraza',
  [ZONE_OPTIONS.BARRA]: 'Barra',
  [ZONE_OPTIONS.PRIVADO]: 'Privado (Sala reservada)'
};

export const ZONE_ICONS = {
  [ZONE_OPTIONS.INTERIOR]: 'üè†',
  [ZONE_OPTIONS.TERRAZA]: '‚òÄÔ∏è',
  [ZONE_OPTIONS.BARRA]: 'üç∑',
  [ZONE_OPTIONS.PRIVADO]: 'üö™'
};
```

#### **2.2. Actualizar `Mesas.jsx`**
```jsx
// L√≠neas 1718-1727 (REEMPLAZAR)
import { ZONE_OPTIONS, ZONE_LABELS } from '../constants/zones';

<select value={formData.zone} ...>
  <option value="">Seleccionar zona...</option>
  {Object.entries(ZONE_LABELS).map(([key, label]) => (
    <option key={key} value={key}>{label}</option>
  ))}
</select>
```

**Cambios:**
- ‚úÖ Reduce de 8 a 4 opciones
- ‚úÖ Usa constantes (no hardcoding)
- ‚úÖ Valores consistentes con ENUM de BD

#### **2.3. Actualizar `useReservationWizard.js`**
```javascript
// L√≠nea 36 (ACTUALIZAR)
zone: initialData?.zone || null,  // ‚úÖ Ya existe

// L√≠nea 267 (ACTUALIZAR zona default)
const zone = table.zone || ZONE_OPTIONS.INTERIOR;  // Usar constante
```

**Cambios:**
- ‚úÖ Usa constantes de zonas
- ‚úÖ L√≥gica actual se mantiene
- ‚úÖ Compatible con backend

#### **2.4. Actualizar `ReservationWizard.jsx`**
```jsx
// L√≠neas 697 (ACTUALIZAR para mostrar icono + label)
import { ZONE_LABELS, ZONE_ICONS } from '../constants/zones';

<span className="text-lg font-semibold">
  {ZONE_ICONS[zone.zone]} {ZONE_LABELS[zone.zone] || zone.zone}
</span>
```

**Cambios:**
- ‚úÖ Mejora UX con iconos
- ‚úÖ Labels consistentes
- ‚úÖ Fallback a valor raw si no existe

---

### **FASE 3: N8N WORKFLOWS** (INTEGRACI√ìN AGENTE)

#### **3.1. Actualizar Tool `check_availability`**
```json
{
  "name": "check_availability",
  "description": "Verifica disponibilidad en el restaurante para una fecha, hora y n√∫mero de personas. Opcionalmente puedes especificar una zona preferida.",
  "fields": {
    "values": [
      {"name": "date"},
      {"name": "time"},
      {"name": "party_size"},
      {"name": "preferred_zone"},  // ‚Üê NUEVO
      {"name": "restaurant_id"}
    ]
  }
}
```

**Implementaci√≥n en workflow `Tool - check-availability.json`:**
```javascript
const ubicacion = input.preferred_zone || input.zone || input.location || null;

// VALIDAR zona si se especific√≥
const validZones = ['interior', 'terraza', 'barra', 'privado', 'any'];
let zonaFinal = null;

if (ubicacion && ubicacion !== 'any') {
  const zonaNormalizada = ubicacion.toLowerCase().trim();
  if (validZones.includes(zonaNormalizada)) {
    zonaFinal = zonaNormalizada;
  } else {
    console.log(`‚ö†Ô∏è Zona inv√°lida: "${ubicacion}". Se buscar√° en todas las zonas.`);
  }
}

// CONSULTAR disponibilidad con filtro de zona
let query = supabase
  .from('tables')
  .select('*')
  .eq('restaurant_id', restaurant_id)
  .gte('capacity', personas)
  .eq('is_active', true);

if (zonaFinal) {
  query = query.eq('zone', zonaFinal);
  console.log(`üìç Filtrando por zona: ${zonaFinal}`);
}

const { data: availableTables, error } = await query;
```

**Cambios:**
- ‚úÖ Acepta `preferred_zone` como par√°metro
- ‚úÖ Valida valores contra ENUM
- ‚úÖ Filtra mesas por zona si se especifica
- ‚úÖ Si zona inv√°lida ‚Üí busca en todas (fallback robusto)

#### **3.2. Actualizar Tool `create_reservation`**
```json
{
  "name": "create_reservation",
  "description": "Crea una nueva reserva en el restaurante",
  "fields": {
    "values": [
      {"name": "reservation_date"},
      {"name": "reservation_time"},
      {"name": "party_size"},
      {"name": "preferred_zone"},     // ‚Üê NUEVO
      {"name": "special_requests"},
      {"name": "restaurant_id"}
    ]
  }
}
```

**Implementaci√≥n en workflow (nodo Supabase):**
```javascript
const zonaPreferida = input.preferred_zone || null;

// Insertar reserva
const { data, error } = await supabase
  .from('reservations')
  .insert({
    restaurant_id: input.restaurant_id,
    customer_name: customerName,
    customer_phone: customerPhone,
    reservation_date: input.reservation_date,
    reservation_time: input.reservation_time,
    party_size: input.party_size,
    preferred_zone: zonaPreferida,  // ‚Üê NUEVO CAMPO
    special_requests: input.special_requests,
    status: 'pending',
    source: 'ia',
    channel: 'whatsapp'
  });
```

**Cambios:**
- ‚úÖ Guarda `preferred_zone` en BD
- ‚úÖ Mantiene `special_requests` (compatible)
- ‚úÖ Valida antes de insertar

---

### **FASE 4: PROMPT DEL AGENTE** (L√ìGICA INTELIGENTE)

#### **4.1. Actualizar `PROMPT-SUPER-AGENT-v3-PERFECTO.txt`**

**Cambios en la CHECKLIST (l√≠nea 64):**
```markdown
‚òê 1. FECHA obtenida y confirmada (convertida a YYYY-MM-DD)
‚òê 2. HORA obtenida y confirmada (convertida a HH:MM en 24h)
‚òê 3. PERSONAS obtenidas y confirmadas (n√∫mero entero)
‚òê 3.5. ZONA preguntada si aplica (ver reglas de zona)  // ‚Üê NUEVO
‚òê 4. DISPONIBILIDAD verificada con "check_availability"
‚òê 5. NOMBRE confirmado (ya lo tienes: {{ $json.customer_name }})
‚òê 6. NOTAS ESPECIALES preguntadas (puede ser "ninguna")
‚òê 7. RESERVA CREADA con "create_reservation"
```

**Insertar NUEVA SECCI√ìN despu√©s de l√≠nea 49 (despu√©s de fechas):**
```markdown
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üè¢ GESTI√ìN DE ZONAS (NUEVO)
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

El restaurante tiene las siguientes zonas:
‚Ä¢ üè† Interior
‚Ä¢ ‚òÄÔ∏è Terraza
‚Ä¢ üç∑ Barra
‚Ä¢ üö™ Privado (sala reservada)

**REGLAS DE ZONA:**

**1. POR DEFECTO:** Ofrecer Interior, Terraza y Barra
   "¬øTienes preferencia de zona? Tenemos interior, terraza o barra."

**2. SOLO SUGERIR PRIVADO SI:**
   - Grupo ‚â• 8 personas:
     "Para grupos grandes tenemos una sala privada. ¬øTe interesar√≠a?"
   
   - Cliente menciona keywords ("tranquilo", "√≠ntimo", "rom√°ntico", "privado", "discreto"):
     "Tenemos una sala m√°s reservada que puede ser perfecta. ¬øTe gustar√≠a?"
   
   - Cliente pregunta expl√≠citamente:
     "¬øTen√©is zona privada?" ‚Üí "S√≠, tenemos sala privada. ¬øTe gustar√≠a reservar ah√≠?"

**3. SI CLIENTE NO ESPECIFICA:**
   ‚Üí NO preguntes insistentemente
   ‚Üí Usa zona="any" en check_availability (buscar√° en todas)

**4. SI ZONA SOLICITADA NO TIENE DISPONIBILIDAD:**
   "Veo que [zona] est√° completa. ¬øTe ir√≠a bien en [zona_alternativa]?"

**5. AL LLAMAR TOOLS:**
   - check_availability: incluye "preferred_zone": "interior|terraza|barra|privado|any"
   - create_reservation: incluye "preferred_zone": "interior|terraza|barra|privado"
```

**Actualizar TOOL check_availability (l√≠nea 84):**
```markdown
**1. check_availability** ‚Äî Verifica disponibilidad en tiempo real
**Uso:** INMEDIATAMENTE despu√©s de confirmar fecha, hora y personas
**Par√°metros obligatorios:**
```json
{
  "date": "2025-10-19",
  "time": "20:00",
  "party_size": 4,
  "preferred_zone": "terraza",  // ‚Üê NUEVO: "interior"|"terraza"|"barra"|"privado"|"any"
  "restaurant_id": "{{ $json.restaurant_id }}"
}
```
```

**Actualizar TOOL create_reservation (l√≠nea 96):**
```markdown
**2. create_reservation** ‚Äî Crea la reserva
**Uso:** SOLO despu√©s de check_availability exitoso
**Par√°metros obligatorios:**
```json
{
  "reservation_date": "2025-10-19",
  "reservation_time": "20:00",
  "party_size": 4,
  "preferred_zone": "terraza",  // ‚Üê NUEVO (opcional, puede ser null)
  "special_requests": "",
  "restaurant_id": "{{ $json.restaurant_id }}"
}
```
```

**Actualizar FLUJO DE CONVERSACI√ìN (insertar despu√©s de PASO 3):**
```markdown
**Paso 3.5 - ZONA (OPCIONAL):**

**Si NO especific√≥:**
"¬øTienes preferencia de zona? Tenemos interior, terraza o barra. Si prefieres, puedo asignarte autom√°ticamente."

**Si especifica:**
Cliente: "Terraza" ‚Üí Guardar: preferred_zone = "terraza"
Cliente: "Me da igual" ‚Üí Guardar: preferred_zone = "any"

**Si grupo ‚â• 8:**
"Para grupos grandes tenemos una sala privada disponible. ¬øTe interesar√≠a, o prefieres la zona general?"

**Si menciona keywords:**
Cliente: "Quiero algo tranquilo" ‚Üí "Tenemos una sala m√°s reservada. ¬øTe gustar√≠a?"

**Al verificar disponibilidad (PASO 4):**
Usa check_availability con el preferred_zone capturado
```

---

## ‚ö†Ô∏è **RIESGOS Y MITIGACIONES**

### **Riesgo 1: Mesas existentes con valores inv√°lidos**
**Mitigaci√≥n:**
- Script de normalizaci√≥n ANTES de crear ENUM
- Validar datos actuales: `SELECT DISTINCT zone FROM tables;`
- Mapear casos edge manualmente si es necesario

### **Riesgo 2: Reservas en proceso durante migraci√≥n**
**Mitigaci√≥n:**
- Ejecutar en horario de bajo tr√°fico (4 AM)
- Transacci√≥n at√≥mica (BEGIN...COMMIT)
- Rollback preparado
- Notificaci√≥n a usuarios si es necesario

### **Riesgo 3: Frontend usa valores antiguos en cache**
**Mitigaci√≥n:**
- Incrementar versi√≥n de constantes
- Hard refresh despu√©s de deploy
- Mantener compatibilidad con valores legacy temporalmente

### **Riesgo 4: N8N workflows en ejecuci√≥n**
**Mitigaci√≥n:**
- Desplegar workflows actualizados ANTES de migraci√≥n BD
- Mantener `ubicacion` como fallback en c√≥digo
- Validaci√≥n robusta con fallback a 'any'

---

## üß™ **PLAN DE TESTING**

### **Test 1: Normalizaci√≥n de datos**
```sql
-- ANTES de migraci√≥n
SELECT zone, COUNT(*) 
FROM tables 
WHERE restaurant_id = 'd6b63130-1ebf-4284-98fc-a3b31a85d9d1'
GROUP BY zone;

-- Ejecutar normalizaci√≥n

-- DESPU√âS de migraci√≥n
SELECT zone, COUNT(*) 
FROM tables 
WHERE restaurant_id = 'd6b63130-1ebf-4284-98fc-a3b31a85d9d1'
GROUP BY zone;

-- Resultado esperado: solo 'interior', 'terraza', 'barra', 'privado'
```

### **Test 2: Frontend - Crear mesa**
1. Ir a p√°gina Mesas
2. Crear nueva mesa
3. Verificar dropdown tiene solo 4 opciones
4. Seleccionar "Terraza"
5. Guardar
6. Verificar en BD: `zone = 'terraza'` (no "Terraza")

### **Test 3: Wizard de reservas**
1. Iniciar nueva reserva manual
2. Llegar al PASO 5 (Zona)
3. Verificar que muestra zonas con disponibilidad
4. Seleccionar zona
5. Completar reserva
6. Verificar en BD: `preferred_zone` guardado correctamente

### **Test 4: Agente - Reserva con zona**
```
Cliente: "Quiero reservar para 4 el s√°bado en terraza"
Agente: "Perfecto, compruebo disponibilidad en terraza..."
[check_availability con preferred_zone="terraza"]
Agente: "S√≠ tenemos disponibilidad en terraza. ¬øA qu√© hora?"
...
[create_reservation con preferred_zone="terraza"]
```

### **Test 5: Agente - Grupo grande (trigger privado)**
```
Cliente: "Quiero reservar para 10 personas"
Agente: "Para grupos grandes tenemos una sala privada. ¬øTe interesar√≠a?"
Cliente: "S√≠"
[check_availability con preferred_zone="privado"]
```

### **Test 6: Agente - Sin especificar zona**
```
Cliente: "Quiero reservar para 4 el s√°bado"
Agente: "¬øA qu√© hora?"
Cliente: "20:00"
Agente: "¬øTienes preferencia de zona? Tenemos interior, terraza o barra."
Cliente: "Me da igual"
[check_availability con preferred_zone="any"]
```

---

## üìä **IMPACTO Y M√âTRICAS**

### **Impacto en BD:**
- **Tablas afectadas:** 2 (`tables`, `reservations`)
- **Filas afectadas:** ~10-50 mesas, 0 reservas (solo estructura)
- **Downtime:** 0 segundos (operaciones online)
- **Rollback:** < 1 minuto

### **Impacto en Frontend:**
- **Archivos afectados:** 4
  - `src/constants/zones.js` (NUEVO)
  - `src/pages/Mesas.jsx` (1 l√≠nea)
  - `src/hooks/useReservationWizard.js` (2 l√≠neas)
  - `src/components/reservas/ReservationWizard.jsx` (1 l√≠nea)
- **L√≠neas de c√≥digo:** ~50 l√≠neas totales
- **Breaking changes:** ‚ùå Ninguno (compatible con legacy)

### **Impacto en N8N:**
- **Workflows afectados:** 3
  - `Tool - check-availability.json` (15 l√≠neas)
  - `Tool - create-reservation.json` (nuevo o actualizar existente)
  - `3-super-agent-hibrido-FINAL-CORREGIDO.json` (metadata de tools)
- **Breaking changes:** ‚ùå Ninguno (fallback a valores antiguos)

### **Impacto en Prompt:**
- **Archivos afectados:** 1 (`PROMPT-SUPER-AGENT-v3-PERFECTO.txt`)
- **L√≠neas agregadas:** ~60 l√≠neas
- **Versi√≥n:** v3 ‚Üí v4 (registrar en VERSION-HISTORY.md)

---

## ‚úÖ **ORDEN DE IMPLEMENTACI√ìN**

### **D√çA 1: BASE DE DATOS (VIERNES 4 AM)**
1. ‚úÖ Ejecutar migraci√≥n de normalizaci√≥n
2. ‚úÖ Verificar que todos los valores se normalizaron
3. ‚úÖ Crear ENUM `zone_type`
4. ‚úÖ Convertir columna `tables.zone` a ENUM
5. ‚úÖ Agregar columna `reservations.preferred_zone`
6. ‚úÖ Rollback test

### **D√çA 2: FRONTEND**
1. ‚úÖ Crear `src/constants/zones.js`
2. ‚úÖ Actualizar `Mesas.jsx`
3. ‚úÖ Actualizar `useReservationWizard.js`
4. ‚úÖ Actualizar `ReservationWizard.jsx`
5. ‚úÖ Testing manual completo

### **D√çA 3: N8N + PROMPT**
1. ‚úÖ Actualizar `Tool - check-availability.json`
2. ‚úÖ Actualizar/Crear `Tool - create-reservation.json`
3. ‚úÖ Actualizar metadata de tools en `3-super-agent-hibrido-FINAL-CORREGIDO.json`
4. ‚úÖ Actualizar `PROMPT-SUPER-AGENT-v3-PERFECTO.txt` ‚Üí v4
5. ‚úÖ Actualizar `VERSION-HISTORY.md`
6. ‚úÖ Testing completo de conversaciones

---

## üìö **DOCUMENTOS RELACIONADOS**

- ‚úÖ `docs/04-desarrollo/CHECKLIST_OBLIGATORIO.md` (cumplido)
- ‚úÖ `docs/04-desarrollo/NORMAS_SAGRADAS.md` (respetado)
- ‚úÖ `docs/01-arquitectura/DATABASE-SCHEMA-COMPLETO-2025.md` (verificado)
- ‚úÖ `docs/02-sistemas/SISTEMA-DISPONIBILIDADES-COMPLETO.md` (revisado)
- ‚úÖ `n8n/prompts/VERSION-HISTORY.md` (actualizar despu√©s)

---

## üéØ **CONCLUSI√ìN**

**Estado:** AUDITOR√çA COMPLETA ‚úÖ  
**Riesgo:** BAJO (cambios quir√∫rgicos, bien planificados)  
**Complejidad:** MEDIA (requiere coordinaci√≥n BD + Frontend + N8N)  
**Tiempo estimado:** 3 d√≠as (1 d√≠a BD, 1 d√≠a Frontend, 1 d√≠a N8N/Prompt)  
**Aprobaci√≥n para continuar:** ‚è≥ PENDIENTE

---

**Esta auditor√≠a garantiza:**
‚úÖ NORMAS SAGRADAS respetadas  
‚úÖ Multi-tenant asegurado  
‚úÖ Datos reales (no inventados)  
‚úÖ Cambios quir√∫rgicos (no degradan calidad)  
‚úÖ Plan de rollback preparado  
‚úÖ Testing completo definido  

**Pr√≥ximo paso:** Esperar aprobaci√≥n del usuario para iniciar implementaci√≥n.

---

**√öltima actualizaci√≥n:** 17 de Octubre 2025  
**Responsable:** La-IA App Team  
**Estado:** üìã Auditor√≠a completada - Esperando GO para implementar

