# üìä AUDITOR√çA COMPLETA: SISTEMA DE HORARIOS Y DISPONIBILIDADES

**Fecha:** 12 de Octubre 2025  
**Auditor:** AI Assistant  
**Alcance:** Sistema completo de gesti√≥n de horarios, disponibilidades y slots  
**Estado:** ‚úÖ An√°lisis completado - Esperando instrucciones para cambios

---

## üìã √çNDICE

1. [Resumen Ejecutivo](#resumen-ejecutivo)
2. [Arquitectura Actual](#arquitectura-actual)
3. [Flujo de Datos](#flujo-de-datos)
4. [Configuraci√≥n de Horarios](#configuraci√≥n-de-horarios)
5. [Generaci√≥n de Slots](#generaci√≥n-de-slots)
6. [C√°lculos y L√≥gica](#c√°lculos-y-l√≥gica)
7. [Frontend - Componentes](#frontend---componentes)
8. [Issues Detectados](#issues-detectados)
9. [Recomendaciones](#recomendaciones)

---

## üéØ RESUMEN EJECUTIVO

### **Nomenclatura Corregida:**
- ‚úÖ "Gesti√≥n de Disponibilidades" ‚Üí **"Gesti√≥n de Horarios de Reserva"**
- ‚úÖ "Disponibilidades Activas" ‚Üí **"D√≠as Disponibles"**

### **Sistema Actual:**

El sistema gestiona **3 capas** de configuraci√≥n para determinar cu√°ndo un restaurante puede recibir reservas:

1. **Pol√≠tica de Reservas** (`restaurant.settings.booking_settings`)
   - Duraci√≥n de reserva (ej: 90 min)
   - D√≠as de anticipaci√≥n (ej: 30 d√≠as)
   - Tama√±o m√≠nimo/m√°ximo de grupo

2. **Horarios de Operaci√≥n** (`calendar_schedule` en `restaurant.settings`)
   - Horarios semanales por d√≠a (Lunes-Domingo)
   - M√∫ltiples turnos por d√≠a (ej: Comida 13:00-16:00, Cena 20:00-23:00)

3. **D√≠as Especiales** (`calendar_exceptions`)
   - Festivos, cierres, eventos especiales
   - Sobrescribe horarios normales

### **Flujo Simplificado:**

```
Usuario configura horarios
    ‚Üì
Sistema genera "slots" (bloques de tiempo)
    ‚Üì
Slots se guardan en `availability_slots`
    ‚Üì
Frontend muestra estad√≠sticas (d√≠as disponibles, total mesas, slots)
    ‚Üì
Cliente hace reserva ‚Üí Slot cambia de 'free' a 'reserved'
```

---

## üèóÔ∏è ARQUITECTURA ACTUAL

### **Tablas Principales:**

#### 1. `restaurants` (settings JSONB)
```json
{
  "booking_settings": {
    "advance_booking_days": 30,
    "reservation_duration": 90,
    "min_booking_hours": 2,
    "max_party_size": 12
  },
  "calendar_schedule": [
    {
      "day_of_week": "monday",
      "is_open": true,
      "open_time": "18:00",
      "close_time": "22:00"
    }
  ]
}
```

#### 2. `availability_slots`
```sql
CREATE TABLE availability_slots (
    id UUID PRIMARY KEY,
    restaurant_id UUID NOT NULL,
    slot_date DATE NOT NULL,
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    table_id UUID NOT NULL,
    status TEXT DEFAULT 'free', -- 'free', 'reserved', 'occupied'
    duration_minutes INT DEFAULT 90,
    UNIQUE(restaurant_id, table_id, slot_date, start_time)
);
```

#### 3. `tables`
```sql
CREATE TABLE tables (
    id UUID PRIMARY KEY,
    restaurant_id UUID NOT NULL,
    table_number TEXT,
    capacity INT NOT NULL,
    is_active BOOLEAN DEFAULT TRUE
);
```

#### 4. `calendar_exceptions`
```sql
CREATE TABLE calendar_exceptions (
    id UUID PRIMARY KEY,
    restaurant_id UUID NOT NULL,
    exception_date DATE NOT NULL,
    exception_type TEXT, -- 'closed', 'holiday', 'special_event'
    custom_hours JSONB
);
```

---

## üîÑ FLUJO DE DATOS

### **1. Usuario Configura Horarios:**

**Ubicaci√≥n:** `src/pages/Reservas.jsx` ‚Üí Tab "Horarios de Reserva"

**Componente:** `AvailabilityManager.jsx`

**Datos guardados en:**
- `restaurant.settings.calendar_schedule[]`
- `restaurant.settings.booking_settings{}`

### **2. Sistema Genera Slots:**

**Funci√≥n SQL:** `generate_availability_slots_simple()`

**Ubicaci√≥n:** `scripts/sql/generate_availability_slots.sql`

**L√≥gica:**
```sql
FOR cada d√≠a en el rango (hoy + 30 d√≠as)
  FOR cada mesa activa
    FOR cada turno del d√≠a
      FOR cada intervalo de tiempo (cada 90 min)
        INSERT INTO availability_slots (
          slot_date, start_time, end_time, table_id, status='free'
        )
```

**Ejemplo:**
- Restaurante abierto: **18:00 - 22:00** (4 horas)
- Duraci√≥n reserva: **90 minutos**
- Intervalos: **18:00, 19:30, 21:00**
- Mesas: **6**
- **Slots generados por d√≠a:** 6 mesas √ó 3 intervalos = **18 slots**

### **3. Frontend Muestra Estad√≠sticas:**

**Componente:** `AvailabilityManager.jsx` ‚Üí Secci√≥n "D√≠as Disponibles"

**Datos mostrados:**
- **D√≠as Totales:** Cuenta d√≠as √∫nicos en `availability_slots`
- **D√≠as Libres:** D√≠as con al menos 1 slot `status = 'free'`
- **D√≠as Ocupados:** D√≠as con 100% slots `reserved` u `occupied`
- **Reservas Activas:** Count de slots con `status != 'free'`
- **Mesas:** Count de `tables` donde `is_active = true`
- **Duraci√≥n Reserva:** De `booking_settings.reservation_duration`
- **Fecha Hasta:** MAX(`slot_date`) de `availability_slots`

---

## ‚öôÔ∏è CONFIGURACI√ìN DE HORARIOS

### **Pol√≠tica de Reservas:**

**Ubicaci√≥n:** Tab "Pol√≠tica de Reservas" en `Reservas.jsx`

| Campo | Valor Actual | Descripci√≥n |
|-------|--------------|-------------|
| `advance_booking_days` | 30 | D√≠as de anticipaci√≥n m√°xima |
| `reservation_duration` | 90 min | Duraci√≥n est√°ndar de reserva |
| `min_booking_hours` | 2 | Horas m√≠nimas de anticipaci√≥n |
| `max_party_size` | 12 | Tama√±o m√°ximo de grupo (sin aprobaci√≥n) |

### **Horarios de Operaci√≥n:**

**Ubicaci√≥n:** Tab "Horarios de Reserva" ‚Üí Secci√≥n "Pol√≠tica de Reservas Actual"

**Estructura:**
```javascript
calendar_schedule: [
  {
    day_of_week: "monday", // sunday, monday, ..., saturday
    day_name: "Lunes",
    is_open: true,
    open_time: "18:00",
    close_time: "22:00"
  }
]
```

**Tu configuraci√≥n actual:**
- **D√≠as abiertos:** Todos (Lunes-Domingo)
- **Horario:** **18:00 - 22:00** (4 horas)
- **No hay turnos m√∫ltiples** (solo 1 turno por d√≠a)

---

## üî¢ GENERACI√ìN DE SLOTS

### **Funci√≥n: `generate_availability_slots_simple()`**

**Par√°metros:**
```sql
generate_availability_slots_simple(
    p_restaurant_id UUID,
    p_start_date DATE,
    p_end_date DATE
)
```

**L√≥gica Paso a Paso:**

1. **Leer configuraci√≥n:**
   ```sql
   v_reservation_duration := settings->>'reservation_duration'
   v_slot_interval := settings->>'slot_interval' (default: 90)
   v_advance_booking_days := settings->>'advance_booking_days'
   ```

2. **Por cada d√≠a en el rango:**
   - Verificar si d√≠a est√° en `calendar_exceptions` como 'closed' ‚Üí Skip
   - Obtener horarios del d√≠a desde `calendar_schedule`
   - Si `is_open = false` ‚Üí Skip

3. **Por cada mesa activa:**
   ```sql
   SELECT id FROM tables 
   WHERE restaurant_id = p_restaurant_id 
   AND is_active = true
   ```

4. **Por cada intervalo de tiempo:**
   ```sql
   v_current_time := open_time
   WHILE v_current_time <= close_time LOOP
     INSERT INTO availability_slots (
       restaurant_id, slot_date, start_time, end_time, 
       table_id, status='free', duration_minutes
     )
     v_current_time := v_current_time + v_slot_interval
   END LOOP
   ```

5. **Protecci√≥n de slots reservados:**
   ```sql
   ON CONFLICT (restaurant_id, table_id, slot_date, start_time) 
   DO NOTHING
   ```

---

## üìä C√ÅLCULOS Y L√ìGICA

### **1. C√°lculo de D√≠as Disponibles:**

**Frontend:** `AvailabilityManager.jsx` ‚Üí `loadAvailabilityStats()`

```javascript
const { data: stats } = await supabase
  .from('availability_slots')
  .select('slot_date, status')
  .eq('restaurant_id', restaurantId)
  .order('slot_date');

const uniqueDays = [...new Set(stats.map(s => s.slot_date))];
const daysWithFreeSlots = uniqueDays.filter(day => 
  stats.some(s => s.slot_date === day && s.status === 'free')
);

setDayStats({
  diasTotales: uniqueDays.length,
  diasLibres: daysWithFreeSlots.length,
  diasOcupados: uniqueDays.length - daysWithFreeSlots.length
});
```

### **2. C√°lculo de Ocupaci√≥n (Dashboard):**

**Componente:** `src/pages/DashboardAgente.jsx`

**Antes (‚ùå Incorrecto):**
```javascript
occupancyPercent = (totalPeople / totalCapacity) √ó 100
// Ejemplo: (12 personas / 22 capacidad) = 55% ‚ùå
```

**Ahora (‚úÖ Correcto):**
```javascript
numTables = 6
turnosDisponibles = Math.floor((4h √ó 60) / 90min) = 2
slotsDisponibles = 6 mesas √ó 2 turnos = 12 slots
numReservasHoy = 3

occupancyPercent = (3 / 12) √ó 100 = 25% ‚úÖ
```

---

## üíª FRONTEND - COMPONENTES

### **1. `AvailabilityManager.jsx`**

**Secciones principales:**

#### **A) D√≠as Disponibles (Estad√≠sticas):**
- **D√≠as Totales:** Count de d√≠as √∫nicos en `availability_slots`
- **D√≠as Libres:** D√≠as con al menos 1 slot libre
- **D√≠as Ocupados:** D√≠as sin slots libres
- **Reservas:** Count de slots `reserved`/`occupied`

#### **B) Pol√≠tica de Reservas Actual:**
- **D√≠as de Antelaci√≥n:** 30 d√≠as
- **Duraci√≥n Reserva:** 90 min/reserva
- **Fecha Hasta:** Hasta 08/11/2025

#### **C) Acciones:**
- **üóëÔ∏è Borrar Disponibilidades:** Elimina slots LIBRES en el rango
- **üîÑ Generar Horarios de Reserva:** Genera nuevos slots
- **üëÅÔ∏è Ver Disponibilidad por D√≠a:** Consulta espec√≠fica de un d√≠a

### **2. Tab "Horarios de Reserva" en `Reservas.jsx`:**

**Renderiza:** `<AvailabilityManager />`

---

## ‚ö†Ô∏è ISSUES DETECTADOS

### **1. ‚ùå Nomenclatura confusa (RESUELTO)**
- ‚úÖ Cambiado "Gesti√≥n de Disponibilidades" ‚Üí "Gesti√≥n de Horarios de Reserva"
- ‚úÖ Cambiado "Disponibilidades Activas" ‚Üí "D√≠as Disponibles"

### **2. ‚ö†Ô∏è C√°lculo de ocupaci√≥n (RESUELTO)**
- ‚úÖ Ahora calcula por slots en vez de por personas

### **3. ‚ö†Ô∏è Sin turnos m√∫ltiples**
- Actualmente solo se configura 1 horario por d√≠a (ej: 18:00-22:00)
- No hay opci√≥n para **Comida** (13:00-16:00) + **Cena** (20:00-23:00)

### **4. ‚ö†Ô∏è Intervalo de slots = Duraci√≥n de reserva**
- `slot_interval` y `reservation_duration` son ambos 90 min
- Esto significa: Slot cada 90 min, reserva dura 90 min
- **Problema:** No hay solapamiento, dificulta optimizar ocupaci√≥n

### **5. ‚ö†Ô∏è D√≠as Ocupados vs. D√≠as Libres**
- "D√≠as Ocupados" se calcula como: `diasTotales - diasLibres`
- **Problema:** Un d√≠a con 1 reserva y 17 slots libres cuenta como "Libre"
- **Mejor:** Mostrar porcentaje de ocupaci√≥n por d√≠a

---

## üí° RECOMENDACIONES

### **1. Implementar Turnos M√∫ltiples:**
Permitir configurar m√∫ltiples turnos por d√≠a:
```json
{
  "day_of_week": "monday",
  "shifts": [
    { "name": "Comida", "start": "13:00", "end": "16:00" },
    { "name": "Cena", "start": "20:00", "end": "23:00" }
  ]
}
```

### **2. Separar `slot_interval` de `reservation_duration`:**
- `slot_interval`: Cada cu√°nto se puede reservar (ej: 30 min)
- `reservation_duration`: Cu√°nto dura la reserva (ej: 90 min)

**Ejemplo:**
- Slots cada 30 min: 18:00, 18:30, 19:00, 19:30...
- Reserva dura 90 min: Bloquea 3 slots

### **3. Mejorar estad√≠sticas de "D√≠as Disponibles":**
```javascript
// Agregar:
- Porcentaje de ocupaci√≥n promedio
- D√≠as completamente libres
- D√≠as parcialmente ocupados (con %)
- D√≠as completamente ocupados
```

### **4. Visualizaci√≥n de calendario mensual:**
Agregar un calendario visual que muestre:
- üü¢ D√≠as con > 70% disponibilidad
- üü° D√≠as con 30-70% disponibilidad
- üî¥ D√≠as con < 30% disponibilidad
- ‚ö´ D√≠as cerrados

---

## üéØ CONCLUSI√ìN

El sistema actual es **funcional y robusto**, pero tiene margen de mejora en:

1. ‚úÖ **Nomenclatura** (CORREGIDO)
2. ‚úÖ **C√°lculo de ocupaci√≥n** (CORREGIDO)
3. ‚ö†Ô∏è **Turnos m√∫ltiples** (pendiente)
4. ‚ö†Ô∏è **Intervalo vs. Duraci√≥n** (pendiente)
5. ‚ö†Ô∏è **Visualizaci√≥n mejorada** (pendiente)

---

## üìù PR√ìXIMOS PASOS

**Esperando instrucciones del usuario sobre:**

1. ¬øQu√© cambio espec√≠fico necesitas hacer?
2. ¬øQuieres implementar turnos m√∫ltiples?
3. ¬øNecesitas separar `slot_interval` de `reservation_duration`?
4. ¬øHay alg√∫n problema espec√≠fico con la generaci√≥n de slots?
5. ¬øQuieres mejorar la visualizaci√≥n de disponibilidades?

**Por favor, ind√≠came qu√© cambio hay que hacer y proceder√© con la implementaci√≥n.** üöÄ

---

**Auditor√≠a realizada:** 12/10/2025  
**Archivos analizados:** 15+ (SQL, JSX, servicios, documentaci√≥n)  
**Estado:** ‚úÖ Completo - Listo para cambios


