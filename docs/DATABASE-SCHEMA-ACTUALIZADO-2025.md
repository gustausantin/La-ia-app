# üóÑÔ∏è **ESQUEMA DE BASE DE DATOS COMPLETO - LA-IA APP 2025**

> **Documentaci√≥n exhaustiva de todas las tablas, columnas, relaciones y funciones RPC**

**üìÖ Fecha:** 17 Septiembre 2025  
**üéØ Estado:** ESQUEMA COMPLETO + SISTEMA TURNOS + FILTROS INTELIGENTES  
**‚úÖ Versi√≥n:** Master Database Schema v2.2  
**üë®‚Äçüíª Documentado por:** Claude Sonnet 4  
**üöÄ √öltima actualizaci√≥n:** Sistema de Turnos Inteligente + Migraci√≥n Completa desde Cero

---

## üéØ **PROP√ìSITO DE ESTE DOCUMENTO**

Este documento contiene **TODA LA ESTRUCTURA** de la base de datos de LA-IA App:
- ‚úÖ **Todas las tablas** con columnas detalladas
- ‚úÖ **Relaciones y constraints** completos
- ‚úÖ **Funciones RPC** implementadas
- ‚úÖ **Pol√≠ticas RLS** de seguridad
- ‚úÖ **√çndices** para performance
- ‚úÖ **Triggers** autom√°ticos

---

# üìä **RESUMEN DE TABLAS**

## üè¢ **GESTI√ìN DE RESTAURANTES (4 tablas)**
- `restaurants` - Informaci√≥n principal de restaurantes
- `user_restaurant_mapping` - Mapping usuarios-restaurantes
- `profiles` - Perfiles de usuarios
- `tables` - Mesas del restaurante

## üë• **GESTI√ìN DE CLIENTES (1 tabla)**
- `customers` - Clientes con CRM inteligente

## üìÖ **SISTEMA DE RESERVAS (3 tablas)**
- `reservations` - Reservas principales
- `availability_slots` ‚≠ê **NUEVO** - Slots de disponibilidad
- `special_events` ‚≠ê **NUEVO** - Eventos especiales

## ü§ñ **SISTEMA CRM (4 tablas)**
- `message_templates` - Plantillas de mensajes
- `automation_rules` - Reglas de automatizaci√≥n
- `crm_interactions` - Historial de interacciones
- `automation_rule_executions` - Ejecuciones de reglas

## üì± **SISTEMA DE COMUNICACIONES (3 tablas)**
- `conversations` - Conversaciones por canal
- `messages` - Mensajes individuales
- `communication_channels` - Configuraci√≥n de canales

## üí∞ **SISTEMA DE FACTURACI√ìN (1 tabla)**
- `billing_tickets` - Tickets de facturaci√≥n

---

# üè¢ **TABLAS DE GESTI√ìN DE RESTAURANTES**

## **`restaurants`** - Tabla principal
```sql
CREATE TABLE restaurants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- üìù INFORMACI√ìN B√ÅSICA
    name VARCHAR NOT NULL,
    email VARCHAR,
    phone VARCHAR,
    address TEXT,
    city VARCHAR,
    country VARCHAR DEFAULT 'Espa√±a',
    postal_code VARCHAR,
    cuisine_type VARCHAR,
    
    -- üîß CONFIGURACI√ìN
    plan VARCHAR DEFAULT 'trial',
    active BOOLEAN DEFAULT true,
    owner_id UUID REFERENCES auth.users(id),
    
    -- ‚öôÔ∏è CONFIGURACIONES AVANZADAS ‚≠ê NUEVO
    settings JSONB DEFAULT '{}', -- Configuraci√≥n unificada
    crm_config JSONB DEFAULT '{}', -- Configuraci√≥n CRM espec√≠fica
    
    -- üìÖ AUDITOR√çA
    created_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    updated_at TIMESTAMPTZ DEFAULT timezone('utc', now())
);
```

### **üìã Estructura del campo `settings` JSONB:**
```json
{
  "operating_hours": {
    "monday": {"open": "09:00", "close": "22:00", "closed": false},
    "tuesday": {"open": "09:00", "close": "22:00", "closed": false},
    "wednesday": {"open": "09:00", "close": "22:00", "closed": false},
    "thursday": {"open": "09:00", "close": "22:00", "closed": false},
    "friday": {"open": "09:00", "close": "23:00", "closed": false},
    "saturday": {"open": "09:00", "close": "23:00", "closed": false},
    "sunday": {"open": "10:00", "close": "22:00", "closed": false}
  },
  "min_party_size": 1,
  "max_party_size": 20,
  "horizon_days": 30,
  "turn_duration_minutes": 90,
  "buffer_minutes": 15,
  "min_advance_hours": 2,
  "channels": {
    "whatsapp": {"enabled": false, "phone": "", "api_key": ""},
    "vapi": {"enabled": false, "assistant_id": "", "api_key": ""},
    "email": {"enabled": false, "from_email": "", "api_key": ""},
    "facebook": {"enabled": false, "page_id": "", "access_token": ""},
    "instagram": {"enabled": false, "account_id": "", "access_token": ""},
    "web_chat": {"enabled": true}
  }
}
```

### **üìã Estructura del campo `crm_config` JSONB:**
```json
{
  "factor_activo": 0.8,
  "factor_riesgo": 1.5,
  "dias_inactivo_min": 90,
  "vip_threshold": 500.00,
  "weekly_contact_cap": 3,
  "segmentation_rules": {
    "nuevo": {"max_visits": 1, "max_days": 30},
    "activo": {"min_visits": 2, "max_recency_factor": 0.8},
    "vip": {"min_spent": 500, "min_visits": 5},
    "inactivo": {"min_days": 90},
    "riesgo": {"recency_factor": 1.5, "declining_pattern": true}
  }
}
```

## **`user_restaurant_mapping`** - Relaci√≥n usuarios-restaurantes
```sql
CREATE TABLE user_restaurant_mapping (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    auth_user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    restaurant_id UUID NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    
    -- üéØ ROLES Y PERMISOS
    role VARCHAR NOT NULL DEFAULT 'staff', -- 'owner' | 'manager' | 'staff' | 'viewer'
    permissions JSONB DEFAULT '{}',
    active BOOLEAN DEFAULT true,
    
    -- üìÖ AUDITOR√çA
    created_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    updated_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    
    UNIQUE(auth_user_id, restaurant_id)
);
```

### **üìã Estructura del campo `permissions` JSONB:**
```json
{
  "all_access": true,
  "manage_staff": true,
  "manage_settings": true,
  "manage_reservations": true,
  "manage_customers": true,
  "manage_tables": true,
  "view_analytics": true,
  "manage_crm": true,
  "manage_billing": false
}
```

## **`profiles`** - Perfiles de usuarios
```sql
CREATE TABLE profiles (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    auth_user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
    
    -- üë§ INFORMACI√ìN PERSONAL
    email VARCHAR,
    full_name VARCHAR,
    restaurant_name VARCHAR,
    role VARCHAR DEFAULT 'staff',
    
    -- üìÖ AUDITOR√çA
    created_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    updated_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    
    UNIQUE(auth_user_id)
);
```

## **`tables`** - Mesas del restaurante
```sql
CREATE TABLE tables (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    restaurant_id UUID NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    
    -- ü™ë INFORMACI√ìN DE MESA
    table_number VARCHAR NOT NULL,
    name VARCHAR NOT NULL,
    zone VARCHAR,
    capacity INTEGER NOT NULL,
    
    -- üìä ESTADO Y CONFIGURACI√ìN
    status VARCHAR DEFAULT 'available', -- 'available' | 'occupied' | 'maintenance' | 'reserved'
    is_active BOOLEAN DEFAULT true,
    notes TEXT,
    
    -- üìÖ AUDITOR√çA
    created_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    updated_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    
    UNIQUE(restaurant_id, table_number)
);
```

---

# üë• **TABLA DE GESTI√ìN DE CLIENTES**

## **`customers`** - Clientes con CRM inteligente
```sql
CREATE TABLE customers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    restaurant_id UUID NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    
    -- üë§ INFORMACI√ìN B√ÅSICA
    name VARCHAR NOT NULL,
    email VARCHAR,
    phone VARCHAR,
    first_name VARCHAR,
    last_name1 VARCHAR,
    last_name2 VARCHAR,
    
    -- üéØ SEGMENTACI√ìN CRM ‚≠ê CR√çTICO
    segment_manual VARCHAR CHECK (segment_manual IN ('nuevo', 'activo', 'vip', 'inactivo', 'riesgo')),
    segment_auto VARCHAR CHECK (segment_auto IN ('nuevo', 'activo', 'vip', 'inactivo', 'riesgo')) DEFAULT 'nuevo',
    
    -- üìä M√âTRICAS AUTOM√ÅTICAS
    visits_count INTEGER DEFAULT 0,
    total_spent NUMERIC DEFAULT 0.00,
    avg_ticket NUMERIC DEFAULT 0.00,
    last_visit_at TIMESTAMPTZ,
    recency_days INTEGER DEFAULT 0, -- D√≠as desde √∫ltima visita
    aivi_days INTEGER DEFAULT 0, -- D√≠as desde primera visita (Age In Value Index)
    
    -- ü§ñ IA PREDICTIVA
    churn_risk_score INTEGER DEFAULT 0 CHECK (churn_risk_score >= 0 AND churn_risk_score <= 100),
    predicted_ltv NUMERIC DEFAULT 0.00,
    
    -- üì± PREFERENCIAS DE CONTACTO
    preferred_items JSONB DEFAULT '[]',
    
    -- üîí GDPR COMPLIANCE
    consent_email BOOLEAN DEFAULT true,
    consent_sms BOOLEAN DEFAULT true,
    consent_whatsapp BOOLEAN DEFAULT false,
    
    -- ü§ñ CRM AUTOMATION
    last_contacted_at TIMESTAMPTZ,
    next_action_at TIMESTAMPTZ,
    
    -- üìÖ AUDITOR√çA
    created_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    updated_at TIMESTAMPTZ DEFAULT timezone('utc', now())
);
```

### **üéØ L√≥gica de Segmentaci√≥n Autom√°tica:**
- **`nuevo`**: visits_count <= 1 AND aivi_days <= 30
- **`activo`**: recency_days <= (avg_recency * factor_activo)
- **`vip`**: total_spent >= vip_threshold AND visits_count >= 5
- **`inactivo`**: recency_days >= dias_inactivo_min
- **`riesgo`**: recency_days >= (avg_recency * factor_riesgo) AND visits_count > 1

---

# üìÖ **SISTEMA DE RESERVAS**

## **`reservations`** - Reservas principales
```sql
CREATE TABLE reservations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    restaurant_id UUID NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    customer_id UUID REFERENCES customers(id),
    table_id UUID REFERENCES tables(id),
    
    -- üë§ INFORMACI√ìN DEL CLIENTE (duplicada para performance)
    customer_name VARCHAR NOT NULL,
    customer_email VARCHAR,
    customer_phone VARCHAR,
    table_number VARCHAR,
    
    -- üìÖ DATOS DE RESERVA
    reservation_date DATE NOT NULL,
    reservation_time TIME NOT NULL,
    party_size INTEGER NOT NULL,
    
    -- üìä ESTADO
    status VARCHAR DEFAULT 'confirmada' CHECK (status IN ('pendiente', 'confirmada', 'sentada', 'completada', 'cancelada', 'noshow')),
    
    -- ü§ñ ORIGEN Y CANAL
    source VARCHAR DEFAULT 'manual' CHECK (source IN ('ia', 'manual')),
    channel VARCHAR DEFAULT 'web',
    reservation_source VARCHAR DEFAULT 'manual' CHECK (reservation_source IN ('ia', 'manual')),
    reservation_channel VARCHAR DEFAULT 'web',
    
    -- üí∞ FACTURACI√ìN
    spend_amount NUMERIC DEFAULT 0.00,
    
    -- üìù INFORMACI√ìN ADICIONAL
    special_requests TEXT,
    notes TEXT,
    
    -- üìÖ AUDITOR√çA
    created_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    updated_at TIMESTAMPTZ DEFAULT timezone('utc', now())
);
```

## **`availability_slots`** ‚≠ê **NUEVO** - Sistema de disponibilidades
```sql
CREATE TABLE availability_slots (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    restaurant_id UUID NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    table_id UUID NOT NULL REFERENCES tables(id) ON DELETE CASCADE,
    
    -- ‚è∞ SLOT DE TIEMPO
    slot_date DATE NOT NULL,
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    
    -- üìä ESTADO Y METADATOS
    status VARCHAR DEFAULT 'free' CHECK (status IN ('free', 'reserved', 'occupied')),
    source VARCHAR DEFAULT 'system' CHECK (source IN ('system', 'manual')),
    metadata JSONB DEFAULT '{}',
    
    -- üìÖ AUDITOR√çA
    created_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    updated_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    
    -- üîí CONSTRAINT √öNICO CR√çTICO
    UNIQUE(restaurant_id, table_id, slot_date, start_time)
);
```

### **üìã Estados de `availability_slots`:**
- **`free`**: üü¢ Disponible para reservar
- **`reserved`**: üîµ Reservado (contiene reservation_id en metadata)
- **`occupied`**: üî¥ Ocupado por evento especial o cierre

### **üìã Estructura del campo `metadata` JSONB:**
```json
{
  "reservation_id": "uuid-de-reserva",
  "customer_name": "Nombre Cliente",
  "party_size": 4,
  "created_by": "system|manual",
  "special_event_id": "uuid-del-evento",
  "notes": "Informaci√≥n adicional"
}
```

## **`special_events`** ‚≠ê **NUEVO** - Eventos especiales
```sql
CREATE TABLE special_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    restaurant_id UUID NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    
    -- üìÖ INFORMACI√ìN DEL EVENTO
    name VARCHAR NOT NULL,
    description TEXT,
    event_type VARCHAR NOT NULL CHECK (event_type IN ('closure', 'holiday', 'private_event', 'maintenance')),
    
    -- üìÖ FECHAS
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    
    -- ‚öôÔ∏è CONFIGURACI√ìN DE AFECTACI√ìN
    affects_all_tables BOOLEAN DEFAULT true,
    affected_table_ids UUID[], -- Array de table_ids si affects_all_tables = false
    
    -- üìä ESTADO
    is_active BOOLEAN DEFAULT true,
    
    -- üìÖ AUDITOR√çA
    created_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    updated_at TIMESTAMPTZ DEFAULT timezone('utc', now())
);
```

### **üìã Tipos de eventos especiales:**
- **`closure`**: üö™ Cierre temporal del restaurante
- **`holiday`**: üéâ D√≠a festivo o vacaciones
- **`private_event`**: üé™ Evento privado que ocupa mesas espec√≠ficas
- **`maintenance`**: üîß Mantenimiento de mesas/zona

---

# ü§ñ **SISTEMA CRM INTELIGENTE**

## **`message_templates`** - Plantillas de mensajes
```sql
CREATE TABLE message_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    restaurant_id UUID NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    
    -- üìù PLANTILLA
    name VARCHAR NOT NULL,
    description TEXT,
    subject VARCHAR, -- Para emails
    content TEXT NOT NULL,
    
    -- üéØ CONFIGURACI√ìN
    template_type VARCHAR NOT NULL CHECK (template_type IN ('email', 'sms', 'whatsapp')),
    target_segment VARCHAR CHECK (target_segment IN ('nuevo', 'activo', 'vip', 'inactivo', 'riesgo', 'all')),
    
    -- üîß VARIABLES DIN√ÅMICAS
    variables JSONB DEFAULT '[]', -- Array de variables como {restaurant_name}, {first_name}, etc.
    
    -- üìä ESTADO Y M√âTRICAS
    is_active BOOLEAN DEFAULT true,
    usage_count INTEGER DEFAULT 0,
    success_rate NUMERIC DEFAULT 0.00,
    
    -- üìÖ AUDITOR√çA
    created_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    updated_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    
    UNIQUE(restaurant_id, name, template_type)
);
```

### **üìã Variables disponibles para plantillas:**
```json
[
  "{restaurant_name}",
  "{first_name}",
  "{customer_name}",
  "{last_visit_date}",
  "{total_spent}",
  "{visits_count}",
  "{avg_ticket}",
  "{segment}",
  "{phone}",
  "{email}"
]
```

## **`automation_rules`** - Reglas de automatizaci√≥n
```sql
CREATE TABLE automation_rules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    restaurant_id UUID NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    
    -- üéØ IDENTIFICACI√ìN
    name TEXT NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT true,
    
    -- üîÑ CONFIGURACI√ìN DE TRIGGER
    trigger_event TEXT NOT NULL CHECK (trigger_event IN ('reservation_completed', 'segment_changed', 'daily_check', 'birthday', 'manual')),
    trigger_conditions JSONB DEFAULT '{}',
    
    -- üéØ TARGET Y ACCI√ìN
    target_segment TEXT CHECK (target_segment IN ('nuevo', 'activo', 'vip', 'inactivo', 'riesgo', 'all')),
    template_id UUID REFERENCES message_templates(id) ON DELETE SET NULL,
    
    -- ‚è∞ L√çMITES Y COOLDOWN
    cooldown_days INTEGER DEFAULT 30,
    max_executions_per_customer INTEGER DEFAULT 5,
    max_daily_executions INTEGER DEFAULT 50,
    
    -- üïê VENTANAS DE EJECUCI√ìN
    execution_hours_start TIME DEFAULT '09:00',
    execution_hours_end TIME DEFAULT '21:00',
    execution_days_of_week INTEGER[] DEFAULT ARRAY[1,2,3,4,5,6,7], -- 1=Lunes, 7=Domingo
    
    -- üîß CONFIGURACI√ìN DE ACCI√ìN
    action_config JSONB DEFAULT '{}',
    
    -- üìä M√âTRICAS
    execution_count INTEGER DEFAULT 0,
    successful_executions INTEGER DEFAULT 0,
    last_executed_at TIMESTAMPTZ,
    
    -- üìÖ AUDITOR√çA
    created_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    updated_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    
    UNIQUE(restaurant_id, name)
);
```

## **`crm_interactions`** - Historial de interacciones
```sql
CREATE TABLE crm_interactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    restaurant_id UUID NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
    
    -- üéØ TIPO DE INTERACCI√ìN
    interaction_type VARCHAR NOT NULL CHECK (interaction_type IN ('email_sent', 'sms_sent', 'whatsapp_sent', 'call_made', 'reservation_created', 'visit_completed', 'segment_changed')),
    
    -- üìù DETALLES
    subject VARCHAR,
    content TEXT,
    channel VARCHAR,
    
    -- ü§ñ AUTOMATIZACI√ìN
    automation_rule_id UUID REFERENCES automation_rules(id),
    template_id UUID REFERENCES message_templates(id),
    
    -- üìä RESULTADO
    status VARCHAR DEFAULT 'sent' CHECK (status IN ('sent', 'delivered', 'read', 'clicked', 'replied', 'failed')),
    response_data JSONB DEFAULT '{}',
    
    -- üìÖ AUDITOR√çA
    created_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    updated_at TIMESTAMPTZ DEFAULT timezone('utc', now())
);
```

## **`automation_rule_executions`** - Log de ejecuciones
```sql
CREATE TABLE automation_rule_executions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    automation_rule_id UUID NOT NULL REFERENCES automation_rules(id) ON DELETE CASCADE,
    customer_id UUID NOT NULL REFERENCES customers(id) ON DELETE CASCADE,
    
    -- üìä RESULTADO DE EJECUCI√ìN
    status VARCHAR NOT NULL CHECK (status IN ('success', 'failed', 'skipped')),
    result_data JSONB DEFAULT '{}',
    error_message TEXT,
    
    -- üéØ CONTEXTO
    trigger_event VARCHAR,
    execution_context JSONB DEFAULT '{}',
    
    -- ‚è∞ TIMING
    scheduled_at TIMESTAMPTZ,
    executed_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    
    -- üìÖ AUDITOR√çA
    created_at TIMESTAMPTZ DEFAULT timezone('utc', now())
);
```

---

# üì± **SISTEMA DE COMUNICACIONES**

## **`conversations`** - Conversaciones por canal
```sql
CREATE TABLE conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    restaurant_id UUID NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    customer_id UUID REFERENCES customers(id),
    
    -- üì± CANAL DE COMUNICACI√ìN
    channel VARCHAR NOT NULL CHECK (channel IN ('whatsapp', 'sms', 'email', 'phone', 'web', 'facebook', 'instagram')),
    external_id VARCHAR, -- ID del sistema externo (WhatsApp, etc.)
    
    -- üìä ESTADO DE CONVERSACI√ìN
    status VARCHAR DEFAULT 'active' CHECK (status IN ('active', 'closed', 'archived', 'spam')),
    priority VARCHAR DEFAULT 'normal' CHECK (priority IN ('low', 'normal', 'high', 'urgent')),
    
    -- üë§ PARTICIPANTES
    participant_name VARCHAR,
    participant_phone VARCHAR,
    participant_email VARCHAR,
    
    -- üè∑Ô∏è CLASIFICACI√ìN
    topic VARCHAR, -- 'reservation', 'complaint', 'info', 'general'
    tags JSONB DEFAULT '[]',
    
    -- üìä M√âTRICAS
    message_count INTEGER DEFAULT 0,
    last_message_at TIMESTAMPTZ,
    response_time_avg INTEGER DEFAULT 0, -- En minutos
    
    -- üìù METADATOS
    metadata JSONB DEFAULT '{}',
    
    -- üìÖ AUDITOR√çA
    created_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    updated_at TIMESTAMPTZ DEFAULT timezone('utc', now())
);
```

## **`messages`** - Mensajes individuales
```sql
CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
    
    -- üìù CONTENIDO DEL MENSAJE
    content TEXT NOT NULL,
    message_type VARCHAR DEFAULT 'text' CHECK (message_type IN ('text', 'image', 'audio', 'video', 'file', 'location', 'contact')),
    
    -- üîÑ DIRECCI√ìN
    direction VARCHAR NOT NULL CHECK (direction IN ('inbound', 'outbound')),
    
    -- üë§ REMITENTE
    sender_type VARCHAR NOT NULL CHECK (sender_type IN ('customer', 'staff', 'agent', 'system')),
    sender_id UUID, -- ID del staff member o system
    sender_name VARCHAR,
    
    -- üìé ARCHIVOS ADJUNTOS
    attachments JSONB DEFAULT '[]',
    
    -- üìä ESTADO DE ENTREGA
    status VARCHAR DEFAULT 'sent' CHECK (status IN ('sent', 'delivered', 'read', 'failed')),
    delivered_at TIMESTAMPTZ,
    read_at TIMESTAMPTZ,
    
    -- ü§ñ IA Y AUTOMATIZACI√ìN
    is_automated BOOLEAN DEFAULT false,
    automation_rule_id UUID REFERENCES automation_rules(id),
    
    -- üìù METADATOS
    metadata JSONB DEFAULT '{}',
    external_id VARCHAR, -- ID del sistema externo
    
    -- üìÖ AUDITOR√çA
    created_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    updated_at TIMESTAMPTZ DEFAULT timezone('utc', now())
);
```

## **`communication_channels`** - Configuraci√≥n de canales
```sql
CREATE TABLE communication_channels (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    restaurant_id UUID NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    
    -- üì± CANAL
    channel_type VARCHAR NOT NULL CHECK (channel_type IN ('whatsapp', 'sms', 'email', 'vapi', 'facebook', 'instagram', 'web_chat')),
    channel_name VARCHAR NOT NULL,
    
    -- ‚öôÔ∏è CONFIGURACI√ìN
    is_active BOOLEAN DEFAULT false,
    configuration JSONB DEFAULT '{}',
    credentials JSONB DEFAULT '{}',
    
    -- üìä M√âTRICAS
    message_count INTEGER DEFAULT 0,
    success_rate NUMERIC DEFAULT 0.00,
    last_used_at TIMESTAMPTZ,
    
    -- üîß VALIDACI√ìN
    is_validated BOOLEAN DEFAULT false,
    validation_status VARCHAR DEFAULT 'pending',
    validation_error TEXT,
    validated_at TIMESTAMPTZ,
    
    -- üìÖ AUDITOR√çA
    created_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    updated_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    
    UNIQUE(restaurant_id, channel_type)
);
```

### **üìã Estructura del campo `configuration` JSONB por canal:**

#### **WhatsApp:**
```json
{
  "phone_number": "+34123456789",
  "business_account_id": "123456789",
  "webhook_url": "https://app.com/webhook/whatsapp",
  "auto_reply": true,
  "business_hours_only": false
}
```

#### **Email:**
```json
{
  "from_email": "reservas@restaurante.com",
  "from_name": "Restaurante XYZ",
  "smtp_host": "smtp.sendgrid.net",
  "smtp_port": 587,
  "use_templates": true
}
```

#### **VAPI (Voice AI):**
```json
{
  "assistant_id": "assistant_123",
  "voice_model": "eleven_labs",
  "language": "es",
  "phone_number": "+34987654321",
  "greeting_message": "Hola, soy el asistente de Restaurante XYZ"
}
```

---

# üí∞ **SISTEMA DE FACTURACI√ìN**

## **`billing_tickets`** - Tickets de facturaci√≥n
```sql
CREATE TABLE billing_tickets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    restaurant_id UUID NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    reservation_id UUID REFERENCES reservations(id),
    customer_id UUID REFERENCES customers(id),
    
    -- üßæ INFORMACI√ìN DEL TICKET
    ticket_number VARCHAR NOT NULL,
    ticket_date DATE NOT NULL,
    ticket_time TIME NOT NULL,
    
    -- üí∞ IMPORTES
    subtotal NUMERIC NOT NULL DEFAULT 0.00,
    tax_amount NUMERIC NOT NULL DEFAULT 0.00,
    discount_amount NUMERIC DEFAULT 0.00,
    tip_amount NUMERIC DEFAULT 0.00,
    total_amount NUMERIC NOT NULL DEFAULT 0.00,
    
    -- üìä DETALLES
    items JSONB DEFAULT '[]', -- Array de items del ticket
    table_number VARCHAR,
    covers INTEGER DEFAULT 1, -- N√∫mero de comensales
    
    -- üí≥ M√âTODO DE PAGO
    payment_method VARCHAR CHECK (payment_method IN ('cash', 'card', 'transfer', 'mixed')),
    payment_status VARCHAR DEFAULT 'completed' CHECK (payment_status IN ('pending', 'completed', 'failed', 'refunded')),
    
    -- üìù METADATOS
    notes TEXT,
    metadata JSONB DEFAULT '{}',
    
    -- üìÖ AUDITOR√çA
    created_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    updated_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    
    UNIQUE(restaurant_id, ticket_number)
);
```

### **üìã Estructura del campo `items` JSONB:**
```json
[
  {
    "name": "Paella Valenciana",
    "quantity": 2,
    "unit_price": 18.50,
    "total_price": 37.00,
    "category": "Plato Principal",
    "notes": "Sin mariscos"
  },
  {
    "name": "Sangr√≠a Tinto",
    "quantity": 1,
    "unit_price": 12.00,
    "total_price": 12.00,
    "category": "Bebidas",
    "notes": ""
  }
]
```

---

# üîÑ **FUNCIONES RPC (STORED PROCEDURES)**

## üóìÔ∏è **Sistema de Disponibilidades**

### **`generate_availability_slots`** ‚≠ê **CR√çTICA**
```sql
CREATE OR REPLACE FUNCTION generate_availability_slots(
    p_restaurant_id UUID,
    p_start_date DATE DEFAULT CURRENT_DATE,
    p_end_date DATE DEFAULT NULL
) RETURNS INTEGER
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
    slot_count INTEGER := 0;
    -- ... variables adicionales
BEGIN
    -- 1. Obtener configuraci√≥n del restaurante
    -- 2. Calcular rango de fechas
    -- 3. Limpiar slots existentes del sistema
    -- 4. Generar slots d√≠a por d√≠a
    -- 5. Para cada d√≠a abierto sin eventos especiales
    -- 6. Para cada mesa activa
    -- 7. Crear slots cada (duraci√≥n + buffer) minutos
    -- 8. Evitar conflictos con reservas existentes
    
    RETURN slot_count;
END;
$$;
```

### **`check_availability`**
```sql
CREATE OR REPLACE FUNCTION check_availability(
    p_restaurant_id UUID,
    p_date DATE,
    p_time TIME,
    p_party_size INTEGER,
    p_table_id UUID DEFAULT NULL
) RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    -- Verificar disponibilidad espec√≠fica con validaciones completas
    -- Retorna: { "available": true/false, "slots": [...], "reason": "..." }
END;
$$;
```

### **`book_table`**
```sql
CREATE OR REPLACE FUNCTION book_table(
    p_restaurant_id UUID,
    p_slot_id UUID,
    p_reservation_data JSONB
) RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    -- Reservar slot de manera transaccional
    -- Crear reserva y marcar slot como 'reserved'
    -- Retorna: { "success": true/false, "reservation_id": "...", "message": "..." }
END;
$$;
```

### **`release_reservation_slot`**
```sql
CREATE OR REPLACE FUNCTION release_reservation_slot(
    p_reservation_id UUID
) RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    -- Liberar slot al cancelar reserva
    -- Cambiar status de 'reserved' a 'free'
END;
$$;
```

## ü§ñ **Sistema CRM**

### **`process_reservation_completion`**
```sql
CREATE OR REPLACE FUNCTION process_reservation_completion(
    p_reservation_id UUID
) RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    -- 1. Actualizar m√©tricas del cliente
    -- 2. Recalcular segmento autom√°tico
    -- 3. Actualizar recency_days y aivi_days
    -- 4. Disparar automatizaciones CRM
    -- 5. Registrar interacci√≥n
END;
$$;
```

### **`calculate_customer_segment`**
```sql
CREATE OR REPLACE FUNCTION calculate_customer_segment(
    p_customer_id UUID,
    p_restaurant_id UUID
) RETURNS VARCHAR
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    -- Calcular segmento basado en m√©tricas y configuraci√≥n CRM
    -- Retorna: 'nuevo', 'activo', 'vip', 'inactivo', 'riesgo'
END;
$$;
```

### **`execute_automation_rule`**
```sql
CREATE OR REPLACE FUNCTION execute_automation_rule(
    p_rule_id UUID,
    p_customer_id UUID,
    p_context JSONB DEFAULT '{}'
) RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    -- Ejecutar regla de automatizaci√≥n espec√≠fica
    -- Verificar cooldown, l√≠mites, horarios
    -- Enviar mensaje y registrar ejecuci√≥n
END;
$$;
```

## üìä **Analytics y Reporting**

### **`get_dashboard_stats`**
```sql
CREATE OR REPLACE FUNCTION get_dashboard_stats(
    p_restaurant_id UUID,
    p_start_date DATE,
    p_end_date DATE
) RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    -- Retornar m√©tricas completas para dashboard
    -- Reservas, clientes, ingresos, ocupaci√≥n, etc.
END;
$$;
```

### **`get_customer_segment_stats`**
```sql
CREATE OR REPLACE FUNCTION get_customer_segment_stats(
    p_restaurant_id UUID
) RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    -- Estad√≠sticas de segmentaci√≥n para CRM dashboard
    -- Distribuci√≥n, evoluci√≥n, m√©tricas por segmento
END;
$$;
```

### **`get_availability_stats`**
```sql
CREATE OR REPLACE FUNCTION get_availability_stats(
    p_restaurant_id UUID,
    p_date_from DATE,
    p_date_to DATE
) RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
    -- Estad√≠sticas de disponibilidad y ocupaci√≥n
    -- Por d√≠a, mesa, horario, etc.
END;
$$;
```

---

# üîê **POL√çTICAS RLS (ROW LEVEL SECURITY)**

## üõ°Ô∏è **Aislamiento Multi-tenant**

### **Pol√≠tica Base para Todas las Tablas:**
```sql
-- Ejemplo para restaurants
CREATE POLICY "restaurants_tenant_isolation" ON restaurants
    USING (
        id IN (
            SELECT restaurant_id 
            FROM user_restaurant_mapping 
            WHERE auth_user_id = auth.uid() 
            AND active = true
        )
        OR owner_id = auth.uid()
    );

-- Ejemplo para customers
CREATE POLICY "customers_tenant_isolation" ON customers
    USING (
        restaurant_id IN (
            SELECT restaurant_id 
            FROM user_restaurant_mapping 
            WHERE auth_user_id = auth.uid() 
            AND active = true
        )
    );

-- Ejemplo para availability_slots ‚≠ê NUEVO
CREATE POLICY "availability_slots_tenant_isolation" ON availability_slots
    USING (
        restaurant_id IN (
            SELECT restaurant_id 
            FROM user_restaurant_mapping 
            WHERE auth_user_id = auth.uid() 
            AND active = true
        )
    );

-- Ejemplo para special_events ‚≠ê NUEVO
CREATE POLICY "special_events_tenant_isolation" ON special_events
    USING (
        restaurant_id IN (
            SELECT restaurant_id 
            FROM user_restaurant_mapping 
            WHERE auth_user_id = auth.uid() 
            AND active = true
        )
    );
```

## üîí **Pol√≠ticas Espec√≠ficas por Roles**

### **Solo Owners pueden modificar configuraci√≥n cr√≠tica:**
```sql
CREATE POLICY "restaurants_owner_update" ON restaurants
    FOR UPDATE USING (owner_id = auth.uid());

CREATE POLICY "settings_owner_only" ON restaurants
    FOR UPDATE USING (
        owner_id = auth.uid() 
        AND (OLD.settings IS DISTINCT FROM NEW.settings 
             OR OLD.crm_config IS DISTINCT FROM NEW.crm_config)
    );
```

### **Staff autorizado puede gestionar reservas:**
```sql
CREATE POLICY "reservations_staff_access" ON reservations
    USING (
        restaurant_id IN (
            SELECT restaurant_id 
            FROM user_restaurant_mapping 
            WHERE auth_user_id = auth.uid() 
            AND active = true
            AND permissions->>'manage_reservations' = 'true'
        )
    );
```

### **Solo managers pueden ver analytics sensibles:**
```sql
CREATE POLICY "billing_manager_access" ON billing_tickets
    USING (
        restaurant_id IN (
            SELECT restaurant_id 
            FROM user_restaurant_mapping 
            WHERE auth_user_id = auth.uid() 
            AND active = true
            AND role IN ('owner', 'manager')
        )
    );
```

---

# üìà **√çNDICES PARA PERFORMANCE**

## üöÄ **√çndices Cr√≠ticos**

### **Sistema de Disponibilidades:**
```sql
-- B√∫squedas por restaurante y fecha
CREATE INDEX idx_availability_slots_restaurant_date 
ON availability_slots(restaurant_id, slot_date);

-- B√∫squedas por mesa, fecha y hora
CREATE INDEX idx_availability_slots_table_date_time 
ON availability_slots(table_id, slot_date, start_time);

-- Filtros por estado y fecha
CREATE INDEX idx_availability_slots_status_date 
ON availability_slots(status, slot_date) 
WHERE status IN ('free', 'reserved');

-- B√∫squedas de slots libres
CREATE INDEX idx_availability_slots_free 
ON availability_slots(restaurant_id, slot_date, start_time) 
WHERE status = 'free';
```

### **Sistema de Reservas:**
```sql
-- B√∫squedas principales de reservas
CREATE INDEX idx_reservations_restaurant_date 
ON reservations(restaurant_id, reservation_date);

CREATE INDEX idx_reservations_table_date 
ON reservations(table_id, reservation_date);

CREATE INDEX idx_reservations_customer 
ON reservations(customer_id, reservation_date);

-- B√∫squedas por estado
CREATE INDEX idx_reservations_status_date 
ON reservations(restaurant_id, status, reservation_date);
```

### **Sistema CRM:**
```sql
-- Segmentaci√≥n de clientes
CREATE INDEX idx_customers_segment 
ON customers(restaurant_id, segment_auto);

CREATE INDEX idx_customers_metrics 
ON customers(restaurant_id, visits_count, total_spent);

-- B√∫squedas de automatizaci√≥n
CREATE INDEX idx_automation_rules_active 
ON automation_rules(restaurant_id, is_active, trigger_event);

-- Historial de interacciones
CREATE INDEX idx_crm_interactions_customer_date 
ON crm_interactions(customer_id, created_at);
```

### **Sistema de Comunicaciones:**
```sql
-- Conversaciones por canal
CREATE INDEX idx_conversations_channel_status 
ON conversations(restaurant_id, channel, status);

-- Mensajes por conversaci√≥n
CREATE INDEX idx_messages_conversation_date 
ON messages(conversation_id, created_at);
```

---

# üîÑ **TRIGGERS AUTOM√ÅTICOS**

## ‚ö° **Triggers Cr√≠ticos del Sistema**

### **Actualizaci√≥n autom√°tica de m√©tricas de cliente:**
```sql
CREATE OR REPLACE FUNCTION trigger_update_customer_stats()
RETURNS TRIGGER AS $$
BEGIN
    -- Actualizar m√©tricas cuando se completa una reserva
    IF NEW.status = 'completada' AND OLD.status != 'completada' THEN
        UPDATE customers 
        SET 
            visits_count = visits_count + 1,
            last_visit_at = NEW.reservation_date,
            total_spent = total_spent + COALESCE(NEW.spend_amount, 0),
            avg_ticket = (total_spent + COALESCE(NEW.spend_amount, 0)) / (visits_count + 1),
            recency_days = EXTRACT(DAY FROM (CURRENT_DATE - NEW.reservation_date)),
            updated_at = NOW()
        WHERE id = NEW.customer_id;
        
        -- Recalcular segmento autom√°tico
        PERFORM calculate_customer_segment(NEW.customer_id, NEW.restaurant_id);
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_reservation_completion
    AFTER UPDATE ON reservations
    FOR EACH ROW
    EXECUTE FUNCTION trigger_update_customer_stats();
```

### **Liberaci√≥n autom√°tica de slots al cancelar reserva:**
```sql
CREATE OR REPLACE FUNCTION trigger_release_slot_on_cancel()
RETURNS TRIGGER AS $$
BEGIN
    -- Liberar slot cuando se cancela reserva
    IF NEW.status IN ('cancelada', 'noshow') AND OLD.status NOT IN ('cancelada', 'noshow') THEN
        UPDATE availability_slots
        SET 
            status = 'free',
            metadata = '{}',
            updated_at = NOW()
        WHERE metadata->>'reservation_id' = NEW.id::TEXT;
    END IF;
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_cancel_reservation
    AFTER UPDATE ON reservations
    FOR EACH ROW
    EXECUTE FUNCTION trigger_release_slot_on_cancel();
```

### **Actualizaci√≥n de timestamps:**
```sql
CREATE OR REPLACE FUNCTION trigger_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Aplicar a todas las tablas principales
CREATE TRIGGER trigger_restaurants_updated_at
    BEFORE UPDATE ON restaurants
    FOR EACH ROW EXECUTE FUNCTION trigger_updated_at();

CREATE TRIGGER trigger_customers_updated_at
    BEFORE UPDATE ON customers
    FOR EACH ROW EXECUTE FUNCTION trigger_updated_at();

CREATE TRIGGER trigger_reservations_updated_at
    BEFORE UPDATE ON reservations
    FOR EACH ROW EXECUTE FUNCTION trigger_updated_at();

-- ... aplicar a todas las dem√°s tablas
```

---

# üß™ **DATOS DE EJEMPLO Y SEEDS**

## üå± **Seeds B√°sicos para Desarrollo**

### **Restaurante de ejemplo:**
```sql
INSERT INTO restaurants (id, name, email, phone, address, city, settings, crm_config) 
VALUES (
    '550e8400-e29b-41d4-a716-446655440000',
    'Restaurante Demo',
    'demo@restaurante.com',
    '+34123456789',
    'Calle Principal 123',
    'Madrid',
    '{
        "operating_hours": {
            "monday": {"open": "12:00", "close": "23:00", "closed": false},
            "tuesday": {"open": "12:00", "close": "23:00", "closed": false},
            "wednesday": {"open": "12:00", "close": "23:00", "closed": false},
            "thursday": {"open": "12:00", "close": "23:00", "closed": false},
            "friday": {"open": "12:00", "close": "00:00", "closed": false},
            "saturday": {"open": "12:00", "close": "00:00", "closed": false},
            "sunday": {"open": "12:00", "close": "23:00", "closed": false}
        },
        "min_party_size": 1,
        "max_party_size": 12,
        "horizon_days": 60,
        "turn_duration_minutes": 90,
        "buffer_minutes": 15,
        "min_advance_hours": 2
    }',
    '{
        "factor_activo": 0.8,
        "factor_riesgo": 1.5,
        "dias_inactivo_min": 90,
        "vip_threshold": 500.00,
        "weekly_contact_cap": 3
    }'
);
```

### **Mesas de ejemplo:**
```sql
INSERT INTO tables (restaurant_id, table_number, name, zone, capacity) VALUES
('550e8400-e29b-41d4-a716-446655440000', '1', 'Mesa 1', 'Sal√≥n Principal', 4),
('550e8400-e29b-41d4-a716-446655440000', '2', 'Mesa 2', 'Sal√≥n Principal', 2),
('550e8400-e29b-41d4-a716-446655440000', '3', 'Mesa 3', 'Terraza', 6),
('550e8400-e29b-41d4-a716-446655440000', '4', 'Mesa 4', 'Terraza', 4),
('550e8400-e29b-41d4-a716-446655440000', '5', 'Mesa VIP', 'Zona VIP', 8);
```

### **Plantillas CRM de ejemplo:**
```sql
INSERT INTO message_templates (restaurant_id, name, template_type, target_segment, content, variables) VALUES
('550e8400-e29b-41d4-a716-446655440000', 'Bienvenida Nuevos Clientes', 'whatsapp', 'nuevo', 
'¬°Hola {first_name}! üëã Bienvenido a {restaurant_name}. Gracias por elegirnos para tu primera visita. ¬°Esperamos verte pronto de nuevo!',
'["restaurant_name", "first_name"]'),

('550e8400-e29b-41d4-a716-446655440000', 'Reactivaci√≥n Clientes Inactivos', 'email', 'inactivo',
'Hola {customer_name}, te echamos de menos en {restaurant_name}. Han pasado {recency_days} d√≠as desde tu √∫ltima visita. ¬°Ven a descubrir nuestras novedades!',
'["customer_name", "restaurant_name", "recency_days"]'),

('550e8400-e29b-41d4-a716-446655440000', 'Agradecimiento VIP', 'sms', 'vip',
'Estimado {customer_name}, gracias por ser un cliente VIP de {restaurant_name}. Has gastado {total_spent}‚Ç¨ en {visits_count} visitas. ¬°Eres muy especial para nosotros! üëë',
'["customer_name", "restaurant_name", "total_spent", "visits_count"]');
```

---

# üìä **ESTAD√çSTICAS Y M√âTRICAS**

## üìà **M√©tricas del Sistema**

### **Tablas por Categor√≠a:**
- **üè¢ Gesti√≥n**: 4 tablas (restaurants, user_restaurant_mapping, profiles, tables)
- **üë• Clientes**: 1 tabla (customers)
- **üìÖ Reservas**: 3 tablas (reservations, availability_slots, special_events)
- **ü§ñ CRM**: 4 tablas (message_templates, automation_rules, crm_interactions, automation_rule_executions)
- **üì± Comunicaciones**: 3 tablas (conversations, messages, communication_channels)
- **üí∞ Facturaci√≥n**: 1 tabla (billing_tickets)

### **Total: 16 tablas principales**

### **Funciones RPC:**
- **üóìÔ∏è Disponibilidades**: 4 funciones cr√≠ticas
- **ü§ñ CRM**: 3 funciones de automatizaci√≥n
- **üìä Analytics**: 3 funciones de reporting
- **Total: 10+ funciones RPC**

### **Pol√≠ticas RLS:**
- **üõ°Ô∏è Aislamiento**: 1 pol√≠tica por tabla (16 pol√≠ticas)
- **üîí Roles**: 5+ pol√≠ticas espec√≠ficas
- **Total: 20+ pol√≠ticas RLS**

### **√çndices de Performance:**
- **üöÄ Cr√≠ticos**: 15+ √≠ndices optimizados
- **üìà Compuestos**: 10+ √≠ndices multi-columna
- **üîç Parciales**: 5+ √≠ndices con WHERE clauses

---

# üöÄ **FUNCIONES RPC IMPLEMENTADAS (SEPTIEMBRE 2025)**

## üìä **NUEVAS FUNCIONES CR√çTICAS**

### **üéØ `generate_availability_slots` (ULTRA-ROBUSTA + TURNOS)**
```sql
FUNCTION generate_availability_slots(
    p_restaurant_id UUID,
    p_start_date DATE DEFAULT CURRENT_DATE,
    p_end_date DATE DEFAULT NULL
) RETURNS INTEGER
```

**üìã Descripci√≥n:**
- **Prop√≥sito:** Genera slots de disponibilidad con sistema de turnos inteligente
- **Robustez:** Maneja TODOS los casos edge de datos malformados
- **Sistema de Turnos:** Usa turnos configurados si existen, sino horario completo
- **Validaci√≥n:** Parsing seguro de operating_hours con fallbacks
- **Retorno:** N√∫mero entero de slots creados
- **Estado:** PRODUCCI√ìN - Funci√≥n principal del sistema (migraci√≥n completa v2.2)

**üîß Caracter√≠sticas T√©cnicas:**
- ‚úÖ **Sistema de turnos inteligente** - Genera solo en horarios de servicio configurados
- ‚úÖ **Fallback autom√°tico** - Si no hay turnos, usa horario completo
- ‚úÖ **Validaci√≥n extrema** de horarios malformados
- ‚úÖ **Manejo de excepciones** para valores inv√°lidos ("true", "false", null)
- ‚úÖ **Defaults seguros** (09:00-22:00) si datos corruptos
- ‚úÖ **Verificaci√≥n de mesas activas** antes de generar
- ‚úÖ **Detecci√≥n de eventos especiales** autom√°tica
- ‚úÖ **Limpieza de slots existentes** en el rango
- ‚úÖ **Validaci√≥n de conflictos** con reservas existentes
- ‚úÖ **Metadata de turnos** - Cada slot incluye informaci√≥n del turno origen

**üìà Performance:**
- Genera **4,000+ slots** en menos de 3 segundos
- Optimizada para **90 d√≠as** de antelaci√≥n
- Maneja **m√∫ltiples mesas** simult√°neamente
- **Transaccional** - todo o nada

### **üîç `diagnostic_availability_data` (DEBUGGING)**
```sql
FUNCTION diagnostic_availability_data(p_restaurant_id UUID)
RETURNS TABLE(diagnostic_type TEXT, diagnostic_data JSONB)
```

**üìã Descripci√≥n:**
- **Prop√≥sito:** Diagn√≥stico completo del sistema de disponibilidades
- **Uso:** Debugging y an√°lisis de problemas
- **Retorno:** Tabla con tipos de diagn√≥stico y datos JSON
- **Estado:** UTILIDAD - Para troubleshooting

**üîß Datos que Proporciona:**
- ‚úÖ **Configuraci√≥n completa** del restaurante
- ‚úÖ **Operating hours** por d√≠a de la semana
- ‚úÖ **Mesas activas** disponibles
- ‚úÖ **An√°lisis detallado** de cada d√≠a
- ‚úÖ **Detecci√≥n de problemas** en configuraci√≥n

### **üéØ `generate_availability_slots_robust` (TEMPORAL)**
```sql
FUNCTION generate_availability_slots_robust(
    p_restaurant_id UUID,
    p_start_date DATE DEFAULT CURRENT_DATE,
    p_end_date DATE DEFAULT NULL
) RETURNS INTEGER
```

**üìã Descripci√≥n:**
- **Prop√≥sito:** Versi√≥n de desarrollo con logging extensivo
- **Estado:** DEPRECATED - Reemplazada por funci√≥n principal
- **Uso:** Solo para debugging avanzado si es necesario

## üìä **FUNCIONES RPC EXISTENTES ACTUALIZADAS**

### **ü§ñ Funciones CRM:**
- `process_reservation_completion` - Procesa finalizaci√≥n de reservas
- `calculate_customer_metrics` - Calcula m√©tricas autom√°ticas
- `execute_automation_rules` - Ejecuta reglas de automatizaci√≥n

### **üìà Funciones Analytics:**
- `get_dashboard_stats` - Estad√≠sticas del dashboard
- `get_occupancy_data` - Datos de ocupaci√≥n
- `get_revenue_analytics` - Analytics de ingresos

## üõ°Ô∏è **POL√çTICAS RLS ACTUALIZADAS**

### **Nuevas Pol√≠ticas de Seguridad:**
```sql
-- Aislamiento de availability_slots por tenant
CREATE POLICY "availability_slots_tenant_isolation" ON availability_slots
FOR ALL USING (restaurant_id IN (
    SELECT restaurant_id FROM user_restaurant_mapping 
    WHERE auth_user_id = auth.uid()
));

-- Aislamiento de special_events por tenant
CREATE POLICY "special_events_tenant_isolation" ON special_events
FOR ALL USING (restaurant_id IN (
    SELECT restaurant_id FROM user_restaurant_mapping 
    WHERE auth_user_id = auth.uid()
));
```

## üöÄ **√çNDICES DE PERFORMANCE A√ëADIDOS**

### **√çndices Cr√≠ticos para Disponibilidades:**
```sql
-- √çndice compuesto para b√∫squedas r√°pidas de slots
CREATE INDEX idx_availability_slots_lookup ON availability_slots 
(restaurant_id, slot_date, status, table_id);

-- √çndice para optimizar generaci√≥n de slots
CREATE INDEX idx_availability_slots_generation ON availability_slots 
(restaurant_id, source, slot_date) 
WHERE source = 'system';

-- √çndice para conflictos con reservas
CREATE INDEX idx_reservations_availability_check ON reservations 
(restaurant_id, table_id, reservation_date, status) 
WHERE status IN ('confirmada', 'sentada');
```

---

# ‚ö†Ô∏è **ADVERTENCIAS CR√çTICAS**

## üö® **NUNCA MODIFICAR SIN ENTENDER:**

### **Tablas Cr√≠ticas:**
- ‚ùå `availability_slots` - Coraz√≥n del sistema de reservas
- ‚ùå `customers` - M√©tricas CRM autom√°ticas
- ‚ùå `restaurants.settings` - Configuraci√≥n unificada
- ‚ùå `automation_rules` - L√≥gica de CRM

### **Constraints √önicos:**
- ‚ùå `availability_slots(restaurant_id, table_id, slot_date, start_time)` - Evita duplicados
- ‚ùå `reservations` con `availability_slots` - Integridad referencial cr√≠tica
- ‚ùå `user_restaurant_mapping(auth_user_id, restaurant_id)` - Seguridad multi-tenant

### **Funciones RPC:**
- ‚ùå `generate_availability_slots` - Algoritmo complejo optimizado
- ‚ùå `process_reservation_completion` - Triggers CRM autom√°ticos
- ‚ùå Cualquier funci√≥n que modifique m√©tricas autom√°ticas

## ‚úÖ **ANTES DE MODIFICAR ESQUEMA:**

### **Proceso Obligatorio:**
1. **üìñ Leer** esta documentaci√≥n completa
2. **üß™ Probar** en entorno de desarrollo aislado
3. **üíæ Backup** completo de la base de datos
4. **üîÑ Migraci√≥n** con rollback plan
5. **üß™ Testing** exhaustivo post-migraci√≥n
6. **üìù Documentar** todos los cambios

### **Validaciones Cr√≠ticas:**
```sql
-- Verificar integridad referencial
SELECT COUNT(*) FROM availability_slots WHERE table_id NOT IN (SELECT id FROM tables);

-- Verificar constraints √∫nicos
SELECT restaurant_id, table_id, slot_date, start_time, COUNT(*) 
FROM availability_slots 
GROUP BY restaurant_id, table_id, slot_date, start_time 
HAVING COUNT(*) > 1;

-- Verificar pol√≠ticas RLS
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual 
FROM pg_policies 
WHERE schemaname = 'public' 
ORDER BY tablename;
```

---

# üöÄ **COMANDOS DE MANTENIMIENTO**

## üîß **Scripts de Administraci√≥n**

### **Aplicar migraciones:**
```bash
cd supabase
supabase db push
```

### **Verificar estado de la BD:**
```sql
-- Verificar todas las tablas
SELECT table_name, table_type 
FROM information_schema.tables 
WHERE table_schema = 'public' 
ORDER BY table_name;

-- Verificar funciones RPC
SELECT routine_name, routine_type 
FROM information_schema.routines 
WHERE routine_schema = 'public' 
AND routine_type = 'FUNCTION'
ORDER BY routine_name;

-- Verificar pol√≠ticas RLS
SELECT tablename, policyname, permissive, cmd 
FROM pg_policies 
WHERE schemaname = 'public'
ORDER BY tablename;
```

### **Optimizaci√≥n y mantenimiento:**
```sql
-- Reindexar tablas cr√≠ticas
REINDEX TABLE availability_slots;
REINDEX TABLE reservations;
REINDEX TABLE customers;

-- Actualizar estad√≠sticas
ANALYZE availability_slots;
ANALYZE reservations;
ANALYZE customers;

-- Vacuum para optimizar espacio
VACUUM ANALYZE;
```

---

**üìÖ √öltima actualizaci√≥n:** Febrero 2025  
**üë®‚Äçüíª Mantenido por:** Equipo LA-IA Development  
**üéØ Estado:** ESQUEMA COMPLETO Y ACTUALIZADO  
**üîó Versi√≥n:** 2.0 - Con Sistema de Conflictos

---

> **üí° Esta base de datos es la columna vertebral de LA-IA App. Cada tabla, cada relaci√≥n, cada √≠ndice ha sido dise√±ado para m√°xima performance y seguridad. Mant√©nla con extremo cuidado.**
