# üìö **DOCUMENTACI√ìN MAESTRA COMPLETA - LA-IA APP 2025**

> **La gu√≠a definitiva para entender, mantener y desarrollar el sistema m√°s avanzado de gesti√≥n de restaurantes con IA del mundo**

**üìÖ Fecha:** Febrero 2025  
**üéØ Estado:** DOCUMENTACI√ìN EXHAUSTIVA FINAL  
**‚úÖ Versi√≥n:** Master Complete Edition + Sistema de Conflictos  
**üë®‚Äçüíª Documentado por:** Claude Sonnet 4 (Auditor√≠a completa)

---

## üéØ **PROP√ìSITO DE ESTE DOCUMENTO**

Esta documentaci√≥n contiene **TODA LA INFORMACI√ìN** necesaria para que cualquier desarrollador pueda:
- ‚úÖ **Entender completamente** la aplicaci√≥n y su arquitectura
- ‚úÖ **Continuar el desarrollo** desde cualquier punto
- ‚úÖ **Conocer cada funcionalidad** implementada al detalle
- ‚úÖ **Comprender la l√≥gica** de negocio y t√©cnica
- ‚úÖ **Mantener y evolucionar** el sistema sin riesgo
- ‚úÖ **Tener todas las referencias** t√©cnicas y de base de datos

---

# üèóÔ∏è **ARQUITECTURA GENERAL DE LA APLICACI√ìN**

## üåü **¬øQU√â ES LA-IA APP?**

**LA-IA APP** es un sistema **enterprise-grade** de gesti√≥n de restaurantes que incluye:

### ü§ñ **CARACTER√çSTICAS PRINCIPALES:**
- **Agente IA 24/7** que maneja reservas autom√°ticamente
- **CRM Inteligente v2** con segmentaci√≥n autom√°tica y IA predictiva
- **Sistema Revolucionario de No-Shows** con algoritmos predictivos ‚≠ê **NUEVO**
- **Dashboard Ejecutivo** enfocado en valor monetario tangible ‚≠ê **NUEVO**
- **Sistema de Disponibilidades** robusto con detecci√≥n de conflictos
- **Validaci√≥n avanzada** de reservas con availability_slots
- **Gesti√≥n completa de conflictos** en tiempo real
- **Sistema omnicanal** (WhatsApp, tel√©fono, web, Instagram, Facebook)
- **Analytics avanzados** con predicciones de IA
- **Automatizaciones CRM** con plantillas personalizables
- **PWA completa** con instalaci√≥n offline

### üèÜ **DIFERENCIADORES √öNICOS MUNDIALES:**
1. **Sistema Revolucionario de No-Shows** con algoritmos predictivos de 6 factores ‚≠ê **NUEVO**
2. **Dashboard Ejecutivo** que muestra valor monetario tangible generado ‚≠ê **NUEVO**
3. **Sistema de detecci√≥n de conflictos** m√°s avanzado del mercado
4. **Validaci√≥n obligatoria** de disponibilidad antes de crear reservas
5. **CRM IA con 7 segmentos autom√°ticos** (Nuevo, Activo, VIP, Inactivo, Riesgo, etc.)
6. **Protecci√≥n inteligente** de recursos con reservas futuras
7. **Automatizaciones enterprise** con cooldown y consent GDPR
8. **Analytics predictivos** con machine learning
9. **Omnicanalidad total** con 5 canales integrados

---

# üóÑÔ∏è **BASE DE DATOS - ESQUEMA COMPLETO**

## üìä **TABLAS PRINCIPALES**

### **üè¢ GESTI√ìN DE RESTAURANTES**

#### **`restaurants`**
```sql
CREATE TABLE restaurants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR NOT NULL,
    email VARCHAR,
    phone VARCHAR,
    address TEXT,
    city VARCHAR,
    country VARCHAR DEFAULT 'Espa√±a',
    postal_code VARCHAR,
    cuisine_type VARCHAR,
    plan VARCHAR DEFAULT 'trial',
    active BOOLEAN DEFAULT true,
    owner_id UUID REFERENCES auth.users(id),
    settings JSONB DEFAULT '{}', -- ‚≠ê NUEVO: Configuraci√≥n unificada
    crm_config JSONB DEFAULT '{}',
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**üìã Campos importantes del `settings` JSONB:**
- `operating_hours`: Horarios de apertura por d√≠a
- `min_party_size`, `max_party_size`: Tama√±os de grupo
- `horizon_days`: D√≠as de antelaci√≥n m√°xima para reservas
- `turn_duration_minutes`: Duraci√≥n est√°ndar de reserva
- `buffer_minutes`: Buffer entre reservas
- `min_advance_hours`: Horas m√≠nimas de antelaci√≥n

#### **`tables`**
```sql
CREATE TABLE tables (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    restaurant_id UUID NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    table_number VARCHAR NOT NULL,
    name VARCHAR NOT NULL,
    zone VARCHAR,
    capacity INTEGER NOT NULL,
    status VARCHAR DEFAULT 'available',
    is_active BOOLEAN DEFAULT true,
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### **üë• GESTI√ìN DE CLIENTES**

#### **`customers`**
```sql
CREATE TABLE customers (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    restaurant_id UUID NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    name VARCHAR NOT NULL,
    email VARCHAR,
    phone VARCHAR,
    first_name VARCHAR,
    last_name1 VARCHAR,
    last_name2 VARCHAR,
    
    -- üéØ SEGMENTACI√ìN CRM
    segment_manual VARCHAR,
    segment_auto VARCHAR DEFAULT 'nuevo',
    
    -- üìä M√âTRICAS AUTOM√ÅTICAS
    visits_count INTEGER DEFAULT 0,
    total_spent NUMERIC DEFAULT 0.00,
    avg_ticket NUMERIC DEFAULT 0.00,
    last_visit_at TIMESTAMPTZ,
    recency_days INTEGER DEFAULT 0,
    aivi_days INTEGER DEFAULT 0,
    
    -- ü§ñ IA PREDICTIVA
    churn_risk_score INTEGER DEFAULT 0,
    predicted_ltv NUMERIC DEFAULT 0.00,
    
    -- üîí GDPR COMPLIANCE
    consent_email BOOLEAN DEFAULT true,
    consent_sms BOOLEAN DEFAULT true,
    consent_whatsapp BOOLEAN DEFAULT false,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### **üìÖ SISTEMA DE RESERVAS**

#### **`reservations`**
```sql
CREATE TABLE reservations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    restaurant_id UUID NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    customer_id UUID REFERENCES customers(id),
    customer_name VARCHAR NOT NULL,
    customer_email VARCHAR,
    customer_phone VARCHAR,
    table_id UUID REFERENCES tables(id),
    table_number VARCHAR,
    
    -- üìÖ DATOS DE RESERVA
    reservation_date DATE NOT NULL,
    reservation_time TIME NOT NULL,
    party_size INTEGER NOT NULL,
    status VARCHAR DEFAULT 'confirmada',
    
    -- ü§ñ ORIGEN Y CANAL
    source VARCHAR DEFAULT 'manual', -- 'manual' | 'ia'
    channel VARCHAR DEFAULT 'web',
    
    -- üí∞ FACTURACI√ìN
    spend_amount NUMERIC DEFAULT 0.00,
    
    special_requests TEXT,
    notes TEXT,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### **üóìÔ∏è SISTEMA DE DISPONIBILIDADES** ‚≠ê **NUEVO**

#### **`availability_slots`**
```sql
CREATE TABLE availability_slots (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    restaurant_id UUID NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    table_id UUID NOT NULL REFERENCES tables(id) ON DELETE CASCADE,
    
    -- ‚è∞ SLOT DE TIEMPO
    slot_date DATE NOT NULL,
    start_time TIME NOT NULL,
    end_time TIME NOT NULL,
    
    -- üìä ESTADO Y METADATOS
    status VARCHAR DEFAULT 'free', -- 'free' | 'reserved' | 'occupied'
    source VARCHAR DEFAULT 'system', -- 'system' | 'manual'
    metadata JSONB DEFAULT '{}',
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW(),
    
    UNIQUE(restaurant_id, table_id, slot_date, start_time)
);
```

**üìã Estados de `availability_slots`:**
- **`free`**: Disponible para reservar
- **`reserved`**: Reservado (tiene reservation_id en metadata)
- **`occupied`**: Ocupado por evento especial o cierre

#### **`special_events`** ‚≠ê **NUEVO**
```sql
CREATE TABLE special_events (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    restaurant_id UUID NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    
    -- üìÖ EVENTO
    name VARCHAR NOT NULL,
    description TEXT,
    event_type VARCHAR NOT NULL, -- 'closure' | 'holiday' | 'private_event'
    start_date DATE NOT NULL,
    end_date DATE NOT NULL,
    
    -- ‚öôÔ∏è CONFIGURACI√ìN
    affects_all_tables BOOLEAN DEFAULT true,
    affected_table_ids UUID[],
    is_active BOOLEAN DEFAULT true,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### **ü§ñ SISTEMA CRM INTELIGENTE**

#### **`message_templates`**
```sql
CREATE TABLE message_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    restaurant_id UUID NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    
    -- üìù PLANTILLA
    name VARCHAR NOT NULL,
    description TEXT,
    subject VARCHAR,
    content TEXT NOT NULL,
    
    -- üéØ CONFIGURACI√ìN
    template_type VARCHAR NOT NULL, -- 'email' | 'sms' | 'whatsapp'
    target_segment VARCHAR, -- 'nuevo' | 'activo' | 'vip' | etc.
    
    -- üîß VARIABLES
    variables JSONB DEFAULT '[]',
    
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### **`automation_rules`**
```sql
CREATE TABLE automation_rules (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    restaurant_id UUID NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    
    -- üéØ REGLA
    name TEXT NOT NULL,
    description TEXT,
    is_active BOOLEAN DEFAULT true,
    
    -- üîÑ TRIGGER
    trigger_event TEXT NOT NULL, -- 'reservation_completed' | 'segment_changed' | etc.
    trigger_conditions JSONB DEFAULT '{}',
    
    -- üéØ TARGET
    target_segment TEXT,
    template_id UUID REFERENCES message_templates(id),
    
    -- ‚è∞ L√çMITES Y COOLDOWN
    cooldown_days INTEGER DEFAULT 30,
    max_executions_per_customer INTEGER DEFAULT 5,
    max_daily_executions INTEGER DEFAULT 50,
    
    -- üïê HORARIOS
    execution_hours_start TIME DEFAULT '09:00',
    execution_hours_end TIME DEFAULT '21:00',
    execution_days_of_week INTEGER[] DEFAULT ARRAY[1,2,3,4,5,6,7],
    
    -- üìä M√âTRICAS
    execution_count INTEGER DEFAULT 0,
    last_executed_at TIMESTAMPTZ,
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### **üìä SISTEMA DE COMUNICACIONES**

#### **`conversations`**
```sql
CREATE TABLE conversations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    restaurant_id UUID NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    customer_id UUID REFERENCES customers(id),
    
    -- üì± CANAL
    channel VARCHAR NOT NULL, -- 'whatsapp' | 'sms' | 'email' | 'phone' | 'web'
    external_id VARCHAR, -- ID del canal externo
    
    -- üìä ESTADO
    status VARCHAR DEFAULT 'active', -- 'active' | 'closed' | 'archived'
    priority VARCHAR DEFAULT 'normal', -- 'low' | 'normal' | 'high' | 'urgent'
    
    -- üìù METADATOS
    metadata JSONB DEFAULT '{}',
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### **`messages`**
```sql
CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    conversation_id UUID NOT NULL REFERENCES conversations(id) ON DELETE CASCADE,
    
    -- üìù MENSAJE
    content TEXT NOT NULL,
    message_type VARCHAR DEFAULT 'text', -- 'text' | 'image' | 'audio' | 'file'
    direction VARCHAR NOT NULL, -- 'inbound' | 'outbound'
    
    -- üë§ REMITENTE
    sender_type VARCHAR NOT NULL, -- 'customer' | 'staff' | 'agent' | 'system'
    sender_id UUID,
    
    -- üìä ESTADO
    status VARCHAR DEFAULT 'sent', -- 'sent' | 'delivered' | 'read' | 'failed'
    
    -- üìé METADATOS
    metadata JSONB DEFAULT '{}',
    
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

# üîß **SERVICIOS Y COMPONENTES PRINCIPALES**

## üö® **SISTEMA REVOLUCIONARIO DE NO-SHOWS** ‚≠ê **SEPTIEMBRE 2025**

### **`NoShowManager.jsx`**
**Ubicaci√≥n:** `src/components/NoShowManager.jsx`

**üéØ Prop√≥sito:** Sistema m√°s avanzado del mercado para prevenir y gestionar no-shows con algoritmos predictivos.

#### **üß† Algoritmo Predictivo de 6 Factores:**

1. **Historial del Cliente** (0-40 puntos):
   - No-show rate > 30% ‚Üí +40 puntos
   - No-show rate > 10% ‚Üí +20 puntos

2. **Inactividad** (0-25 puntos):
   - >180 d√≠as sin visita ‚Üí +25 puntos
   - >90 d√≠as sin visita ‚Üí +15 puntos

3. **Horario de Riesgo** (0-15 puntos):
   - Reservas ‚â•21:00 ‚Üí +15 puntos

4. **Tama√±o de Grupo** (0-10 puntos):
   - Grupos ‚â•6 personas ‚Üí +10 puntos

5. **Canal de Reserva** (0-10 puntos):
   - Phone/walk-in ‚Üí +10 puntos

6. **Antelaci√≥n** (0-20 puntos):
   - <4 horas antelaci√≥n ‚Üí +20 puntos

#### **üéØ Niveles de Riesgo:**
- **Alto** (>60 puntos): Llamada de confirmaci√≥n obligatoria
- **Medio** (30-60 puntos): WhatsApp de recordatorio
- **Bajo** (<30 puntos): Recordatorio est√°ndar

#### **üöÄ Funciones RPC Creadas:**

```sql
-- Estad√≠sticas hist√≥ricas por cliente
get_customer_noshow_stats(p_restaurant_id uuid)

-- M√©tricas generales del restaurante  
get_restaurant_noshow_metrics(p_restaurant_id uuid, p_days_back integer)

-- Predicciones para pr√≥ximas reservas
predict_upcoming_noshows(p_restaurant_id uuid, p_days_ahead integer)

-- Marcado autom√°tico de no-shows
auto_mark_noshows()
```

### **`DashboardRevolutionary.jsx`**
**Ubicaci√≥n:** `src/components/DashboardRevolutionary.jsx`

**üéØ Prop√≥sito:** Dashboard ejecutivo que muestra valor monetario tangible generado por el sistema.

#### **üìä Widgets Revolucionarios:**

1. **Estado General del Sistema** (Sem√°foro):
   - Verde: Todo perfecto
   - Amarillo: Requiere atenci√≥n
   - Rojo: Acci√≥n requerida

2. **Control No-Shows**:
   - No-shows evitados esta semana
   - Reservas de alto riesgo hoy
   - Acciones recomendadas

3. **Clientes que Vuelven**:
   - Retornos esta semana
   - Clientes leales
   - Top 3 clientes

4. **Oportunidades CRM**:
   - Acciones pendientes ejecutables
   - Campa√±as sugeridas

5. **Valor Generado Total** ‚≠ê **REVOLUCIONARIO**:
   ```javascript
   const totalValue = {
     noShowsRecovered: evitados √ó ticketMedio,
     crmGenerated: clientesCRM √ó valorPromedio,
     automationSavings: tiempoAhorrado √ó costoHora
   }
   ```

#### **üí∞ C√°lculo de ROI Tangible:**
- **No-shows evitados**: 2 √ó 70‚Ç¨ = 140‚Ç¨
- **Clientes CRM recuperados**: 5 √ó 85‚Ç¨ = 425‚Ç¨
- **Tiempo ahorrado**: 3h √ó 15‚Ç¨ = 45‚Ç¨
- **TOTAL GENERADO**: **610‚Ç¨ esta semana**

### **`NoShowControl.jsx`**
**Ubicaci√≥n:** `src/pages/NoShowControl.jsx`

**üéØ Prop√≥sito:** P√°gina completa dedicada al control avanzado de no-shows.

#### **Funcionalidades:**
- Vista detallada de todas las predicciones
- Acciones de prevenci√≥n ejecutables
- An√°lisis hist√≥rico por cliente
- M√©tricas de efectividad del sistema

## üõ°Ô∏è **SISTEMA DE DETECCI√ìN DE CONFLICTOS** ‚≠ê **EXISTENTE**

### **`ConflictDetectionService.js`**
**Ubicaci√≥n:** `src/services/ConflictDetectionService.js`

**üéØ Prop√≥sito:** Sistema completo para detectar y prevenir conflictos en reservas, mesas, horarios y eventos.

#### **M√©todos principales:**

```javascript
// üö® DETECTAR CONFLICTOS AL CAMBIAR HORARIOS
static async detectScheduleConflicts(restaurantId, newSchedule, startDate, endDate)

// ü™ë DETECTAR CONFLICTOS AL CAMBIAR MESAS  
static async detectTableConflicts(restaurantId, tableId, changeType, newCapacity)

// üéâ DETECTAR CONFLICTOS AL CREAR EVENTOS ESPECIALES
static async detectEventConflicts(restaurantId, eventDate, eventType)

// ‚úÖ VALIDAR DISPONIBILIDAD ANTES DE CREAR RESERVA
static async validateReservationAvailability(restaurantId, reservationDate, reservationTime, partySize, tableId)

// üîÑ DETECTAR NECESIDAD DE REGENERAR DISPONIBILIDADES
static async detectAvailabilityUpdateNeeds(restaurantId, changeType, changeData)
```

#### **Tipos de conflictos detectados:**
- **`DAY_CLOSED`**: D√≠a cerrado pero con reservas confirmadas
- **`OUTSIDE_HOURS`**: Reserva fuera del horario de apertura
- **`TABLE_DELETE_WITH_RESERVATIONS`**: Eliminar mesa con reservas futuras
- **`CAPACITY_TOO_SMALL`**: Reducir capacidad con reservas de m√°s personas
- **`EVENT_CLOSURE_WITH_RESERVATIONS`**: Evento de cierre con reservas existentes
- **`SIN_DISPONIBILIDAD`**: No hay slots disponibles para la reserva

### **`ConflictWarning.jsx`**
**Ubicaci√≥n:** `src/components/ConflictWarning.jsx`

**üéØ Prop√≥sito:** Modal inteligente para mostrar conflictos y permitir decisiones informadas.

#### **Caracter√≠sticas:**
- **Severidad visual**: Cr√≠tico (rojo), Alto (naranja), Medio (amarillo)
- **Lista detallada** de reservas afectadas
- **Recomendaciones espec√≠ficas** por tipo de conflicto
- **Resumen cuantificado** del impacto
- **Opciones claras** de confirmaci√≥n o cancelaci√≥n

## üìÖ **SISTEMA DE DISPONIBILIDADES**

### **`AvailabilityManager.jsx`**
**Ubicaci√≥n:** `src/components/AvailabilityManager.jsx`

**üéØ Prop√≥sito:** Gesti√≥n completa del sistema de disponibilidades con generaci√≥n autom√°tica.

#### **Funcionalidades principales:**
- **Generaci√≥n masiva** de slots basada en pol√≠tica de reservas
- **Estad√≠sticas en tiempo real** (Total, Libres, Reservados, Ocupados)
- **Vista de calendario** con slots detallados
- **Detecci√≥n de conflictos** con reservas existentes
- **Resumen inteligente** sin sobrecargar la UI

#### **Configuraci√≥n autom√°tica:**
- Usa `restaurants.settings.horizon_days` para d√≠as de antelaci√≥n
- Usa `restaurants.settings.turn_duration_minutes` para duraci√≥n
- Usa `restaurants.settings.buffer_minutes` para buffer
- Usa `restaurants.settings.operating_hours` para horarios

### **`ReservationFormModal.jsx`** ‚≠ê **NUEVO**
**Ubicaci√≥n:** `src/components/ReservationFormModal.jsx`

**üéØ Prop√≥sito:** Modal para crear reservas con validaci√≥n obligatoria de disponibilidad.

#### **Validaciones implementadas:**
1. **Tiempo real**: Validaci√≥n al cambiar fecha/hora/personas
2. **Disponibilidad obligatoria**: NO permite crear sin availability_slot
3. **Capacidad de mesa**: Verifica que la mesa tenga suficiente capacidad
4. **Estado de mesa**: Verifica que la mesa est√© activa y disponible
5. **Asignaci√≥n autom√°tica**: Selecciona mesa si no se especifica
6. **Marcado autom√°tico**: Marca slot como 'reserved' al crear

#### **Estados de validaci√≥n:**
- **‚úÖ Verde**: Disponibilidad confirmada
- **‚ùå Rojo**: Sin disponibilidad o error
- **üîÑ Azul**: Verificando disponibilidad

## ü§ñ **SISTEMA CRM INTELIGENTE V2**

### **`CRMv2Complete.jsx`**
**Ubicaci√≥n:** `src/pages/CRMv2Complete.jsx`

**üéØ Prop√≥sito:** Sistema CRM completo con configuraci√≥n avanzada mediante sliders.

#### **Pesta√±as principales:**
1. **üìä Dashboard**: M√©tricas y ROI por tipo de automatizaci√≥n
2. **üë• Clientes**: Lista unificada con formato de tarjetas
3. **üí¨ Mensajes**: Historial completo de comunicaciones
4. **ü§ñ Automatizaci√≥n**: Reglas activas/inactivas con toggles
5. **‚öôÔ∏è Configuraci√≥n**: Sliders para configuraci√≥n de segmentos

#### **Configuraci√≥n con sliders:**
- **Factor Activo** (0.5-1.0): Define umbral para segmento "Activo"
- **Factor Riesgo** (1.0-3.0): Define umbral para segmento "En Riesgo"
- **D√≠as Inactivo** (30-180): D√≠as para considerar cliente inactivo
- **Umbral VIP** (100-2000‚Ç¨): Gasto m√≠nimo para ser VIP
- **L√≠mite Contactos** (1-10): M√°ximo contactos semanales por cliente

#### **Recalculaci√≥n autom√°tica:**
Al guardar configuraci√≥n, el sistema:
1. Recalcula segmentos de TODOS los clientes
2. Actualiza solo clientes sin segmento manual
3. Aplica nueva configuraci√≥n inmediatamente
4. Muestra toast con progreso

### **`CRMv2Service.js`**
**Ubicaci√≥n:** `src/services/CRMv2Service.js`

**üéØ Prop√≥sito:** L√≥gica de negocio para segmentaci√≥n autom√°tica.

#### **Funci√≥n principal:**
```javascript
export const calculateSegment = (customer, crmSettings) => {
    // L√≥gica compleja de segmentaci√≥n basada en:
    // - Recency (d√≠as desde √∫ltima visita)
    // - Frequency (n√∫mero de visitas)  
    // - Monetary (gasto total)
    // - AIVI (d√≠as desde primera visita)
}
```

## üè¢ **GESTI√ìN DE MESAS CON PROTECCI√ìN**

### **Protecci√≥n inteligente en `Mesas.jsx`**
**Ubicaci√≥n:** `src/pages/Mesas.jsx`

#### **Validaci√≥n antes de eliminar:**
```javascript
const handleDeleteTableWithValidation = async (table) => {
    const conflicts = await ConflictDetectionService.detectTableConflicts(
        restaurantId, table.id, 'DELETE'
    );
    
    if (conflicts.hasConflicts) {
        // Mostrar modal de conflictos
        setConflictData(conflicts);
    } else {
        // Eliminar directamente
        deleteTable(table.id);
    }
};
```

#### **Informaci√≥n mostrada en conflictos:**
- **N√∫mero de reservas** futuras afectadas
- **Detalles de cada reserva**: Cliente, fecha, hora, personas
- **Pr√≥xima reserva** m√°s cercana
- **Recomendaciones** espec√≠ficas

## üìä **SISTEMA DE RESERVAS MEJORADO**

### **`Reservas.jsx` con pesta√±as**
**Ubicaci√≥n:** `src/pages/Reservas.jsx`

#### **Estructura de pesta√±as:**
1. **üìÖ Reservas**: Lista principal con filtros r√°pidos
2. **üóìÔ∏è Disponibilidades**: Gesti√≥n de availability_slots
3. **‚öôÔ∏è Pol√≠tica de Reservas**: Configuraci√≥n unificada

#### **Filtros r√°pidos implementados:**
- **üìÖ HOY**: Reservas del d√≠a actual
- **üåÖ MA√ëANA**: Reservas del d√≠a siguiente  
- **üìä ESTA SEMANA**: Reservas de los pr√≥ximos 7 d√≠as
- **üìÜ ESTE MES**: Reservas del mes actual
- **üîÑ TODAS**: Sin filtro de fecha

#### **Priorizaci√≥n en ReservationCard:**
```javascript
// üéØ MESA Y ZONA PRIMERO - M√ÅS VISIBLE
<div className="flex items-center gap-3 mb-3">
    <div className="flex items-center gap-2 px-3 py-2 bg-blue-100 text-blue-900 rounded-lg font-bold text-lg">
        <Shield className="w-5 h-5" />
        <span>{reservation.tables?.name || `Mesa ${reservation.table_number}`}</span>
    </div>
    
    {reservation.tables?.zone && (
        <div className="flex items-center gap-1 px-2 py-1 bg-gray-100 text-gray-700 rounded text-sm">
            <MapPin className="w-4 h-4" />
            {reservation.tables.zone}
        </div>
    )}
</div>

{/* INFORMACI√ìN SECUNDARIA */}
<div className="flex items-center gap-2 mb-2">
    <h4 className="font-medium text-gray-700">{reservation.customer_name}</h4>
</div>
```

#### **Pol√≠tica de Reservas integrada:**
- **Carga autom√°tica** desde `restaurants.settings`
- **Guardado en JSONB** unificado
- **Aplicaci√≥n inmediata** en generaci√≥n de disponibilidades
- **Validaci√≥n de tipos** y rangos

---

# üîÑ **FUNCIONES RPC DE SUPABASE**

## üóìÔ∏è **Sistema de Disponibilidades**

### **`generate_availability_slots`**
```sql
CREATE OR REPLACE FUNCTION generate_availability_slots(
    p_restaurant_id UUID,
    p_start_date DATE DEFAULT CURRENT_DATE,
    p_end_date DATE DEFAULT NULL
) RETURNS INTEGER
```

**üéØ Prop√≥sito:** Generar slots de disponibilidad masivamente.

**üìã L√≥gica:**
1. Obtiene configuraci√≥n de `restaurants.settings`
2. Limpia slots existentes del sistema en el rango
3. Itera d√≠a por d√≠a desde start_date hasta end_date
4. Para cada d√≠a, obtiene horario usando nombres (monday, tuesday, etc.)
5. Verifica eventos especiales que afecten el d√≠a
6. Para cada mesa activa, genera slots cada (duraci√≥n + buffer) minutos
7. Evita conflictos con reservas existentes
8. Retorna n√∫mero total de slots creados

**üîß Estructura de horarios esperada:**
```json
{
    "operating_hours": {
        "monday": {"open": "09:00", "close": "22:00", "closed": false},
        "tuesday": {"open": "09:00", "close": "22:00", "closed": false},
        // ... resto de d√≠as
    }
}
```

### **`check_availability`**
```sql
CREATE OR REPLACE FUNCTION check_availability(
    p_restaurant_id UUID,
    p_date DATE,
    p_time TIME,
    p_party_size INTEGER,
    p_table_id UUID DEFAULT NULL
) RETURNS JSONB
```

**üéØ Prop√≥sito:** Verificar disponibilidad para una reserva espec√≠fica.

### **`book_table`**
```sql
CREATE OR REPLACE FUNCTION book_table(
    p_restaurant_id UUID,
    p_slot_id UUID,
    p_reservation_data JSONB
) RETURNS JSONB
```

**üéØ Prop√≥sito:** Reservar un slot espec√≠fico de manera transaccional.

## üë• **Sistema CRM**

### **`process_reservation_completion`**
```sql
CREATE OR REPLACE FUNCTION process_reservation_completion(
    p_reservation_id UUID
) RETURNS JSONB
```

**üéØ Prop√≥sito:** Procesar autom√°ticamente la finalizaci√≥n de una reserva.

**üìã L√≥gica:**
1. Actualiza m√©tricas del cliente (visits_count, total_spent, etc.)
2. Recalcula segmento autom√°tico
3. Actualiza recency_days y aivi_days
4. Dispara automatizaciones CRM si corresponde
5. Registra interacci√≥n en el historial

### **`get_customer_segment_stats`**
```sql
CREATE OR REPLACE FUNCTION get_customer_segment_stats(
    p_restaurant_id UUID
) RETURNS JSONB
```

**üéØ Prop√≥sito:** Obtener estad√≠sticas de segmentaci√≥n para el dashboard CRM.

---

# üé® **INTERFACES DE USUARIO**

## üéØ **Principios de Dise√±o**

### **1. Intervenci√≥n Quir√∫rgica M√≠nima**
- **NO degradar** funcionalidades existentes
- **Cambios espec√≠ficos** y puntuales
- **Mejoras incrementales** sin romper lo que funciona
- **Preservar** patrones establecidos

### **2. Informaci√≥n Prioritaria**
- **Mesa y Zona PRIMERO** en reservas (para staff de restaurante)
- **Segmentaci√≥n visual** clara con iconos y colores
- **Estados inmediatos** con feedback visual
- **Datos relevantes** seg√∫n contexto de usuario

### **3. Validaci√≥n Proactiva**
- **Prevenci√≥n** mejor que correcci√≥n
- **Feedback inmediato** en formularios
- **Advertencias claras** antes de acciones destructivas
- **Informaci√≥n completa** para tomar decisiones

## üé® **Componentes de UI**

### **Segmentaci√≥n de Clientes**
```javascript
const CUSTOMER_SEGMENTS = {
    nuevo: { label: "Nuevo", icon: "üëã", color: "blue" },
    activo: { label: "Activo", icon: "‚≠ê", color: "green" },
    vip: { label: "VIP", icon: "üëë", color: "purple" }, // Corregido de "bib"
    inactivo: { label: "Inactivo", icon: "üò¥", color: "gray" },
    riesgo: { label: "En Riesgo", icon: "‚ö†Ô∏è", color: "orange" }
};
```

### **Estados de Reserva**
```javascript
const RESERVATION_STATES = {
    pendiente: { label: "Pendiente", color: "border-yellow-300 bg-yellow-50", icon: Clock },
    confirmada: { label: "Confirmada", color: "border-blue-300 bg-blue-50", icon: CheckCircle2 },
    sentada: { label: "Sentada", color: "border-green-300 bg-green-50", icon: Users },
    completada: { label: "Completada", color: "border-gray-300 bg-gray-50", icon: CheckCircle2 },
    cancelada: { label: "Cancelada", color: "border-red-300 bg-red-50", icon: XCircle },
    noshow: { label: "No Show", color: "border-orange-300 bg-orange-50", icon: AlertCircle }
};
```

### **Sliders de Configuraci√≥n CRM**
```css
/* Estilos para sliders de configuraci√≥n CRM */
.slider-green::-webkit-slider-thumb {
  appearance: none;
  height: 20px;
  width: 20px;
  border-radius: 50%;
  background: #10B981;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
```

---

# üîê **SEGURIDAD Y RLS (ROW LEVEL SECURITY)**

## üõ°Ô∏è **Pol√≠ticas de Seguridad**

### **Aislamiento Multi-tenant**
Todas las tablas principales tienen pol√≠ticas RLS:

```sql
-- Ejemplo para availability_slots
CREATE POLICY "availability_slots_tenant_isolation" ON availability_slots
    USING (
        restaurant_id IN (
            SELECT restaurant_id 
            FROM user_restaurant_mapping 
            WHERE auth_user_id = auth.uid() 
            AND active = true
        )
    );
```

### **Operaciones CRUD Controladas**
```sql
-- Solo propietarios pueden modificar configuraci√≥n cr√≠tica
CREATE POLICY "restaurants_owner_update" ON restaurants
    FOR UPDATE USING (owner_id = auth.uid());

-- Solo staff autorizado puede gestionar reservas
CREATE POLICY "reservations_staff_access" ON reservations
    USING (
        restaurant_id IN (
            SELECT restaurant_id 
            FROM user_restaurant_mapping 
            WHERE auth_user_id = auth.uid() 
            AND permissions->>'manage_reservations' = 'true'
        )
    );
```

## üîí **Validaciones de Integridad**

### **Constraints de Base de Datos**
```sql
-- Evitar slots duplicados
ALTER TABLE availability_slots 
ADD CONSTRAINT unique_slot_per_table_time 
UNIQUE(restaurant_id, table_id, slot_date, start_time);

-- Validar estados
ALTER TABLE reservations 
ADD CONSTRAINT valid_status 
CHECK (status IN ('pendiente', 'confirmada', 'sentada', 'completada', 'cancelada', 'noshow'));

-- Validar segmentos
ALTER TABLE customers 
ADD CONSTRAINT valid_segment 
CHECK (segment_auto IN ('nuevo', 'activo', 'vip', 'inactivo', 'riesgo'));
```

---

# üöÄ **FLUJOS DE TRABAJO CR√çTICOS**

## üìÖ **Crear Nueva Reserva (Validaci√≥n Completa)**

```mermaid
flowchart TD
    A[Usuario abre ReservationFormModal] --> B[Completa datos b√°sicos]
    B --> C[Sistema valida en tiempo real]
    C --> D{¬øHay disponibilidad?}
    D -->|NO| E[‚ùå Bloquea creaci√≥n + Mensaje error]
    D -->|S√ç| F[‚úÖ Permite continuar]
    F --> G[Usuario confirma creaci√≥n]
    G --> H[Sistema crea/actualiza cliente]
    H --> I[Sistema crea reserva]
    I --> J[Sistema marca slot como 'reserved']
    J --> K[‚úÖ Reserva creada exitosamente]
```

### **C√≥digo de validaci√≥n:**
```javascript
const validation = await ConflictDetectionService.validateReservationAvailability(
    restaurantId,
    formData.reservation_date,
    formData.reservation_time,
    formData.party_size,
    formData.table_id || null
);

if (!validation.isValid) {
    setValidationError(validation.message);
    return; // ‚ùå BLOQUEA CREACI√ìN
}
```

## ü™ë **Eliminar Mesa (Protecci√≥n Inteligente)**

```mermaid
flowchart TD
    A[Usuario intenta eliminar mesa] --> B[Sistema detecta conflictos]
    B --> C{¬øHay reservas futuras?}
    C -->|NO| D[Confirmaci√≥n simple]
    C -->|S√ç| E[Modal de conflictos detallado]
    E --> F{¬øUsuario confirma?}
    F -->|NO| G[‚ùå Cancelar eliminaci√≥n]
    F -->|S√ç| H[‚ö†Ô∏è Eliminar con advertencia]
    D --> I[‚úÖ Mesa eliminada]
    H --> J[‚ö†Ô∏è Mesa eliminada + Toast advertencia]
```

### **Informaci√≥n mostrada en conflictos:**
- Lista completa de reservas afectadas
- Detalles: Cliente, fecha, hora, personas, tel√©fono
- Pr√≥xima reserva m√°s cercana
- Recomendaciones espec√≠ficas
- Opci√≥n de contactar clientes

## üóìÔ∏è **Generar Disponibilidades (Proceso Masivo)**

```mermaid
flowchart TD
    A[Usuario click 'Generar Disponibilidades'] --> B[Sistema carga pol√≠tica de reservas]
    B --> C[Calcula rango de fechas autom√°tico]
    C --> D[Limpia slots existentes del sistema]
    D --> E[Itera d√≠a por d√≠a]
    E --> F{¬øD√≠a abierto?}
    F -->|NO| G[Salta al siguiente d√≠a]
    F -->|S√ç| H[Verifica eventos especiales]
    H --> I{¬øHay cierres?}
    I -->|S√ç| G
    I -->|NO| J[Para cada mesa activa]
    J --> K[Genera slots cada duraci√≥n+buffer]
    K --> L[Evita conflictos con reservas]
    L --> M[Guarda slots en BD]
    M --> N{¬øM√°s d√≠as?}
    N -->|S√ç| E
    N -->|NO| O[‚úÖ Muestra resumen inteligente]
```

### **Resumen mostrado:**
```javascript
const summaryMessage = `‚úÖ Disponibilidades generadas exitosamente:

üìä RESUMEN:
‚Ä¢ ${data} slots creados
‚Ä¢ Desde HOY hasta ${endDate} (${advanceDays} d√≠as)
‚Ä¢ Duraci√≥n por reserva: ${duration} min
‚Ä¢ Buffer entre reservas: ${buffer} min
‚Ä¢ Para todas las mesas activas

üéØ Las disponibilidades est√°n listas para recibir reservas.`;
```

---

# üìä **M√âTRICAS Y ANALYTICS**

## üéØ **KPIs Principales**

### **Disponibilidades**
- **Total slots**: N√∫mero total de slots generados
- **Slots libres**: Disponibles para reservar
- **Slots reservados**: Con reservation_id en metadata
- **Slots ocupados**: Por eventos especiales
- **Tasa de ocupaci√≥n**: (reservados + ocupados) / total

### **CRM Inteligente**
- **Distribuci√≥n de segmentos**: Porcentaje por cada segmento
- **ROI por automatizaci√≥n**: Ingresos generados vs costos
- **Tasa de conversi√≥n**: Mensajes enviados vs reservas generadas
- **Churn rate**: Clientes que pasan a inactivo
- **Customer Lifetime Value**: Predicci√≥n de valor futuro

### **Conflictos y Validaciones**
- **Conflictos detectados**: N√∫mero total por tipo
- **Conflictos resueltos**: Porcentaje de resoluci√≥n exitosa
- **Reservas bloqueadas**: Por falta de disponibilidad
- **Tiempo de resoluci√≥n**: Promedio para solucionar conflictos

## üìà **Dashboards Implementados**

### **CRM Dashboard**
- **M√©tricas de segmentaci√≥n** en tiempo real
- **ROI por tipo de automatizaci√≥n** (Bienvenidas, Reactivaciones, VIPs)
- **Clientes contactados vs retornados**
- **Ingresos estimados** por campa√±a CRM

### **Reservas Dashboard**
- **Ocupaci√≥n en tiempo real** por d√≠a/semana/mes
- **Fuentes de reservas** (Manual vs IA vs Canales)
- **Estados de reservas** con distribuci√≥n visual
- **Predicciones de demanda** basadas en hist√≥rico

---

# üß™ **TESTING Y CALIDAD**

## ‚úÖ **Tipos de Test Implementados**

### **Unit Tests**
- **Servicios cr√≠ticos**: ConflictDetectionService, CRMv2Service
- **Utilidades**: Funciones de c√°lculo y validaci√≥n
- **Componentes**: L√≥gica de negocio en React components

### **Integration Tests**
- **API flows**: Creaci√≥n de reservas end-to-end
- **Database operations**: CRUD con RLS
- **RPC functions**: Funciones de Supabase

### **E2E Tests**
- **Flujo completo de reserva**: Desde formulario hasta confirmaci√≥n
- **Gesti√≥n de conflictos**: Detecci√≥n y resoluci√≥n
- **CRM workflows**: Segmentaci√≥n y automatizaciones

## üéØ **Comandos de Testing**

```bash
# Tests unitarios
npm run test:unit

# Tests de integraci√≥n  
npm run test:integration

# Tests end-to-end
npm run test:e2e

# Cobertura completa
npm run test:coverage

# Suite completa
npm run test:all
```

---

# üöÄ **DEPLOYMENT Y CONFIGURACI√ìN**

## ‚öôÔ∏è **Variables de Entorno**

```env
# Supabase
VITE_SUPABASE_URL=https://your-project.supabase.co
VITE_SUPABASE_ANON_KEY=your-anon-key

# Features flags
VITE_ENABLE_CONFLICT_DETECTION=true
VITE_ENABLE_AVAILABILITY_SYSTEM=true
VITE_ENABLE_CRM_V2=true

# External APIs
VITE_SENDGRID_API_KEY=your-sendgrid-key
VITE_TWILIO_ACCOUNT_SID=your-twilio-sid
VITE_WHATSAPP_BUSINESS_API_KEY=your-whatsapp-key
```

## üì¶ **Scripts de Deployment**

```bash
# Desarrollo
npm run dev

# Desarrollo simplificado (para resolver MIME issues)
npm run dev:simple

# Build para producci√≥n
npm run build

# Preview del build
npm run preview

# Deploy a Vercel
vercel --prod
```

## üóÑÔ∏è **Migraciones de Base de Datos**

### **Orden de ejecuci√≥n:**
1. `20250215_006_complete_restaurant_ecosystem.sql` - Ecosystem b√°sico
2. `20250215_007_fix_crm_settings_table.sql` - Correcciones CRM
3. `20250215_010_availability_system_complete.sql` - Sistema disponibilidades

### **Comando para aplicar:**
```bash
cd supabase
supabase db push
```

---

# üìö **DOCUMENTACI√ìN ADICIONAL**

## üìñ **Documentos Espec√≠ficos**

### **T√©cnicos:**
- `DATABASE-MASTER-REFERENCE.md` - Esquema completo de BD
- `CRM-SISTEMA-INTELIGENTE-COMPLETO.md` - CRM en detalle
- `SECURITY-ENTERPRISE-CERTIFICATION.md` - Certificaci√≥n de seguridad

### **Usuario Final:**
- `MANUAL-USUARIO-COMPLETO.md` - Gu√≠a para restaurantes
- `PWA-GUIA-COMPLETA.md` - Instalaci√≥n y uso offline

### **Desarrollo:**
- `PERFORMANCE-OPTIMIZATION-COMPLETA.md` - Optimizaciones implementadas
- `IA-EXPANSION-COMPLETA.md` - Funcionalidades de IA

## üîß **APIs y Integraciones**

### **Webhooks N8N:**
- Endpoint: `/api/webhooks/n8n`
- Eventos: `reservation.completed`, `customer.updated`, `automation.triggered`
- Autenticaci√≥n: Bearer token

### **SendGrid Integration:**
- Templates din√°micos con variables
- Tracking de apertura y clicks
- Gesti√≥n de bounces y unsubscribes

### **Twilio/WhatsApp:**
- Mensajes multimedia
- Estados de entrega
- Webhooks de respuesta

---

# ‚ö†Ô∏è **ADVERTENCIAS CR√çTICAS**

## üö® **NO TOCAR SIN DOCUMENTAR:**

### **Componentes Cr√≠ticos:**
- ‚ùå `src/components/CustomerModal.jsx` (Funcionalidad base)
- ‚ùå `src/services/ConflictDetectionService.js` (L√≥gica de conflictos)
- ‚ùå `src/components/ReservationFormModal.jsx` (Validaci√≥n obligatoria)
- ‚ùå Estructura de `restaurants.settings` JSONB

### **Funciones RPC:**
- ‚ùå `generate_availability_slots` (Generaci√≥n masiva)
- ‚ùå `process_reservation_completion` (Triggers CRM)
- ‚ùå Pol√≠ticas RLS de seguridad

### **Flujos de Validaci√≥n:**
- ‚ùå Validaci√≥n obligatoria antes de crear reservas
- ‚ùå Detecci√≥n de conflictos antes de eliminar mesas
- ‚ùå Recalculaci√≥n autom√°tica de segmentos CRM

## ‚úÖ **ANTES DE MODIFICAR:**

1. **üìñ Leer** esta documentaci√≥n completa
2. **üß™ Probar** en entorno de desarrollo
3. **‚úÖ Ejecutar** suite de tests completa
4. **üìù Documentar** todos los cambios
5. **üîÑ Verificar** que no se rompe funcionalidad existente

---

# üéØ **PR√ìXIMOS PASOS Y ROADMAP**

## üîÆ **Mejoras Planificadas**

### **Corto Plazo:**
- **üìä Dashboard analytics** m√°s detallado
- **üîî Sistema de notificaciones** push
- **üì± App m√≥vil** nativa complementaria
- **ü§ñ IA m√°s avanzada** para predicciones

### **Medio Plazo:**
- **üåç Multi-idioma** completo
- **üí≥ Pagos integrados** en reservas
- **üìà ML avanzado** para optimizaci√≥n
- **üîó M√°s integraciones** (Google, Facebook, etc.)

### **Largo Plazo:**
- **üè¢ Multi-restaurante** para cadenas
- **üìä Business Intelligence** avanzado
- **ü§ñ Agente IA** completamente aut√≥nomo
- **üåê Marketplace** de plantillas y plugins

## üèóÔ∏è **Principios de Desarrollo Futuro**

### **1. Estabilidad Primero**
- Mantener funcionalidad cr√≠tica existente
- Cambios incrementales y bien testados
- Documentaci√≥n exhaustiva de cada cambio

### **2. Escalabilidad**
- Arquitectura preparada para crecimiento
- Performance optimizado desde el dise√±o
- Separaci√≥n clara de responsabilidades

### **3. Experiencia de Usuario**
- Interfaces intuitivas y consistentes
- Feedback inmediato y claro
- Prevenci√≥n proactiva de errores

---

# üìû **SOPORTE Y CONTACTO**

## üîß **Para Desarrolladores**

### **Recursos:**
- Esta documentaci√≥n maestra
- Comentarios inline en c√≥digo cr√≠tico
- Tests como documentaci√≥n viva
- Logs detallados en desarrollo

### **Proceso de Modificaciones:**
1. Crear branch espec√≠fico
2. Leer documentaci√≥n relevante
3. Implementar con tests
4. Actualizar documentaci√≥n
5. Code review exhaustivo
6. Deploy con monitoring

### **Escalaci√≥n de Issues:**
- **üü¢ Menor**: Bugs sin impacto funcional
- **üü° Medio**: Problemas que afectan UX
- **üî¥ Alto**: Fallos en funcionalidad cr√≠tica
- **‚ö´ Cr√≠tico**: Seguridad o p√©rdida de datos

---

**üìÖ √öltima actualizaci√≥n:** Febrero 2025  
**üë®‚Äçüíª Mantenido por:** Equipo LA-IA Development  
**üéØ Estado:** DOCUMENTACI√ìN COMPLETA Y ACTUALIZADA

---

> **üí° Recuerda:** Esta aplicaci√≥n maneja datos cr√≠ticos de restaurantes. Cada cambio debe ser cuidadosamente planificado, testado y documentado. La estabilidad y seguridad son prioritarias sobre nuevas funcionalidades.

