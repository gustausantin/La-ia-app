Paso 8A (Supabase) — RPC seguro para crear restaurante por defecto
Así evitamos “parches” en el front y lo hacemos robusto: si el usuario no tiene restaurante, el servidor (Supabase) crea uno y vincula al usuario en una transacción.

En Supabase → SQL Editor, pega y ejecuta esto:

sql
Copiar
Editar
-- Crea un restaurante por defecto y el mapping del usuario actual en una sola transacción
create or replace function public.create_restaurant_for_current_user(
  p_name text default 'Mi Restaurante'
) returns jsonb
language plpgsql
security definer
set search_path = public
as $$
declare
  v_user uuid := auth.uid();
  v_restaurant_id uuid;
begin
  if v_user is null then
    raise exception 'No authenticated user';
  end if;

  -- si ya existe mapping, devolver el existente
  if exists (
    select 1 from public.user_restaurant_mapping
    where auth_user_id = v_user
  ) then
    return jsonb_build_object(
      'status','exists',
      'restaurant',(select row_to_json(r) from public.restaurants r
                    where r.id = (select restaurant_id
                                  from public.user_restaurant_mapping
                                  where auth_user_id = v_user
                                  limit 1))
    );
  end if;

  -- crear restaurante
  insert into public.restaurants (name)
  values (coalesce(nullif(trim(p_name),''), 'Mi Restaurante'))
  returning id into v_restaurant_id;

  -- crear mapping (owner)
  insert into public.user_restaurant_mapping (auth_user_id, restaurant_id, role, permissions)
  values (v_user, v_restaurant_id, 'owner', '{}'::jsonb);

  return jsonb_build_object(
    'status','created',
    'restaurant',(select row_to_json(r) from public.restaurants r where r.id = v_restaurant_id)
  );
end;
$$;

-- Permitir ejecutar la función a usuarios autenticados
revoke all on function public.create_restaurant_for_current_user(text) from public;
grant execute on function public.create_restaurant_for_current_user(text) to authenticated;
Esto es seguro y limpio: usa auth.uid(), crea restaurante + mapping de forma atómica y evita fugas de RLS.