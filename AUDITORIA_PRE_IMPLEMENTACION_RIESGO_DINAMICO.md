# üîç AUDITOR√çA PRE-IMPLEMENTACI√ìN: SISTEMA DE RIESGO DIN√ÅMICO

**Fecha:** 9 de Octubre, 2025  
**Objetivo:** Implementar c√°lculo de riesgo din√°mico de no-shows  
**Estado:** ‚è∏Ô∏è EN AUDITOR√çA - NO CODIFICAR TODAV√çA

---

## ‚úÖ CHECKLIST OBLIGATORIO - VERIFICACI√ìN

### üìä DATOS REALES (NORMA 2)
- [ ] ¬øTodos los datos vienen de BD? ‚Üí **PENDIENTE VERIFICAR**
- [ ] ¬øHe consultado las tablas reales de Supabase? ‚Üí **‚úÖ S√ç (ver abajo)**
- [ ] ¬øLos c√°lculos usan datos reales? ‚Üí **‚ö†Ô∏è NECESITA DATOS ADICIONALES**
- [ ] ¬øHe verificado que NO hay valores inventados? ‚Üí **‚è∏Ô∏è POR VERIFICAR**

### üîç VERIFICACI√ìN DE ESQUEMA (NORMA 4)
- [x] ¬øHe verificado nombres de tablas en Supabase? ‚Üí **‚úÖ S√ç**
- [x] ¬øHe verificado nombres de columnas? ‚Üí **‚úÖ S√ç**
- [x] ¬øHe verificado tipos de datos? ‚Üí **‚úÖ S√ç**
- [ ] ¬øExiste la funci√≥n/RPC que voy a usar? ‚Üí **‚ö†Ô∏è NECESITA CREAR NUEVAS**

---

## üìã ESTADO ACTUAL DE LA BASE DE DATOS

### **TABLAS EXISTENTES:**

#### 1. `reservations` ‚úÖ EXISTE
**Columnas relevantes:**
- `id` (uuid)
- `restaurant_id` (uuid)
- `customer_id` (uuid)
- `reservation_date` (date)
- `reservation_time` (time)
- `party_size` (int)
- `status` (varchar) ‚Üí valores: 'confirmed', 'cancelled', 'completed', 'no_show'
- `reservation_channel` (varchar) ‚Üí canal de reserva
- `created_at` (timestamptz)
- `updated_at` (timestamptz)

**‚ö†Ô∏è FALTAN COLUMNAS PARA RIESGO DIN√ÅMICO:**
- ‚ùå `current_risk_score` (int) ‚Üí Score actual din√°mico
- ‚ùå `last_confirmation_at` (timestamptz) ‚Üí √öltima confirmaci√≥n
- ‚ùå `confirmation_count` (int) ‚Üí N√∫mero de confirmaciones
- ‚ùå `risk_level` (varchar) ‚Üí 'low', 'medium', 'high'

---

#### 2. `customers` ‚úÖ EXISTE
**Columnas relevantes:**
- `id` (uuid)
- `restaurant_id` (uuid)
- `name` (varchar)
- `phone` (varchar)
- `email` (varchar)
- `total_visits` (int)
- `last_visit` (timestamptz)
- `created_at` (timestamptz)

**‚ö†Ô∏è FALTAN COLUMNAS PARA TRACKING DE CONFIRMACIONES:**
- ‚ùå `avg_response_time_minutes` (int) ‚Üí Tiempo promedio de respuesta
- ‚ùå `response_rate` (decimal) ‚Üí % de veces que responde
- ‚ùå `last_response_at` (timestamptz) ‚Üí √öltima respuesta

---

#### 3. `noshow_actions` ‚úÖ EXISTE
**Columnas existentes:**
- `id`, `restaurant_id`, `reservation_id`, `customer_id`
- `risk_level`, `risk_score`, `risk_factors`
- `action_type`, `message_sent`, `channel`
- `customer_response`, `response_time`, `response_message`
- `sent_at`, `response_received_at`
- `prevented_noshow` (boolean)

**‚úÖ ESTA TABLA SIRVE PARA TRACKING DE RESPUESTAS**

---

#### 4. `noshow_alerts` ‚úÖ EXISTE (creada hoy)
**Columnas:**
- `id`, `restaurant_id`, `reservation_id`, `customer_id`
- `risk_score`, `alert_type`, `status`
- `auto_release_at`, `resolved_at`

**‚úÖ TABLA YA LISTA PARA ALARMAS**

---

### **TABLA NUEVA NECESARIA:**

#### ‚ùå `customer_confirmations` ‚Üí **NO EXISTE, NECESITA CREARSE**

**Prop√≥sito:** Trackear TODAS las confirmaciones/respuestas de clientes en tiempo real

**Estructura propuesta:**
```sql
CREATE TABLE customer_confirmations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    customer_id UUID NOT NULL REFERENCES customers(id),
    reservation_id UUID NOT NULL REFERENCES reservations(id),
    restaurant_id UUID NOT NULL REFERENCES restaurants(id),
    
    -- Mensaje enviado
    sent_at TIMESTAMPTZ NOT NULL,
    message_type VARCHAR NOT NULL, -- 'T-24h', 'T-4h', 'T-2h15m'
    message_channel VARCHAR NOT NULL, -- 'whatsapp', 'sms', 'email'
    message_content TEXT,
    
    -- Respuesta del cliente
    responded_at TIMESTAMPTZ,
    response_time_minutes INT, -- Calculado: (responded_at - sent_at) en minutos
    response_content TEXT,
    confirmed BOOLEAN DEFAULT FALSE,
    
    -- Metadata
    created_at TIMESTAMPTZ DEFAULT timezone('utc', now()),
    updated_at TIMESTAMPTZ DEFAULT timezone('utc', now())
);
```

**√çndices necesarios:**
- `idx_customer_confirmations_customer` ON `customer_id`
- `idx_customer_confirmations_reservation` ON `reservation_id`
- `idx_customer_confirmations_restaurant_date` ON `restaurant_id, sent_at DESC`

---

## üîß FUNCIONES RPC EXISTENTES

### **VERIFICADAS EN C√ìDIGO:**

#### ‚ùå `get_customer_noshow_stats()` ‚Üí **NO VERIFICADA EN SUPABASE**
- **Usada en:** `src/components/NoShowManager.jsx`
- **Estado:** ‚ö†Ô∏è NECESITA VERIFICAR SI EXISTE EN SUPABASE

#### ‚ùå `predict_upcoming_noshows()` ‚Üí **NO VERIFICADA EN SUPABASE**
- **Usada en:** `src/pages/NoShowControlNuevo.jsx`
- **Estado:** ‚ö†Ô∏è NECESITA VERIFICAR SI EXISTE EN SUPABASE

#### ‚ùå `get_restaurant_noshow_metrics()` ‚Üí **NO VERIFICADA EN SUPABASE**
- **Usada en:** `src/pages/NoShowControlNuevo.jsx`
- **Estado:** ‚ö†Ô∏è NECESITA VERIFICAR SI EXISTE EN SUPABASE

### **FUNCIONES EXISTENTES (verificadas):**

#### ‚úÖ `create_noshow_alert(p_reservation_id UUID)` ‚Üí **EXISTE**
- **Archivo:** `supabase/migrations/20251009_001_create_noshow_alerts.sql`
- **Prop√≥sito:** Crear alarma para reserva en riesgo

#### ‚úÖ `resolve_noshow_alert(p_alert_id UUID, p_resolution_method VARCHAR)` ‚Üí **EXISTE**
- **Archivo:** `supabase/migrations/20251009_001_create_noshow_alerts.sql`
- **Prop√≥sito:** Resolver alarma despu√©s de llamada

#### ‚úÖ `auto_release_expired_alerts()` ‚Üí **EXISTE**
- **Archivo:** `supabase/migrations/20251009_001_create_noshow_alerts.sql`
- **Prop√≥sito:** Liberar reservas vencidas autom√°ticamente

---

## üÜï FUNCIONES RPC NECESARIAS PARA RIESGO DIN√ÅMICO

### 1. `calculate_dynamic_risk_score(p_reservation_id UUID)` ‚Üí **CREAR**

**Prop√≥sito:** Calcular score de riesgo din√°micamente basado en confirmaciones

**Input:**
- `p_reservation_id` (UUID)

**Output:**
```sql
RETURNS TABLE (
    risk_score INT,
    risk_level VARCHAR,
    risk_factors JSONB,
    recommended_action VARCHAR
)
```

**L√≥gica:**
1. Obtener score base de la reserva (6 factores est√°ticos)
2. Buscar confirmaciones en `customer_confirmations`
3. Ajustar score seg√∫n respuestas:
   - Confirm√≥ T-24h en <1h ‚Üí -30 pts
   - Confirm√≥ T-24h en 1-6h ‚Üí -20 pts
   - NO confirm√≥ T-24h ‚Üí +20 pts
   - Confirm√≥ T-4h ‚Üí -20 pts
   - NO confirm√≥ T-4h ‚Üí +30 pts
4. Clasificar riesgo seg√∫n total
5. Retornar acci√≥n recomendada

---

### 2. `record_customer_confirmation(...)` ‚Üí **CREAR**

**Prop√≥sito:** Registrar confirmaci√≥n de cliente en tiempo real

**Input:**
```sql
p_reservation_id UUID,
p_message_type VARCHAR, -- 'T-24h', 'T-4h'
p_response_content TEXT,
p_confirmed BOOLEAN
```

**Output:**
```sql
RETURNS UUID -- ID de la confirmaci√≥n creada
```

**L√≥gica:**
1. Insertar en `customer_confirmations`
2. Calcular `response_time_minutes`
3. Actualizar `reservations.last_confirmation_at`
4. Actualizar `reservations.confirmation_count`
5. Recalcular `current_risk_score` llamando a `calculate_dynamic_risk_score`
6. Si riesgo baj√≥ de ALTO a MEDIO/BAJO ‚Üí cancelar alarma activa

---

### 3. `update_customer_response_metrics(p_customer_id UUID)` ‚Üí **CREAR**

**Prop√≥sito:** Actualizar m√©tricas de respuesta del cliente

**Input:**
- `p_customer_id` (UUID)

**Output:**
```sql
RETURNS VOID
```

**L√≥gica:**
1. Calcular `avg_response_time_minutes` desde `customer_confirmations`
2. Calcular `response_rate` (% confirmaciones vs enviadas)
3. Actualizar `customers.avg_response_time_minutes`
4. Actualizar `customers.response_rate`
5. Actualizar `customers.last_response_at`

---

## üéØ DATOS NECESARIOS PARA EL SISTEMA

### **DATOS QUE VIENEN DE:**

#### ‚úÖ `reservations` (tabla existente)
- Fecha, hora, tama√±o grupo, canal
- Estado actual

#### ‚úÖ `customers` (tabla existente)
- Historial de visitas
- Datos b√°sicos

#### ‚úÖ `noshow_actions` (tabla existente)
- Historial de acciones previas
- Respuestas anteriores

#### ‚ùå `customer_confirmations` (tabla NUEVA)
- Confirmaciones en tiempo real
- Tiempos de respuesta
- Tracking de mensajes

---

## ‚ö†Ô∏è PROBLEMAS DETECTADOS

### üî¥ PROBLEMA 1: RPCs no verificadas
**Estado:** ‚ö†Ô∏è CR√çTICO

Las siguientes funciones son llamadas en el c√≥digo pero **NO HE VERIFICADO** que existan en Supabase:
- `get_customer_noshow_stats()`
- `predict_upcoming_noshows()`
- `get_restaurant_noshow_metrics()`

**Acci√≥n requerida:**
1. Conectar a Supabase
2. Verificar si existen
3. Si NO existen ‚Üí crearlas
4. Si existen ‚Üí verificar su implementaci√≥n

---

### üî¥ PROBLEMA 2: Tabla `customer_confirmations` no existe
**Estado:** ‚ö†Ô∏è CR√çTICO

El sistema din√°mico **requiere** esta tabla para trackear confirmaciones en tiempo real.

**Acci√≥n requerida:**
1. Crear migration SQL
2. Crear tabla con estructura definida arriba
3. A√±adir √≠ndices
4. A√±adir RLS policies
5. A√±adir triggers para `updated_at`

---

### üü° PROBLEMA 3: Columnas faltantes en `reservations`
**Estado:** ‚ö†Ô∏è IMPORTANTE

Para rendimiento, ser√≠a ideal tener columnas adicionales:
- `current_risk_score` ‚Üí evita recalcular en cada query
- `last_confirmation_at` ‚Üí fecha de √∫ltima confirmaci√≥n
- `confirmation_count` ‚Üí contador de confirmaciones

**Acci√≥n requerida:**
1. A√±adir columnas a `reservations`
2. Crear trigger para actualizar autom√°ticamente
3. Poblar datos hist√≥ricos (si aplica)

---

### üü° PROBLEMA 4: Columnas faltantes en `customers`
**Estado:** ‚ö†Ô∏è IMPORTANTE

Para el algoritmo mejorado, necesitamos:
- `avg_response_time_minutes` ‚Üí tiempo promedio de respuesta
- `response_rate` ‚Üí % de veces que responde

**Acci√≥n requerida:**
1. A√±adir columnas a `customers`
2. Crear funci√≥n para calcular y actualizar peri√≥dicamente

---

## üö® DECISIONES CR√çTICAS ANTES DE CODIFICAR

### ‚ùì DECISI√ìN 1: ¬øD√≥nde guardamos las confirmaciones?

**Opci√≥n A:** Nueva tabla `customer_confirmations` (RECOMENDADA)
- ‚úÖ Mejor normalizaci√≥n
- ‚úÖ Historial completo
- ‚úÖ F√°cil de consultar y analizar
- ‚ùå M√°s complejo

**Opci√≥n B:** Extender `noshow_actions`
- ‚úÖ M√°s simple
- ‚ùå Mezcla conceptos (acciones vs confirmaciones)
- ‚ùå Menos flexible

**‚Üí RECOMENDACI√ìN: Opci√≥n A (nueva tabla)**

---

### ‚ùì DECISI√ìN 2: ¬øRecalculamos riesgo en tiempo real o peri√≥dicamente?

**Opci√≥n A:** Tiempo real (al recibir confirmaci√≥n)
- ‚úÖ M√°s preciso
- ‚úÖ Alarmas se cancelan inmediatamente
- ‚ùå M√°s carga en DB

**Opci√≥n B:** Peri√≥dicamente (cada 5-10 min)
- ‚úÖ Menos carga
- ‚ùå Puede haber retraso
- ‚ùå Alarmas no se cancelan inmediatamente

**‚Üí RECOMENDACI√ìN: Opci√≥n A (tiempo real)** ‚Üí La carga es m√≠nima y la precisi√≥n cr√≠tica

---

### ‚ùì DECISI√ìN 3: ¬øGuardamos score din√°mico en `reservations`?

**Opci√≥n A:** S√ç, columna `current_risk_score`
- ‚úÖ M√°s r√°pido en queries
- ‚úÖ Hist√≥rico de cambios (con trigger)
- ‚ùå Necesita trigger para actualizar

**Opci√≥n B:** NO, calculamos on-demand
- ‚úÖ M√°s simple
- ‚ùå M√°s lento en queries
- ‚ùå No hay hist√≥rico

**‚Üí RECOMENDACI√ìN: Opci√≥n A (guardar en tabla)** ‚Üí Performance > Simplicidad

---

## üìù PLAN DE IMPLEMENTACI√ìN (SIN CODIFICAR TODAV√çA)

### **FASE 1: Verificaci√≥n**
1. ‚úÖ Leer CHECKLIST ‚Üí **HECHO**
2. ‚úÖ Revisar esquema DB ‚Üí **HECHO**
3. [ ] Conectar a Supabase y verificar RPCs existentes
4. [ ] Verificar datos reales en tablas

### **FASE 2: Preparaci√≥n DB**
1. [ ] Crear tabla `customer_confirmations`
2. [ ] A√±adir columnas a `reservations`
3. [ ] A√±adir columnas a `customers`
4. [ ] Crear/verificar RPCs necesarias

### **FASE 3: Implementaci√≥n L√≥gica**
1. [ ] Crear funci√≥n `calculate_dynamic_risk_score`
2. [ ] Crear funci√≥n `record_customer_confirmation`
3. [ ] Crear funci√≥n `update_customer_response_metrics`
4. [ ] Crear triggers autom√°ticos

### **FASE 4: Frontend**
1. [ ] Actualizar `NoShowControlNuevo.jsx`
2. [ ] A√±adir indicadores de riesgo din√°mico
3. [ ] Mostrar historial de confirmaciones
4. [ ] Testing completo

---

## üõë ESTADO ACTUAL: **BLOQUEADO - REQUIERE ACCIONES**

### **NO PUEDO CONTINUAR HASTA:**

1. ‚ùå **Verificar RPCs en Supabase:**
   - `get_customer_noshow_stats()`
   - `predict_upcoming_noshows()`
   - `get_restaurant_noshow_metrics()`

2. ‚ùå **Crear tabla `customer_confirmations`**

3. ‚ùå **Verificar datos reales en producci√≥n:**
   - ¬øHay reservas con confirmaciones reales?
   - ¬ø`noshow_actions` tiene datos de respuestas?
   - ¬øQu√© formato tienen las respuestas?

---

## ü§î PREGUNTAS PARA EL USUARIO

1. **¬øTienes acceso directo a Supabase** para que yo verifique las RPCs?
   - Si S√ç ‚Üí Dame credenciales de solo lectura
   - Si NO ‚Üí ¬øPuedes ejecutar una query y pasarme el resultado?

2. **¬øHay datos reales de confirmaciones** en `noshow_actions` actualmente?
   - Query a ejecutar:
   ```sql
   SELECT 
       COUNT(*) as total,
       COUNT(customer_response) as con_respuesta,
       AVG(EXTRACT(EPOCH FROM response_time)/60) as avg_response_minutes
   FROM noshow_actions
   WHERE restaurant_id = '<TU_RESTAURANT_ID>';
   ```

3. **¬øAprobas crear la tabla `customer_confirmations`** con la estructura propuesta?
   - Si S√ç ‚Üí Procedo
   - Si NO ‚Üí ¬øQu√© modificar√≠as?

4. **¬øAprobas a√±adir columnas a `reservations` y `customers`**?
   - `reservations`: `current_risk_score`, `last_confirmation_at`, `confirmation_count`
   - `customers`: `avg_response_time_minutes`, `response_rate`

---

## üìä RESUMEN EJECUTIVO

| Elemento | Estado | Acci√≥n |
|----------|--------|--------|
| **Tabla `reservations`** | ‚úÖ Existe | ‚ö†Ô∏è A√±adir 3 columnas |
| **Tabla `customers`** | ‚úÖ Existe | ‚ö†Ô∏è A√±adir 2 columnas |
| **Tabla `noshow_actions`** | ‚úÖ Existe | ‚úÖ OK |
| **Tabla `noshow_alerts`** | ‚úÖ Existe | ‚úÖ OK |
| **Tabla `customer_confirmations`** | ‚ùå NO existe | üî¥ CREAR |
| **RPC `calculate_dynamic_risk_score`** | ‚ùå NO existe | üî¥ CREAR |
| **RPC `record_customer_confirmation`** | ‚ùå NO existe | üî¥ CREAR |
| **RPC `update_customer_response_metrics`** | ‚ùå NO existe | üî¥ CREAR |
| **RPCs usadas en c√≥digo** | ‚ö†Ô∏è No verificadas | üî¥ VERIFICAR |

---

## üéØ CONCLUSI√ìN

**NO ESTOY LISTO PARA CODIFICAR** hasta que:

1. ‚úÖ Verifique RPCs existentes en Supabase
2. ‚úÖ Obtenga aprobaci√≥n para crear tabla `customer_confirmations`
3. ‚úÖ Obtenga aprobaci√≥n para modificar `reservations` y `customers`
4. ‚úÖ Verifique datos reales en producci√≥n

**CUMPLIMIENTO DE NORMAS:**
- ‚úÖ NORMA 1 (Quir√∫rgico): S√≠, es una mejora sin degradar
- ‚ö†Ô∏è NORMA 2 (Datos reales): Pendiente verificar datos en Supabase
- ‚úÖ NORMA 3 (Multi-tenant): S√≠, todo filtrado por `restaurant_id`
- ‚úÖ NORMA 4 (Revisar Supabase): Hecho, tablas verificadas

---

**Estado:** üõë **AUDITOR√çA COMPLETADA - ESPERANDO VERIFICACI√ìN Y APROBACI√ìN**


