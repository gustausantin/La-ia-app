{
  "name": "01 - VOZ PROFESIONAL: Twilio â†’ Google TTS â†’ Agent",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "voice-stream",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-incoming",
      "name": "ğŸ“ Llamada Entrante",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 300]
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "restaurants",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "active",
              "keyValue": true
            }
          ]
        }
      },
      "id": "get-all-restaurants",
      "name": "ğŸª Buscar Restaurantes",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [460, 300],
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const restaurants = $input.all();\nconst calledNumber = $('ğŸ“ Llamada Entrante').first().json.body.Called;\n\nfor (const r of restaurants) {\n  const settings = r.json.settings || {};\n  const channels = settings.channels || {};\n  const voiceNumber = channels.vapi?.voice_number || channels.voice?.phone_number;\n  \n  if (voiceNumber === calledNumber) {\n    return r.json;\n  }\n}\n\nthrow new Error('Restaurante no encontrado para: ' + calledNumber);"
      },
      "id": "filter-restaurant",
      "name": "ğŸ” Filtrar Restaurante",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [680, 300]
    },
    {
      "parameters": {
        "jsCode": "const webhook = $('ğŸ“ Llamada Entrante').first().json.body;\nconst restaurant = $input.first().json;\n\nconst settings = restaurant.settings || {};\nconst agent = settings.agent || {};\nconst agentName = agent.name || 'Daniela';\nconst agentGender = agent.gender || 'female';\nconst restaurantName = restaurant.name || 'el restaurante';\n\n// ğŸ™ï¸ Mapeo de voces Google Cloud TTS (calidad superior)\n// https://cloud.google.com/text-to-speech/docs/voices\nconst voiceConfig = agentGender === 'male' \n  ? { name: 'es-ES-Neural2-B', gender: 'MALE' }  // Voz masculina profesional\n  : { name: 'es-ES-Neural2-A', gender: 'FEMALE' }; // Voz femenina cÃ¡lida\n\nconst welcomeMessage = `Hola, bienvenido a ${restaurantName}. Soy ${agentName}, Â¿en quÃ© puedo ayudarte?`;\n\nreturn {\n  welcome_message: welcomeMessage,\n  voice_name: voiceConfig.name,\n  voice_gender: voiceConfig.gender,\n  call_sid: webhook.CallSid,\n  restaurant_id: restaurant.id,\n  restaurant_name: restaurantName,\n  agent_name: agentName,\n  caller_phone: webhook.From\n};"
      },
      "id": "prepare-welcome",
      "name": "ğŸ“ Preparar Bienvenida",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://texttospeech.googleapis.com/v1/text:synthesize",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleServiceAccountApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"input\": {\n    \"text\": \"{{ $json.welcome_message }}\"\n  },\n  \"voice\": {\n    \"languageCode\": \"es-ES\",\n    \"name\": \"{{ $json.voice_name }}\",\n    \"ssmlGender\": \"{{ $json.voice_gender }}\"\n  },\n  \"audioConfig\": {\n    \"audioEncoding\": \"MP3\",\n    \"speakingRate\": 1.0,\n    \"pitch\": 0.0\n  }\n}",
        "options": {}
      },
      "id": "tts-welcome-google",
      "name": "ğŸ”Š TTS Bienvenida (Google)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1120, 300],
      "credentials": {
        "googleServiceAccountApi": {
          "id": "YOUR_GOOGLE_SERVICE_ACCOUNT_ID",
          "name": "Google Cloud TTS"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst audioContent = response.audioContent;\n\n// Convertir base64 a binary\nreturn {\n  json: {},\n  binary: {\n    data: {\n      data: audioContent,\n      mimeType: 'audio/mp3',\n      fileName: 'welcome.mp3'\n    }\n  }\n};"
      },
      "id": "convert-audio-welcome",
      "name": "ğŸ”„ Convertir Audio Bienvenida",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.cloudinary.com/v1_1/{{ $env.CLOUDINARY_CLOUD_NAME }}/upload",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "file",
              "value": "={{ 'data:audio/mp3;base64,' + $binary.data.data }}"
            },
            {
              "name": "upload_preset",
              "value": "{{ $env.CLOUDINARY_UPLOAD_PRESET }}"
            },
            {
              "name": "resource_type",
              "value": "video"
            }
          ]
        }
      },
      "id": "upload-audio",
      "name": "â˜ï¸ Upload Audio",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "jsCode": "const uploadResponse = $input.first().json;\nconst prepareData = $('ğŸ“ Preparar Bienvenida').first().json;\n\nconst audioUrl = uploadResponse.secure_url;\n\nconst twiml = `<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<Response>\n    <Play>${audioUrl}</Play>\n    <Record \n        action=\"https://gustausantin.app.n8n.cloud/webhook-test/voice-transcript\"\n        method=\"POST\"\n        maxLength=\"30\"\n        timeout=\"3\"\n        transcribe=\"true\"\n        transcribeCallback=\"https://gustausantin.app.n8n.cloud/webhook-test/voice-transcript\"\n    />\n</Response>`;\n\nreturn {\n  twiml: twiml,\n  call_sid: prepareData.call_sid,\n  restaurant_id: prepareData.restaurant_id\n};"
      },
      "id": "generate-twiml",
      "name": "ğŸ“„ Generar TwiML",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1780, 300]
    },
    {
      "parameters": {
        "respondWith": "text",
        "responseBody": "={{ $json.twiml }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "text/xml"
              }
            ]
          }
        }
      },
      "id": "respond-webhook",
      "name": "âœ… Contestar Llamada",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [2000, 300]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "voice-transcript",
        "options": {}
      },
      "id": "webhook-transcript",
      "name": "ğŸ¤ TranscripciÃ³n Lista",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [240, 520]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json.body;\n\nreturn {\n  transcript: data.TranscriptionText || '',\n  call_sid: data.CallSid,\n  restaurant_phone: data.Called,\n  caller_phone: data.From\n};"
      },
      "id": "parse-transcript",
      "name": "ğŸ“„ Extraer Texto",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 520]
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "restaurants",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "active",
              "keyValue": true
            }
          ]
        }
      },
      "id": "get-restaurants-2",
      "name": "ğŸª Buscar Restaurantes",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [680, 520],
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const restaurants = $input.all();\nconst calledNumber = $('ğŸ“„ Extraer Texto').first().json.restaurant_phone;\n\nfor (const r of restaurants) {\n  const settings = r.json.settings || {};\n  const channels = settings.channels || {};\n  const voiceNumber = channels.vapi?.voice_number || channels.voice?.phone_number;\n  \n  if (voiceNumber === calledNumber) {\n    return r.json;\n  }\n}\n\nthrow new Error('Restaurante no encontrado');"
      },
      "id": "filter-restaurant-2",
      "name": "ğŸ” Identificar Restaurante",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 520]
    },
    {
      "parameters": {
        "jsCode": "const transcript = $('ğŸ“„ Extraer Texto').first().json;\nconst restaurant = $input.first().json;\n\nreturn {\n  customer_phone: transcript.caller_phone,\n  customer_name: 'Cliente',\n  restaurant_id: restaurant.id,\n  message_text: transcript.transcript,\n  channel: 'voice',\n  timestamp: new Date().toISOString()\n};"
      },
      "id": "prepare-gateway",
      "name": "ğŸ”— Preparar Gateway",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 520]
    },
    {
      "parameters": {
        "workflowId": "={{ $parameter.workflowId }}",
        "options": {}
      },
      "id": "execute-gateway",
      "name": "ğŸšª Gateway â†’ Agent",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.1,
      "position": [1340, 520],
      "notes": "ID del workflow 2-GATEWAY-FINAL-IMPORTAR"
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst agentText = response.agent_response?.output || response.response || 'Lo siento, no pude procesar tu solicitud.';\nconst restaurant = $('ğŸ” Identificar Restaurante').first().json;\n\nconst settings = restaurant.settings || {};\nconst agent = settings.agent || {};\nconst agentGender = agent.gender || 'female';\n\n// Configurar voz Google Cloud TTS para la respuesta\nconst voiceConfig = agentGender === 'male' \n  ? { name: 'es-ES-Neural2-B', gender: 'MALE' }\n  : { name: 'es-ES-Neural2-A', gender: 'FEMALE' };\n\nreturn {\n  text: agentText,\n  call_sid: $('ğŸ“„ Extraer Texto').first().json.call_sid,\n  restaurant_id: $('ğŸ”— Preparar Gateway').first().json.restaurant_id,\n  voice_name: voiceConfig.name,\n  voice_gender: voiceConfig.gender\n};"
      },
      "id": "extract-response",
      "name": "ğŸ’¬ Respuesta Agent",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 520]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://texttospeech.googleapis.com/v1/text:synthesize",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "googleServiceAccountApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"input\": {\n    \"text\": \"{{ $json.text }}\"\n  },\n  \"voice\": {\n    \"languageCode\": \"es-ES\",\n    \"name\": \"{{ $json.voice_name }}\",\n    \"ssmlGender\": \"{{ $json.voice_gender }}\"\n  },\n  \"audioConfig\": {\n    \"audioEncoding\": \"MP3\",\n    \"speakingRate\": 1.0,\n    \"pitch\": 0.0\n  }\n}",
        "options": {}
      },
      "id": "tts-response-google",
      "name": "ğŸ”Š TTS Respuesta (Google)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1780, 520],
      "credentials": {
        "googleServiceAccountApi": {
          "id": "YOUR_GOOGLE_SERVICE_ACCOUNT_ID",
          "name": "Google Cloud TTS"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const response = $input.first().json;\nconst audioContent = response.audioContent;\nconst callSid = $('ğŸ’¬ Respuesta Agent').first().json.call_sid;\n\n// Convertir base64 a binary\nreturn {\n  json: {\n    call_sid: callSid\n  },\n  binary: {\n    data: {\n      data: audioContent,\n      mimeType: 'audio/mp3',\n      fileName: 'response.mp3'\n    }\n  }\n};"
      },
      "id": "convert-audio-response",
      "name": "ğŸ”„ Convertir Audio Respuesta",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2000, 520]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.cloudinary.com/v1_1/{{ $env.CLOUDINARY_CLOUD_NAME }}/upload",
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "name": "file",
              "value": "={{ 'data:audio/mp3;base64,' + $binary.data.data }}"
            },
            {
              "name": "upload_preset",
              "value": "{{ $env.CLOUDINARY_UPLOAD_PRESET }}"
            },
            {
              "name": "resource_type",
              "value": "video"
            }
          ]
        }
      },
      "id": "upload-response",
      "name": "â˜ï¸ Upload Respuesta",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2220, 520]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://api.twilio.com/2010-04-01/Accounts/{{ $env.TWILIO_ACCOUNT_SID }}/Calls/{{ $('ğŸ”„ Convertir Audio Respuesta').item.json.call_sid }}.json",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "specifyBody": "keypair",
        "bodyParameters": {
          "parameters": [
            {
              "name": "Twiml",
              "value": "=<Response><Play>{{ $json.secure_url }}</Play><Hangup/></Response>"
            }
          ]
        }
      },
      "id": "update-call",
      "name": "ğŸ“² Responder Cliente",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2440, 520],
      "credentials": {
        "httpBasicAuth": {
          "id": "twilio-auth",
          "name": "Twilio Auth"
        }
      }
    }
  ],
  "connections": {
    "ğŸ“ Llamada Entrante": {
      "main": [[{"node": "ğŸª Buscar Restaurantes", "type": "main", "index": 0}]]
    },
    "ğŸª Buscar Restaurantes": {
      "main": [[{"node": "ğŸ” Filtrar Restaurante", "type": "main", "index": 0}]]
    },
    "ğŸ” Filtrar Restaurante": {
      "main": [[{"node": "ğŸ“ Preparar Bienvenida", "type": "main", "index": 0}]]
    },
    "ğŸ“ Preparar Bienvenida": {
      "main": [[{"node": "ğŸ”Š TTS Bienvenida (Google)", "type": "main", "index": 0}]]
    },
    "ğŸ”Š TTS Bienvenida (Google)": {
      "main": [[{"node": "ğŸ”„ Convertir Audio Bienvenida", "type": "main", "index": 0}]]
    },
    "ğŸ”„ Convertir Audio Bienvenida": {
      "main": [[{"node": "â˜ï¸ Upload Audio", "type": "main", "index": 0}]]
    },
    "â˜ï¸ Upload Audio": {
      "main": [[{"node": "ğŸ“„ Generar TwiML", "type": "main", "index": 0}]]
    },
    "ğŸ“„ Generar TwiML": {
      "main": [[{"node": "âœ… Contestar Llamada", "type": "main", "index": 0}]]
    },
    "ğŸ¤ TranscripciÃ³n Lista": {
      "main": [[{"node": "ğŸ“„ Extraer Texto", "type": "main", "index": 0}]]
    },
    "ğŸ“„ Extraer Texto": {
      "main": [[{"node": "ğŸª Buscar Restaurantes", "type": "main", "index": 0}]]
    },
    "ğŸª Buscar Restaurantes": {
      "main": [[{"node": "ğŸ” Identificar Restaurante", "type": "main", "index": 0}]]
    },
    "ğŸ” Identificar Restaurante": {
      "main": [[{"node": "ğŸ”— Preparar Gateway", "type": "main", "index": 0}]]
    },
    "ğŸ”— Preparar Gateway": {
      "main": [[{"node": "ğŸšª Gateway â†’ Agent", "type": "main", "index": 0}]]
    },
    "ğŸšª Gateway â†’ Agent": {
      "main": [[{"node": "ğŸ’¬ Respuesta Agent", "type": "main", "index": 0}]]
    },
    "ğŸ’¬ Respuesta Agent": {
      "main": [[{"node": "ğŸ”Š TTS Respuesta (Google)", "type": "main", "index": 0}]]
    },
    "ğŸ”Š TTS Respuesta (Google)": {
      "main": [[{"node": "ğŸ”„ Convertir Audio Respuesta", "type": "main", "index": 0}]]
    },
    "ğŸ”„ Convertir Audio Respuesta": {
      "main": [[{"node": "â˜ï¸ Upload Respuesta", "type": "main", "index": 0}]]
    },
    "â˜ï¸ Upload Respuesta": {
      "main": [[{"node": "ğŸ“² Responder Cliente", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "meta": {
    "instanceId": "968c65341fc947850f62b4a42d249947219a244717952c0dbaf2b62952e73bd9"
  }
}


