{
  "name": "03 - Recordatorio 4h (CON VERIFICACIÓN) ✅",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "0 */2 * * *"
            }
          ]
        }
      },
      "id": "87d9ee29-5029-4fc4-98ff-4543ba25223d",
      "name": "⏰ Cron Cada 2 Horas",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -2016,
        816
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "reservations",
        "returnAll": true
      },
      "id": "48e4e133-81c8-4560-aa96-33baece19350",
      "name": "📊 Obtener TODAS las Reservas",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -1776,
        816
      ],
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const now = new Date();\nconst in4Hours = new Date(now.getTime() + 4 * 60 * 60 * 1000);\nconst in24Hours = new Date(now.getTime() + 24 * 60 * 60 * 1000);\n\nconst filtered = $input.all().filter(item => {\n  const data = item.json;\n  if (!data.reservation_date || !data.reservation_time) return false;\n  \n  const reservationDateTime = new Date(`${data.reservation_date}T${data.reservation_time}`);\n  \n  return reservationDateTime >= in4Hours &&\n         reservationDateTime <= in24Hours &&\n         data.status === 'pending' &&\n         data.customer_phone !== null &&\n         data.customer_phone !== '';\n});\n\nconsole.log(`🔍 Encontradas ${filtered.length} reservas en 4-24h`);\n\nreturn filtered;"
      },
      "id": "0fa54462-f859-4903-94d6-27bbf65135dc",
      "name": "🔍 Filtrar: 4-24h + Pending",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -1536,
        816
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $input.all().length }}",
              "value2": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "07239649-2e68-4ad3-972e-2fae7abce9b2",
      "name": "❓ ¿Hay Reservas?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -1344,
        816
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "e91fa27f-d443-4e01-a4a8-95db85454ff6",
      "name": "🔁 Loop Cada Reserva",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -1072,
        608
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://ktsqwvhqamedpmzkzjaz.supabase.co/rest/v1/rpc/check_confirmation_sent",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"p_reservation_id\": \"{{ $json.id }}\",\n  \"p_message_type\": \"4h\"\n}",
        "options": {}
      },
      "id": "check-duplicate-4h",
      "name": "🔍 Verificar Si Ya Enviado",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -848,
        608
      ],
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      },
      "notes": "✅ Verifica duplicados vía RPC"
    },
    {
      "parameters": {
        "jsCode": "const reservation = $('🔁 Loop Cada Reserva').first().json;\nconst checkResult = $input.first().json;\n\nconst alreadySent = checkResult === true;\n\nconsole.log(`🔍 Reserva ${reservation.id}: ${alreadySent ? '⚠️ YA ENVIADO' : '✅ PENDIENTE DE ENVIAR'}`);\n\nreturn {\n  ...reservation,\n  already_sent: alreadySent,\n  should_send: !alreadySent\n};"
      },
      "id": "process-check-4h",
      "name": "🔄 Procesar Verificación",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -624,
        608
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "should-send",
              "leftValue": "={{ $json.should_send }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-should-send-4h",
      "name": "❓ ¿Enviar Mensaje?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -400,
        608
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nconst results = items.map(item => {\n  const data = item.json;\n  let phone = data.customer_phone || '';\n  \n  if (phone && !phone.startsWith('+')) {\n    if (phone.startsWith('34')) {\n      phone = '+' + phone;\n    } else if (phone.startsWith('0034')) {\n      phone = '+' + phone.substring(2);\n    } else {\n      phone = '+34' + phone;\n    }\n  }\n  \n  return {\n    json: {\n      ...data,\n      customer_phone_normalized: phone\n    }\n  };\n});\n\nreturn results;"
      },
      "id": "e4cc417f-51dd-4ea1-b02c-531889b469f1",
      "name": "📞 Normalizar Teléfono",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -176,
        528
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "restaurants",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.restaurant_id }}"
            }
          ]
        }
      },
      "id": "42e9ce29-8ec0-41ee-838e-8daf0c549077",
      "name": "📍 Obtener Config Restaurante",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        16,
        528
      ],
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "message_templates",
        "filters": {
          "conditions": [
            {
              "keyName": "restaurant_id",
              "keyValue": "={{ $('📍 Obtener Config Restaurante').first().json.id }}"
            },
            {
              "keyName": "category",
              "keyValue": "confirmacion_4h"
            },
            {
              "keyName": "is_active",
              "keyValue": "true"
            }
          ]
        }
      },
      "id": "a86d27d8-4de4-4c06-a724-17370f153cf9",
      "name": "📄 Obtener Plantilla 4h",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        208,
        528
      ],
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const templateData = $json;\nconst restaurantData = $('📍 Obtener Config Restaurante').first().json;\nconst reservaData = $('📞 Normalizar Teléfono').first().json;\n\nif (!reservaData || !restaurantData) {\n  throw new Error('❌ Faltan datos de reserva o restaurante');\n}\n\nconst reserva = reservaData;\nconst restaurant = restaurantData;\n\nlet template = templateData?.content_markdown || '';\n\nif (!template || template.trim() === '') {\n  template = `🚨 RECORDATORIO URGENTE 🚨\\n\\nHola {{customer_name}}!\\n\\nTu reserva en {{restaurant_name}} es en pocas horas a las {{reservation_time}} para {{party_size}} persona(s).\\n\\n¡Te esperamos pronto!`;\n}\n\nconst variables = {\n  customer_name: reserva.customer_name || 'Cliente',\n  restaurant_name: restaurant.name || 'Restaurante',\n  reservation_time: reserva.reservation_time || '',\n  party_size: (reserva.party_size || 1).toString()\n};\n\nlet message = template;\nfor (const [key, value] of Object.entries(variables)) {\n  const regex = new RegExp(`\\\\{\\\\{${key}\\\\}\\\\}`, 'g');\n  message = message.replace(regex, value);\n}\n\nif (!message || message.trim() === '') {\n  message = `🚨 Hola ${variables.customer_name}! Tu reserva en ${variables.restaurant_name} es HOY a las ${variables.reservation_time}. ¡Te esperamos!`;\n}\n\nreturn [{\n  json: {\n    id: reserva.id,\n    restaurant_id: reserva.restaurant_id,\n    customer_id: reserva.customer_id,\n    customer_name: reserva.customer_name,\n    customer_phone: reserva.customer_phone,\n    customer_phone_normalized: reserva.customer_phone_normalized,\n    reservation_date: reserva.reservation_date,\n    reservation_time: reserva.reservation_time,\n    party_size: reserva.party_size,\n    status: reserva.status,\n    restaurant_phone: restaurant.phone,\n    restaurant_name: restaurant.name,\n    message_final: message\n  }\n}];"
      },
      "id": "b0f8c3d2-81d6-40fc-84ae-399d7cd27d0b",
      "name": "🔄 Reemplazar Variables",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        400,
        528
      ]
    },
    {
      "parameters": {
        "from": "={{ $json.restaurant_phone }}",
        "to": "={{ $json.customer_phone_normalized }}",
        "toWhatsapp": true,
        "message": "={{ $json.message_final }}",
        "options": {}
      },
      "id": "fd96261e-a8ef-4e92-a92a-9c4f7fb3cc78",
      "name": "📱 Twilio: Enviar WhatsApp",
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [
        592,
        528
      ],
      "credentials": {
        "twilioApi": {
          "id": "KZF7OfG2zH2XYZAQ",
          "name": "Twilio account"
        }
      }
    },
    {
      "parameters": {
        "operation": "create",
        "tableId": "confirmation_messages",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "reservation_id",
              "fieldValue": "={{ $('🔄 Reemplazar Variables').first().json.id }}"
            },
            {
              "fieldId": "restaurant_id",
              "fieldValue": "={{ $('🔄 Reemplazar Variables').first().json.restaurant_id }}"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "4h"
            },
            {
              "fieldId": "status",
              "fieldValue": "sent"
            },
            {
              "fieldId": "customer_phone",
              "fieldValue": "={{ $('🔄 Reemplazar Variables').first().json.customer_phone_normalized }}"
            },
            {
              "fieldId": "customer_name",
              "fieldValue": "={{ $('🔄 Reemplazar Variables').first().json.customer_name }}"
            },
            {
              "fieldId": "reservation_date",
              "fieldValue": "={{ $('🔄 Reemplazar Variables').first().json.reservation_date }}"
            },
            {
              "fieldId": "reservation_time",
              "fieldValue": "={{ $('🔄 Reemplazar Variables').first().json.reservation_time }}"
            },
            {
              "fieldId": "message_content",
              "fieldValue": "={{ $('🔄 Reemplazar Variables').first().json.message_final }}"
            }
          ]
        },
        "options": {}
      },
      "id": "4b97b15d-9235-4fb6-a980-eec18a707ae8",
      "name": "💾 Registrar en confirmation_messages",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        784,
        528
      ],
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      },
      "notes": "✅ Registro en la tabla del nuevo sistema"
    },
    {
      "parameters": {
        "jsCode": "console.log('✅ Mensaje 4h enviado y registrado');\nreturn { success: true };"
      },
      "id": "log-sent-4h",
      "name": "✅ Log: Enviado",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        976,
        528
      ]
    },
    {
      "parameters": {
        "jsCode": "console.log('⚠️ Mensaje ya enviado anteriormente - Saltando');\nreturn { skipped: true };"
      },
      "id": "log-skipped-4h",
      "name": "⚠️ Log: Saltado",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -176,
        688
      ]
    },
    {
      "parameters": {},
      "id": "c5d223e0-cb78-470d-b789-3f73a5f71bbc",
      "name": "✅ Fin: Sin Reservas",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -1056,
        1056
      ]
    }
  ],
  "connections": {
    "⏰ Cron Cada 2 Horas": {
      "main": [
        [
          {
            "node": "📊 Obtener TODAS las Reservas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "📊 Obtener TODAS las Reservas": {
      "main": [
        [
          {
            "node": "🔍 Filtrar: 4-24h + Pending",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "🔍 Filtrar: 4-24h + Pending": {
      "main": [
        [
          {
            "node": "❓ ¿Hay Reservas?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "❓ ¿Hay Reservas?": {
      "main": [
        [
          {
            "node": "🔁 Loop Cada Reserva",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "✅ Fin: Sin Reservas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "🔁 Loop Cada Reserva": {
      "main": [
        [],
        [
          {
            "node": "🔍 Verificar Si Ya Enviado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "🔍 Verificar Si Ya Enviado": {
      "main": [
        [
          {
            "node": "🔄 Procesar Verificación",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "🔄 Procesar Verificación": {
      "main": [
        [
          {
            "node": "❓ ¿Enviar Mensaje?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "❓ ¿Enviar Mensaje?": {
      "main": [
        [
          {
            "node": "📞 Normalizar Teléfono",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "⚠️ Log: Saltado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "📞 Normalizar Teléfono": {
      "main": [
        [
          {
            "node": "📍 Obtener Config Restaurante",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "📍 Obtener Config Restaurante": {
      "main": [
        [
          {
            "node": "📄 Obtener Plantilla 4h",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "📄 Obtener Plantilla 4h": {
      "main": [
        [
          {
            "node": "🔄 Reemplazar Variables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "🔄 Reemplazar Variables": {
      "main": [
        [
          {
            "node": "📱 Twilio: Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "📱 Twilio: Enviar WhatsApp": {
      "main": [
        [
          {
            "node": "💾 Registrar en confirmation_messages",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "💾 Registrar en confirmation_messages": {
      "main": [
        [
          {
            "node": "✅ Log: Enviado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "✅ Log: Enviado": {
      "main": [
        [
          {
            "node": "🔁 Loop Cada Reserva",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "⚠️ Log: Saltado": {
      "main": [
        [
          {
            "node": "🔁 Loop Cada Reserva",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "instanceId": "968c65341fc947850f62b4a42d249947219a244717952c0dbaf2b62952e73bd9"
  },
  "tags": [
    {
      "createdAt": "2025-10-22T19:00:00.000Z",
      "updatedAt": "2025-10-22T19:00:00.000Z",
      "id": "recordatorio-4h-verificacion",
      "name": "✅ Con Verificación de Duplicados"
    }
  ]
}
