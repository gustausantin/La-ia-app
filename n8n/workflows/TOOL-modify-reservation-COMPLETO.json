{
  "name": "ğŸ”§ TOOL: modify_reservation â€” COMPLETO",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [-1200, 240],
      "id": "start-node",
      "name": "â–¶ï¸ Start"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\n\nconsole.log('ğŸ” Input recibido:', JSON.stringify(input, null, 2));\n\n// âœ… Validar datos mÃ­nimos para BUSCAR la reserva\nconst required = ['restaurant_id', 'customer_id'];\nconst missing = required.filter(field => !input[field]);\n\nif (missing.length > 0) {\n  throw new Error(`âŒ Faltan campos obligatorios: ${missing.join(', ')}`);\n}\n\n// Al menos uno de estos campos debe estar presente para modificar\nif (!input.new_date && !input.new_time && !input.new_party_size) {\n  throw new Error('âŒ Debes proporcionar al menos un campo a modificar: new_date, new_time o new_party_size');\n}\n\nreturn {\n  // âœ… Datos para BUSCAR la reserva\n  restaurant_id: input.restaurant_id,\n  customer_id: input.customer_id,\n  customer_phone: input.customer_phone,\n  \n  // Nuevos valores (pueden ser null si no se modifican)\n  new_date: input.new_date || null,\n  new_time: input.new_time || null,\n  new_party_size: input.new_party_size ? parseInt(input.new_party_size) : null,\n  \n  // Otros campos opcionales\n  preferred_zone: input.preferred_zone || null,\n  special_requests: input.special_requests || null\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-1000, 240],
      "id": "validate-input",
      "name": "ğŸ” Validar Input"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "reservations",
        "returnAll": false,
        "limit": 1,
        "filterType": "manual",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "customer_id",
              "condition": "eq",
              "keyValue": "={{ $json.customer_id }}"
            },
            {
              "keyName": "restaurant_id",
              "condition": "eq",
              "keyValue": "={{ $json.restaurant_id }}"
            },
            {
              "keyName": "status",
              "condition": "in",
              "keyValue": "pending,confirmed,pending_approval"
            }
          ]
        },
        "sort": {
          "sortProperties": [
            {
              "property": "reservation_date",
              "direction": "asc"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [-800, 240],
      "id": "get-reservation",
      "name": "ğŸ“‹ Buscar Reserva Existente",
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const inputData = $('ğŸ” Validar Input').first().json;\nconst reservations = $input.all();\n\n// âœ… Verificar que se encontrÃ³ al menos una reserva\nif (reservations.length === 0) {\n  throw new Error('âŒ No se encontrÃ³ ninguna reserva activa para este cliente');\n}\n\nconst reservation = reservations[0].json;\n\nif (!reservation || !reservation.id) {\n  throw new Error('âŒ Reserva no encontrada');\n}\n\nconsole.log('ğŸ“‹ Reserva encontrada:', {\n  id: reservation.id,\n  current_date: reservation.reservation_date,\n  current_time: reservation.reservation_time,\n  current_party_size: reservation.party_size,\n  table_id: reservation.table_id\n});\n\n// Validar que la reserva se puede modificar\nconst validStatuses = ['pending', 'confirmed', 'pending_approval'];\nif (!validStatuses.includes(reservation.status)) {\n  throw new Error(`âŒ No se puede modificar una reserva con estado: ${reservation.status}`);\n}\n\n// Determinar valores finales (usar nuevos si existen, sino mantener actuales)\nconst finalDate = inputData.new_date || reservation.reservation_date;\nconst finalTime = inputData.new_time || reservation.reservation_time;\nconst finalPartySize = inputData.new_party_size || reservation.party_size;\nconst finalZone = inputData.preferred_zone || null;\n\n// Detectar si cambiÃ³ la fecha/hora (necesitamos liberar y buscar nuevo slot)\nconst dateTimeChanged = \n  (inputData.new_date && inputData.new_date !== reservation.reservation_date) ||\n  (inputData.new_time && inputData.new_time !== reservation.reservation_time);\n\nconsole.log('ğŸ”„ Cambios detectados:', {\n  date_changed: inputData.new_date && inputData.new_date !== reservation.reservation_date,\n  time_changed: inputData.new_time && inputData.new_time !== reservation.reservation_time,\n  party_size_changed: inputData.new_party_size && inputData.new_party_size !== reservation.party_size,\n  need_new_slot: dateTimeChanged\n});\n\nreturn {\n  // Datos de la reserva original\n  reservation_id: reservation.id,\n  restaurant_id: reservation.restaurant_id,\n  customer_id: reservation.customer_id,\n  customer_phone: reservation.customer_phone,\n  customer_name: reservation.customer_name,\n  old_table_id: reservation.table_id,\n  old_date: reservation.reservation_date,\n  old_time: reservation.reservation_time,\n  old_party_size: reservation.party_size,\n  \n  // Datos finales (nuevos o actuales)\n  final_date: finalDate,\n  final_time: finalTime,\n  final_party_size: finalPartySize,\n  preferred_zone: finalZone,\n  special_requests: inputData.special_requests || reservation.special_requests,\n  \n  // Flags\n  need_new_slot: dateTimeChanged\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-600, 240],
      "id": "prepare-modification",
      "name": "ğŸ”„ Preparar ModificaciÃ³n"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-slot-change",
              "leftValue": "={{ $json.need_new_slot }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "true"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [-400, 240],
      "id": "check-slot-change",
      "name": "â“ Â¿Cambia Fecha/Hora?"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "availability_slots",
        "returnAll": true,
        "filterType": "string",
        "filterString": "=restaurant_id=eq.{{ $json.restaurant_id }}&slot_date=eq.{{ $json.final_date }}&start_time=eq.{{ $json.final_time }}&status=eq.free&is_available=is.true{{ $json.preferred_zone ? '&zone=eq.' + $json.preferred_zone : '' }}"
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [-200, 128],
      "id": "search-new-slots",
      "name": "ğŸ” Buscar Nuevo Slot",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "const slots = $input.all();\nconst modificationData = $('ğŸ”„ Preparar ModificaciÃ³n').first().json;\n\nconsole.log('ğŸ“Š Slots nuevos encontrados:', slots.length);\n\nif (slots.length === 0) {\n  return {\n    disponible: false,\n    mensaje: `No hay mesas disponibles para ${modificationData.final_party_size} personas el ${modificationData.final_date} a las ${modificationData.final_time}.`\n  };\n}\n\n// âœ… FILTRAR POR CAPACIDAD\nconst slotsWithCapacity = slots.filter(s => {\n  const capacity = s.json.capacity;\n  return capacity >= modificationData.final_party_size;\n});\n\nconsole.log('âœ… Slots con capacidad suficiente:', slotsWithCapacity.length);\n\nif (slotsWithCapacity.length === 0) {\n  return {\n    disponible: false,\n    mensaje: `No hay mesas con capacidad para ${modificationData.final_party_size} personas en esa fecha y hora.`\n  };\n}\n\n// âœ… Ordenar por capacidad ASC (la mÃ¡s pequeÃ±a que cumpla)\nconst sorted = slotsWithCapacity.sort((a, b) => a.json.capacity - b.json.capacity);\nconst mejorSlot = sorted[0].json;\n\nconsole.log('ğŸ¯ Mejor slot nuevo seleccionado:', {\n  id: mejorSlot.id,\n  table_id: mejorSlot.table_id,\n  table_name: mejorSlot.table_name,\n  capacity: mejorSlot.capacity,\n  zone: mejorSlot.zone\n});\n\nreturn {\n  ...modificationData,\n  disponible: true,\n  new_slot_id: mejorSlot.id,\n  new_table_id: mejorSlot.table_id,\n  new_table_name: mejorSlot.table_name,\n  new_capacity: mejorSlot.capacity,\n  new_zone: mejorSlot.zone,\n  start_time: mejorSlot.start_time,\n  end_time: mejorSlot.end_time\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [0, 128],
      "id": "select-best-slot",
      "name": "ğŸ¯ Seleccionar Mejor Mesa"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-available",
              "leftValue": "={{ $json.disponible }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [192, 128],
      "id": "check-availability",
      "name": "â“ Â¿Disponible?"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "availability_slots",
        "filters": {
          "conditions": [
            {
              "keyName": "reservation_date",
              "condition": "eq",
              "keyValue": "={{ $json.old_date }}"
            },
            {
              "keyName": "start_time",
              "condition": "eq",
              "keyValue": "={{ $json.old_time }}"
            },
            {
              "keyName": "table_id",
              "condition": "eq",
              "keyValue": "={{ $json.old_table_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "status",
              "fieldValue": "free"
            },
            {
              "fieldId": "is_available",
              "fieldValue": true
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [384, 16],
      "id": "free-old-slot",
      "name": "ğŸ”“ Liberar Slot Antiguo",
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "reservations",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.reservation_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "reservation_date",
              "fieldValue": "={{ $json.final_date }}"
            },
            {
              "fieldId": "reservation_time",
              "fieldValue": "={{ $json.final_time }}"
            },
            {
              "fieldId": "party_size",
              "fieldValue": "={{ $json.final_party_size }}"
            },
            {
              "fieldId": "table_id",
              "fieldValue": "={{ $json.new_table_id }}"
            },
            {
              "fieldId": "special_requests",
              "fieldValue": "={{ $json.special_requests }}"
            },
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ $now.toISO() }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [576, 16],
      "id": "update-reservation",
      "name": "ğŸ’¾ Actualizar Reserva",
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "availability_slots",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $('ğŸ¯ Seleccionar Mejor Mesa').item.json.new_slot_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "status",
              "fieldValue": "reserved"
            },
            {
              "fieldId": "is_available",
              "fieldValue": false
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [768, 16],
      "id": "reserve-new-slot",
      "name": "ğŸ”’ Marcar Nuevo Slot Reservado",
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const reservation = $('ğŸ’¾ Actualizar Reserva').first().json;\nconst slotData = $('ğŸ¯ Seleccionar Mejor Mesa').first().json;\nconst oldData = $('ğŸ”„ Preparar ModificaciÃ³n').first().json;\n\nconsole.log('âœ… Reserva modificada:', reservation.id);\n\nconst changes = [];\nif (oldData.old_date !== slotData.final_date) {\n  changes.push(`fecha: ${oldData.old_date} â†’ ${slotData.final_date}`);\n}\nif (oldData.old_time !== slotData.final_time) {\n  changes.push(`hora: ${oldData.old_time} â†’ ${slotData.final_time}`);\n}\nif (oldData.old_party_size !== slotData.final_party_size) {\n  changes.push(`personas: ${oldData.old_party_size} â†’ ${slotData.final_party_size}`);\n}\n\nreturn {\n  success: true,\n  reservation_id: reservation.id,\n  message: `Â¡Listo, ${oldData.customer_name}! Tu reserva ha sido modificada. Nueva fecha: ${slotData.final_date} a las ${slotData.final_time} para ${slotData.final_party_size} personas. Mesa: ${slotData.new_table_name} (${slotData.new_zone}).`,\n  details: {\n    reservation_id: reservation.id,\n    changes: changes.join(', '),\n    new_date: slotData.final_date,\n    new_time: slotData.final_time,\n    new_party_size: slotData.final_party_size,\n    new_table: slotData.new_table_name,\n    new_zone: slotData.new_zone,\n    customer_name: oldData.customer_name\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [960, 16],
      "id": "success-response",
      "name": "âœ… Respuesta: Ã‰xito (Slot Cambiado)"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "reservations",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.reservation_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "party_size",
              "fieldValue": "={{ $json.final_party_size }}"
            },
            {
              "fieldId": "special_requests",
              "fieldValue": "={{ $json.special_requests }}"
            },
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ $now.toISO() }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [-200, 352],
      "id": "update-without-slot",
      "name": "ğŸ’¾ Actualizar Reserva (sin cambio de slot)",
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const reservation = $input.first().json;\nconst oldData = $('ğŸ”„ Preparar ModificaciÃ³n').first().json;\n\nconsole.log('âœ… Reserva actualizada (sin cambio de slot):', reservation.id);\n\nconst changes = [];\nif (oldData.old_party_size !== oldData.final_party_size) {\n  changes.push(`personas: ${oldData.old_party_size} â†’ ${oldData.final_party_size}`);\n}\nif (oldData.special_requests) {\n  changes.push(`peticiÃ³n especial actualizada`);\n}\n\nreturn {\n  success: true,\n  reservation_id: reservation.id,\n  message: `Â¡Listo, ${oldData.customer_name}! Tu reserva ha sido actualizada. ${changes.length > 0 ? 'Cambios: ' + changes.join(', ') + '.' : ''} Fecha: ${oldData.final_date} a las ${oldData.final_time}.`,\n  details: {\n    reservation_id: reservation.id,\n    changes: changes.join(', ') || 'solo peticiÃ³n especial',\n    date: oldData.final_date,\n    time: oldData.final_time,\n    party_size: oldData.final_party_size,\n    customer_name: oldData.customer_name\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [0, 352],
      "id": "success-no-slot",
      "name": "âœ… Respuesta: Ã‰xito (sin cambio de slot)"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\n\nconsole.log('âŒ No hay disponibilidad para modificaciÃ³n:', data.mensaje);\n\nreturn {\n  success: false,\n  message: data.mensaje,\n  details: {\n    requested_date: data.final_date,\n    requested_time: data.final_time,\n    requested_party_size: data.final_party_size\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [192, 272],
      "id": "error-no-availability",
      "name": "âŒ Respuesta: Sin Disponibilidad"
    }
  ],
  "connections": {
    "â–¶ï¸ Start": {
      "main": [[{"node": "ğŸ” Validar Input", "type": "main", "index": 0}]]
    },
    "ğŸ” Validar Input": {
      "main": [[{"node": "ğŸ“‹ Buscar Reserva Existente", "type": "main", "index": 0}]]
    },
    "ğŸ“‹ Buscar Reserva Existente": {
      "main": [[{"node": "ğŸ”„ Preparar ModificaciÃ³n", "type": "main", "index": 0}]]
    },
    "ğŸ”„ Preparar ModificaciÃ³n": {
      "main": [[{"node": "â“ Â¿Cambia Fecha/Hora?", "type": "main", "index": 0}]]
    },
    "â“ Â¿Cambia Fecha/Hora?": {
      "main": [
        [{"node": "ğŸ” Buscar Nuevo Slot", "type": "main", "index": 0}],
        [{"node": "ğŸ’¾ Actualizar Reserva (sin cambio de slot)", "type": "main", "index": 0}]
      ]
    },
    "ğŸ” Buscar Nuevo Slot": {
      "main": [[{"node": "ğŸ¯ Seleccionar Mejor Mesa", "type": "main", "index": 0}]]
    },
    "ğŸ¯ Seleccionar Mejor Mesa": {
      "main": [[{"node": "â“ Â¿Disponible?", "type": "main", "index": 0}]]
    },
    "â“ Â¿Disponible?": {
      "main": [
        [{"node": "âŒ Respuesta: Sin Disponibilidad", "type": "main", "index": 0}],
        [{"node": "ğŸ”“ Liberar Slot Antiguo", "type": "main", "index": 0}]
      ]
    },
    "ğŸ”“ Liberar Slot Antiguo": {
      "main": [[{"node": "ğŸ’¾ Actualizar Reserva", "type": "main", "index": 0}]]
    },
    "ğŸ’¾ Actualizar Reserva": {
      "main": [[{"node": "ğŸ”’ Marcar Nuevo Slot Reservado", "type": "main", "index": 0}]]
    },
    "ğŸ”’ Marcar Nuevo Slot Reservado": {
      "main": [[{"node": "âœ… Respuesta: Ã‰xito (Slot Cambiado)", "type": "main", "index": 0}]]
    },
    "ğŸ’¾ Actualizar Reserva (sin cambio de slot)": {
      "main": [[{"node": "âœ… Respuesta: Ã‰xito (sin cambio de slot)", "type": "main", "index": 0}]]
    },
    "âœ… Respuesta: Ã‰xito (Slot Cambiado)": {
      "main": [[]]
    },
    "âœ… Respuesta: Ã‰xito (sin cambio de slot)": {
      "main": [[]]
    },
    "âŒ Respuesta: Sin Disponibilidad": {
      "main": [[]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": []
}


