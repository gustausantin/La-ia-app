{
  "name": "üîß TOOL: create_reservation ‚Äî CON CONFIRMACIONES",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [
        -848,
        -64
      ],
      "id": "f2fd611c-05a9-4071-a2f0-e8d7dd0b153a",
      "name": "‚ñ∂Ô∏è Start"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.item.json;\n\nconsole.log('üîç Input recibido:', JSON.stringify(input, null, 2));\n\n// ‚úÖ Validar datos m√≠nimos\nconst required = ['reservation_date', 'reservation_time', 'party_size', 'restaurant_id'];\nconst missing = required.filter(field => !input[field]);\n\nif (missing.length > 0) {\n  throw new Error(`‚ùå Faltan campos obligatorios: ${missing.join(', ')}`);\n}\n\nreturn {\n  // ‚úÖ DATOS OBLIGATORIOS\n  restaurant_id: input.restaurant_id,\n  customer_id: input.customer_id,\n  customer_phone: input.customer_phone,\n  customer_name: input.customer_name,\n  \n  // ‚úÖ DATOS DE LA RESERVA\n  reservation_date: input.reservation_date,\n  reservation_time: input.reservation_time,\n  party_size: parseInt(input.party_size),\n  \n  // ‚úÖ DATOS OPCIONALES\n  preferred_zone: input.preferred_zone || null,\n  special_requests: input.special_requests || null,\n  source: input.source || 'agent_whatsapp'\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -656,
        -64
      ],
      "id": "214ac426-7341-43d4-83a3-069e1922af25",
      "name": "üîç Validar Input"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://ktsqwvhqamedpmzkzjaz.supabase.co/rest/v1/rpc/find_table_combinations",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"p_restaurant_id\": \"{{ $json.restaurant_id }}\",\n  \"p_date\": \"{{ $json.reservation_date }}\",\n  \"p_time\": \"{{ $json.reservation_time }}:00\",\n  \"p_party_size\": {{ $json.party_size }},\n  \"p_zone\": {{ $json.preferred_zone ? '\"' + $json.preferred_zone + '\"' : 'null' }}\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -448,
        -64
      ],
      "id": "b1162361-ab89-46ed-b2f1-5e894200b279",
      "name": "üéØ Verificar Disponibilidad",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      },
      "continueOnFail": true,
      "notes": "‚ú® CORREGIDO: Llama a RPC v√≠a HTTP Request POST"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// üîÑ PROCESAR DISPONIBILIDAD\n// =====================================================\n\nconst validacion = $('üîç Validar Input').first().json;\nconst resultado = $input.first().json;\n\nconsole.log('üìä Respuesta RPC:', JSON.stringify(resultado, null, 2));\n\n// Con HTTP Request, la respuesta viene directamente\nconst disponibilidad = resultado;\n\nif (!disponibilidad || typeof disponibilidad !== 'object') {\n  console.log('‚ùå No se recibi√≥ respuesta de disponibilidad');\n  return {\n    disponible: false,\n    mensaje: 'Error al verificar disponibilidad',\n    ...validacion\n  };\n}\n\nif (!disponibilidad.available) {\n  console.log('‚ùå No hay disponibilidad');\n  return {\n    disponible: false,\n    mensaje: disponibilidad.message || 'No hay disponibilidad',\n    ...validacion\n  };\n}\n\nconsole.log('‚úÖ Disponibilidad encontrada. Tipo:', disponibilidad.type);\n\n// ===== EXTRAER SLOT IDS =====\nlet slot_ids = [];\n\nif (disponibilidad.type === 'single') {\n  slot_ids = [disponibilidad.slot_id];\n} else if (disponibilidad.type === 'combination') {\n  slot_ids = disponibilidad.slot_ids || [];\n}\n\nif (slot_ids.length === 0) {\n  console.log('‚ùå No se encontraron slot_ids v√°lidos');\n  return {\n    disponible: false,\n    mensaje: 'Error: No se pudieron identificar las mesas',\n    ...validacion\n  };\n}\n\nconsole.log('üéØ Slot IDs a reservar:', slot_ids);\n\nreturn {\n  disponible: true,\n  slot_ids: slot_ids,\n  tipo: disponibilidad.type,\n  tables: disponibilidad.tables || disponibilidad.table_names || [],\n  zone: disponibilidad.zone,\n  ...validacion\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -240,
        -64
      ],
      "id": "0ad13612-be1f-4e97-9e80-2ccb7a15547e",
      "name": "üîÑ Procesar Disponibilidad"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-available",
              "leftValue": "={{ $json.disponible }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "false",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -48,
        -64
      ],
      "id": "a5f16502-bb18-4d72-958a-fc0b0290fbe7",
      "name": "‚ùì ¬øDisponible?"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://ktsqwvhqamedpmzkzjaz.supabase.co/rest/v1/rpc/create_combined_reservation",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "supabaseApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"p_restaurant_id\": \"{{ $json.restaurant_id }}\",\n  \"p_customer_id\": \"{{ $json.customer_id }}\",\n  \"p_customer_phone\": \"{{ $json.customer_phone }}\",\n  \"p_customer_name\": \"{{ $json.customer_name }}\",\n  \"p_reservation_date\": \"{{ $json.reservation_date }}\",\n  \"p_reservation_time\": \"{{ $json.reservation_time }}:00\",\n  \"p_party_size\": {{ $json.party_size }},\n  \"p_slot_ids\": {{ JSON.stringify($json.slot_ids) }},\n  \"p_special_requests\": {{ $json.special_requests ? '\"' + $json.special_requests + '\"' : 'null' }},\n  \"p_source\": \"{{ $json.source }}\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        192,
        -176
      ],
      "id": "25b97b41-8181-4ca9-8ff9-6165d98e8a89",
      "name": "üíæ Crear Reserva (RPC)",
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      },
      "notes": "‚ú® CORREGIDO: Llama a RPC v√≠a HTTP Request POST"
    },
    {
      "parameters": {
        "jsCode": "// =====================================================\n// ‚úÖ PROCESAR RESPUESTA DE CREACI√ìN\n// =====================================================\n\nconst resultado = $input.first().json;\n\nconsole.log('üìä Respuesta RPC create_combined_reservation:', JSON.stringify(resultado, null, 2));\n\n// Con HTTP Request, la respuesta viene directamente\nconst reserva = resultado;\n\nif (!reserva || typeof reserva !== 'object') {\n  console.log('‚ùå No se recibi√≥ respuesta de creaci√≥n');\n  return {\n    success: false,\n    message: 'Error al crear la reserva: No se recibi√≥ respuesta'\n  };\n}\n\nif (!reserva.success) {\n  console.log('‚ùå Error al crear reserva:', reserva.error || reserva.message);\n  return {\n    success: false,\n    message: reserva.message || 'Error al crear la reserva'\n  };\n}\n\nconsole.log('‚úÖ Reserva creada exitosamente:', reserva.reservation_id);\n\nreturn {\n  success: true,\n  reservation_id: reserva.reservation_id,\n  message: reserva.message,\n  details: {\n    reservation_id: reserva.reservation_id,\n    customer_name: reserva.customer_name,\n    date: reserva.reservation_date,\n    time: reserva.reservation_time,\n    party_size: reserva.party_size,\n    tables: reserva.tables,\n    zone: reserva.zone,\n    num_tables: reserva.num_tables,\n    is_combined: reserva.is_combined,\n    slots_reserved: reserva.slots_reserved\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        384,
        -176
      ],
      "id": "ecf4e2a0-c489-4e7c-b4aa-87105362bd18",
      "name": "üîÑ Procesar Creaci√≥n"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\n\nconsole.log('‚ùå No hay disponibilidad:', data.mensaje);\n\nreturn {\n  success: false,\n  message: data.mensaje || 'No hay disponibilidad para crear la reserva',\n  details: {\n    date: data.reservation_date,\n    time: data.reservation_time,\n    party_size: data.party_size,\n    zone: data.preferred_zone\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        192,
        48
      ],
      "id": "2e30b79e-171f-4f9e-a861-0a08ced1952e",
      "name": "‚ùå Respuesta: Error"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://gustausantin.app.n8n.cloud/webhook/confirmation-handler",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"reservation_id\": \"{{ $('üîÑ Procesar Creaci√≥n').item.json.reservation_id }}\",\n  \"restaurant_id\": \"{{ $('üîç Validar Input').item.json.restaurant_id }}\",\n  \"customer_name\": \"{{ $('üîç Validar Input').item.json.customer_name }}\",\n  \"customer_phone\": \"{{ $('üîç Validar Input').item.json.customer_phone }}\",\n  \"reservation_date\": \"{{ $('üîç Validar Input').item.json.reservation_date }}\",\n  \"reservation_time\": \"{{ $('üîç Validar Input').item.json.reservation_time }}\",\n  \"party_size\": {{ $('üîç Validar Input').item.json.party_size }}\n}",
        "options": {
          "ignoreResponseCode": true,
          "timeout": 5000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        576,
        -176
      ],
      "id": "call-confirmation-handler",
      "name": "üìû Activar Confirmaci√≥n",
      "continueOnFail": true,
      "notes": "‚ú® Llama al webhook de confirmaci√≥n inteligente (no bloquea si falla)"
    },
    {
      "parameters": {
        "jsCode": "const creacion = $('üîÑ Procesar Creaci√≥n').first().json;\nconst confirmacion = $input.first().json;\n\nconsole.log('üìû Respuesta de confirmation-handler:', confirmacion);\n\n// Retornar siempre el resultado de la creaci√≥n (√©xito)\n// La confirmaci√≥n es un proceso paralelo que no debe afectar el resultado\nreturn creacion;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        768,
        -176
      ],
      "id": "final-response",
      "name": "‚úÖ Respuesta Final"
    }
  ],
  "connections": {
    "‚ñ∂Ô∏è Start": {
      "main": [
        [
          {
            "node": "üîç Validar Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîç Validar Input": {
      "main": [
        [
          {
            "node": "üéØ Verificar Disponibilidad",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üéØ Verificar Disponibilidad": {
      "main": [
        [
          {
            "node": "üîÑ Procesar Disponibilidad",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÑ Procesar Disponibilidad": {
      "main": [
        [
          {
            "node": "‚ùì ¬øDisponible?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "‚ùì ¬øDisponible?": {
      "main": [
        [
          {
            "node": "‚ùå Respuesta: Error",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "üíæ Crear Reserva (RPC)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üíæ Crear Reserva (RPC)": {
      "main": [
        [
          {
            "node": "üîÑ Procesar Creaci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîÑ Procesar Creaci√≥n": {
      "main": [
        [
          {
            "node": "üìû Activar Confirmaci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìû Activar Confirmaci√≥n": {
      "main": [
        [
          {
            "node": "‚úÖ Respuesta Final",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "instanceId": "968c65341fc947850f62b4a42d249947219a244717952c0dbaf2b62952e73bd9"
  },
  "tags": [
    {
      "createdAt": "2025-10-22T12:00:00.000Z",
      "updatedAt": "2025-10-22T18:00:00.000Z",
      "id": "confirmaciones",
      "name": "‚úÖ CON Sistema de Confirmaciones"
    }
  ]
}
