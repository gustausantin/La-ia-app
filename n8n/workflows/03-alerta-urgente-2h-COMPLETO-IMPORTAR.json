{
  "name": "03 - Alerta Urgente 2h",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "*/15 * * * *"
            }
          ]
        }
      },
      "id": "cron-urgente-15min",
      "name": "â° Cron Cada 15 min",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -1088,
        608
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "reservations",
        "returnAll": true
      },
      "id": "get-all-reservations",
      "name": "ğŸ“Š Obtener TODAS las Reservas",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -848,
        608
      ],
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const now = new Date();\nconst nowTime = now.getTime();\n\nconst filtered = $input.all().filter(item => {\n  const data = item.json;\n  \n  const reservationDateTime = new Date(`${data.reservation_date}T${data.reservation_time}`);\n  const reservationTime = reservationDateTime.getTime();\n  \n  const hoursUntil = (reservationTime - nowTime) / (1000 * 60 * 60);\n  \n  return hoursUntil >= 2 && \n         hoursUntil <= 3 &&\n         data.noshow_risk_score > 60 &&\n         (data.status === 'pending' || data.status === 'confirmed') &&\n         data.customer_phone !== null &&\n         data.customer_phone !== '';\n});\n\nreturn filtered;"
      },
      "id": "filter-high-risk-2h",
      "name": "ğŸ” Filtrar: Riesgo Alto 2-3h",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -608,
        608
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $input.all().length }}",
              "value2": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "check-reservations",
      "name": "â“ Â¿Hay Reservas Riesgo Alto?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        -416,
        608
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "loop-reservations",
      "name": "ğŸ” Loop Cada Reserva",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        -144,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nconst results = items.map(item => {\n  const data = item.json;\n  let phone = data.customer_phone || '';\n  \n  if (phone && !phone.startsWith('+')) {\n    if (phone.startsWith('34')) {\n      phone = '+' + phone;\n    } else if (phone.startsWith('0034')) {\n      phone = '+' + phone.substring(2);\n    } else {\n      phone = '+34' + phone;\n    }\n  }\n  \n  const now = new Date();\n  const reservationDateTime = new Date(`${data.reservation_date}T${data.reservation_time}`);\n  const hoursRemaining = Math.round((reservationDateTime - now) / (1000 * 60 * 60));\n  const minutesRemaining = Math.round((reservationDateTime - now) / (1000 * 60));\n  \n  return {\n    json: {\n      ...data,\n      customer_phone_normalized: phone,\n      hours_remaining: hoursRemaining,\n      minutes_remaining: minutesRemaining\n    }\n  };\n});\n\nreturn results;"
      },
      "id": "normalize-phone",
      "name": "ğŸ“ Preparar Datos",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        144,
        416
      ]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "restaurants",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "condition": "eq",
              "keyValue": "={{ $json.restaurant_id }}"
            }
          ]
        }
      },
      "id": "get-restaurant-config",
      "name": "ğŸ“ Obtener Config Restaurante",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        336,
        416
      ],
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "resource": "row",
        "operation": "create",
        "tableId": "noshow_alerts",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "reservation_id",
              "fieldValue": "={{ $node[\"ğŸ“ Preparar Datos\"].json.id }}"
            },
            {
              "fieldId": "restaurant_id",
              "fieldValue": "={{ $node[\"ğŸ“ Preparar Datos\"].json.restaurant_id }}"
            },
            {
              "fieldId": "alert_type",
              "fieldValue": "high_risk_no_confirmation"
            },
            {
              "fieldId": "risk_score",
              "fieldValue": "={{ $node[\"ğŸ“ Preparar Datos\"].json.noshow_risk_score }}"
            },
            {
              "fieldId": "time_until_reservation_minutes",
              "fieldValue": "={{ $node[\"ğŸ“ Preparar Datos\"].json.minutes_remaining }}"
            },
            {
              "fieldId": "customer_name",
              "fieldValue": "={{ $node[\"ğŸ“ Preparar Datos\"].json.customer_name }}"
            },
            {
              "fieldId": "customer_phone",
              "fieldValue": "={{ $node[\"ğŸ“ Preparar Datos\"].json.customer_phone_normalized }}"
            },
            {
              "fieldId": "party_size",
              "fieldValue": "={{ $node[\"ğŸ“ Preparar Datos\"].json.party_size }}"
            },
            {
              "fieldId": "reservation_time",
              "fieldValue": "={{ $node[\"ğŸ“ Preparar Datos\"].json.reservation_time }}"
            },
            {
              "fieldId": "message",
              "fieldValue": "=ğŸ”´ URGENTE: Cliente {{ $node[\"ğŸ“ Preparar Datos\"].json.customer_name }} - Riesgo {{ $node[\"ğŸ“ Preparar Datos\"].json.noshow_risk_score }}% - Llamar AHORA"
            },
            {
              "fieldId": "status",
              "fieldValue": "pending"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ new Date().toISOString() }}"
            }
          ]
        }
      },
      "id": "create-alert",
      "name": "ğŸš¨ Crear Alerta Urgente",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        560,
        416
      ],
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "fromEmail": "info@la-ia.site",
        "toEmail": "={{ $node[\"ğŸ“ Obtener Config Restaurante\"].json[0].email }}",
        "subject": "=ğŸ”´ URGENTE: Llamada Inmediata - {{ $node[\"ğŸ“ Preparar Datos\"].json.customer_name }}",
        "emailType": "html",
        "message": "=<h2 style=\"color: #dc2626;\">ğŸ”´ ALERTA URGENTE - Riesgo de No-Show Alto</h2>\n\n<p><strong>Cliente:</strong> {{ $node[\"ğŸ“ Preparar Datos\"].json.customer_name }}</p>\n<p><strong>TelÃ©fono:</strong> <a href=\"tel:{{ $node[\"ğŸ“ Preparar Datos\"].json.customer_phone_normalized }}\">{{ $node[\"ğŸ“ Preparar Datos\"].json.customer_phone_normalized }}</a></p>\n<p><strong>Nivel de Riesgo:</strong> <span style=\"color: #dc2626; font-size: 18px; font-weight: bold;\">{{ $node[\"ğŸ“ Preparar Datos\"].json.noshow_risk_score }}%</span></p>\n<p><strong>Reserva:</strong> HOY a las {{ $node[\"ğŸ“ Preparar Datos\"].json.reservation_time }}</p>\n<p><strong>Comensales:</strong> {{ $node[\"ğŸ“ Preparar Datos\"].json.party_size }} personas</p>\n<p><strong>Tiempo restante:</strong> {{ $node[\"ğŸ“ Preparar Datos\"].json.hours_remaining }} horas</p>\n\n<hr>\n\n<h3 style=\"color: #dc2626;\">âš ï¸ ACCIÃ“N REQUERIDA:</h3>\n<p style=\"font-size: 16px;\"><strong>LLAMAR INMEDIATAMENTE</strong> al cliente para confirmar su asistencia.</p>\n\n<p>Esta alerta se generÃ³ automÃ¡ticamente por el sistema La-IA.</p>\n\n<p style=\"font-size: 12px; color: #666;\">Puedes ver mÃ¡s detalles en el Dashboard: <a href=\"https://app.la-ia.app/dashboard\">https://app.la-ia.app/dashboard</a></p>",
        "options": {}
      },
      "id": "send-email-alert",
      "name": "ğŸ“§ Enviar Email al Staff",
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2,
      "position": [
        768,
        416
      ]
    },
    {
      "parameters": {
        "resource": "row",
        "operation": "create",
        "tableId": "customer_confirmations",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "reservation_id",
              "fieldValue": "={{ $node[\"ğŸ“ Preparar Datos\"].json.id }}"
            },
            {
              "fieldId": "restaurant_id",
              "fieldValue": "={{ $node[\"ğŸ“ Preparar Datos\"].json.restaurant_id }}"
            },
            {
              "fieldId": "message_type",
              "fieldValue": "Llamada urgente"
            },
            {
              "fieldId": "sent_at",
              "fieldValue": "={{ new Date().toISOString() }}"
            },
            {
              "fieldId": "message_content",
              "fieldValue": "=ğŸ”´ URGENTE: Cliente {{ $node[\"ğŸ“ Preparar Datos\"].json.customer_name }} - Score {{ $node[\"ğŸ“ Preparar Datos\"].json.noshow_risk_score }}% - Reserva en {{ $node[\"ğŸ“ Preparar Datos\"].json.hours_remaining }}h - LLAMAR YA + Email enviado al staff"
            },
            {
              "fieldId": "customer_id",
              "fieldValue": "={{ $node[\"ğŸ“ Preparar Datos\"].json.customer_id }}"
            }
          ]
        }
      },
      "id": "register-urgent-action",
      "name": "ğŸ’¾ Registrar AcciÃ³n Urgente",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        976,
        416
      ],
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {},
      "id": "no-high-risk",
      "name": "âœ… Fin: Sin Riesgo Alto",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [
        -128,
        848
      ]
    }
  ],
  "connections": {
    "â° Cron Cada 15 min": {
      "main": [
        [
          {
            "node": "ğŸ“Š Obtener TODAS las Reservas",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“Š Obtener TODAS las Reservas": {
      "main": [
        [
          {
            "node": "ğŸ” Filtrar: Riesgo Alto 2-3h",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Filtrar: Riesgo Alto 2-3h": {
      "main": [
        [
          {
            "node": "â“ Â¿Hay Reservas Riesgo Alto?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â“ Â¿Hay Reservas Riesgo Alto?": {
      "main": [
        [
          {
            "node": "ğŸ” Loop Cada Reserva",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "âœ… Fin: Sin Riesgo Alto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Loop Cada Reserva": {
      "main": [
        [],
        [
          {
            "node": "ğŸ“ Preparar Datos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Preparar Datos": {
      "main": [
        [
          {
            "node": "ğŸ“ Obtener Config Restaurante",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Obtener Config Restaurante": {
      "main": [
        [
          {
            "node": "ğŸš¨ Crear Alerta Urgente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸš¨ Crear Alerta Urgente": {
      "main": [
        [
          {
            "node": "ğŸ“§ Enviar Email al Staff",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“§ Enviar Email al Staff": {
      "main": [
        [
          {
            "node": "ğŸ’¾ Registrar AcciÃ³n Urgente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ’¾ Registrar AcciÃ³n Urgente": {
      "main": [
        [
          {
            "node": "ğŸ” Loop Cada Reserva",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  }
}

