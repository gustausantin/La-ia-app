{
  "name": "TOOL 6 - Escalate to Human",
  "nodes": [
    {
      "parameters": {},
      "id": "tool-escalate-trigger",
      "name": "â–¶ï¸ Start (Tool Call)",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [200, 300]
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\n\nconsole.log('ğŸ†˜ ESCALADO A HUMANO:', input);\n\nconst reason = input.reason || 'cliente_solicita';\nconst customerPhone = input.customer_phone || 'No disponible';\nconst customerName = input.customer_name || 'Cliente';\nconst customerMessage = input.customer_message || 'Sin detalles';\nconst urgency = input.urgency || 'high';\n\n// Mapeo de razones a espaÃ±ol\nconst reasonMap = {\n  'cliente_solicita': 'ğŸ™‹ El cliente solicita hablar con una persona',\n  'situacion_compleja': 'ğŸ¤” SituaciÃ³n compleja fuera del alcance del agente',\n  'queja_grave': 'ğŸ˜¡ Queja grave del cliente',\n  'informacion_no_disponible': 'â„¹ï¸ InformaciÃ³n no disponible en el sistema',\n  'error_sistema': 'âš ï¸ Error del sistema'\n};\n\nconst reasonText = reasonMap[reason] || reason;\nconst urgencyEmoji = urgency === 'high' ? 'ğŸš¨ğŸš¨ğŸš¨' : 'âš ï¸';\n\nreturn {\n  reason,\n  reasonText,\n  customerPhone,\n  customerName,\n  customerMessage,\n  urgency,\n  urgencyEmoji,\n  timestamp: new Date().toISOString()\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [400, 300],
      "id": "prepare-escalation",
      "name": "ğŸ“‹ Preparar Escalado"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "restaurants",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $('â–¶ï¸ Start (Tool Call)').item.json.restaurant_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [600, 300],
      "id": "get-restaurant",
      "name": "ğŸª Get Restaurant",
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const escalation = $('ğŸ“‹ Preparar Escalado').first().json;\nconst restaurant = $input.first().json;\n\nconst channels = restaurant.channels || {};\nconst whatsapp = channels.whatsapp || {};\n\n// âœ… NÃšMERO DE TWILIO (quien ENVÃA - FROM)\nconst twilioNumber = whatsapp.phone_number || restaurant.phone;\n\n// âœ… NÃšMERO DE EMERGENCIA (quien RECIBE - TO)\nconst emergencyPhone = whatsapp.emergency_phone;\n\n// Validaciones\nif (!twilioNumber) {\n  throw new Error('âŒ No se encontrÃ³ nÃºmero de Twilio para el restaurante (channels.whatsapp.phone_number)');\n}\n\nif (!emergencyPhone) {\n  throw new Error('âŒ No se encontrÃ³ telÃ©fono de emergencia para el restaurante (channels.whatsapp.emergency_phone)');\n}\n\n// Construir mensaje de alerta\nconst message = `${escalation.urgencyEmoji} ALERTA - CLIENTE NECESITA ATENCIÃ“N\\n\\n${escalation.reasonText}\\n\\nğŸ‘¤ Cliente: ${escalation.customerName}\\nğŸ“ TelÃ©fono: ${escalation.customerPhone}\\nâ° Hora: ${new Date().toLocaleString('es-ES')}\\n\\nğŸ’¬ Mensaje del cliente:\\n\"${escalation.customerMessage}\"\\n\\nâš¡ AcciÃ³n requerida: Contactar al cliente URGENTEMENTE\\n\\n---\\nRestaurante: ${restaurant.name}`;\n\nconsole.log('ğŸ“¤ ConfiguraciÃ³n envÃ­o:');\nconsole.log('   FROM (Twilio):', twilioNumber);\nconsole.log('   TO (Emergencia):', emergencyPhone);\nconsole.log('   Mensaje:', message.substring(0, 100) + '...');\n\nreturn {\n  ...escalation,\n  restaurant_name: restaurant.name,\n  twilio_number: twilioNumber,\n  emergency_phone: emergencyPhone,\n  alert_message: message\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [800, 300],
      "id": "build-alert",
      "name": "ğŸš¨ Construir Alerta"
    },
    {
      "parameters": {
        "from": "={{ $json.twilio_number }}",
        "to": "={{ $json.emergency_phone }}",
        "toWhatsapp": true,
        "message": "={{ $json.alert_message }}",
        "options": {}
      },
      "type": "n8n-nodes-base.twilio",
      "typeVersion": 1,
      "position": [1000, 300],
      "id": "send-whatsapp-alert",
      "name": "ğŸ“± Enviar WhatsApp Urgente",
      "credentials": {
        "twilioApi": {
          "id": "KZF7OfG2zH2XYZAQ",
          "name": "Twilio account"
        }
      }
    },
    {
      "parameters": {
        "tableId": "escalations",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "restaurant_id",
              "fieldValue": "={{ $('â–¶ï¸ Start (Tool Call)').item.json.restaurant_id }}"
            },
            {
              "fieldId": "customer_phone",
              "fieldValue": "={{ $('ğŸ“‹ Preparar Escalado').item.json.customerPhone }}"
            },
            {
              "fieldId": "customer_name",
              "fieldValue": "={{ $('ğŸ“‹ Preparar Escalado').item.json.customerName }}"
            },
            {
              "fieldId": "reason",
              "fieldValue": "={{ $('ğŸ“‹ Preparar Escalado').item.json.reason }}"
            },
            {
              "fieldId": "urgency",
              "fieldValue": "={{ $('ğŸ“‹ Preparar Escalado').item.json.urgency }}"
            },
            {
              "fieldId": "customer_message",
              "fieldValue": "={{ $('ğŸ“‹ Preparar Escalado').item.json.customerMessage }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "pending"
            },
            {
              "fieldId": "escalated_at",
              "fieldValue": "={{ $('ğŸ“‹ Preparar Escalado').item.json.timestamp }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1200, 300],
      "id": "log-escalation",
      "name": "ğŸ’¾ Registrar Escalado",
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const escalation = $('ğŸ“‹ Preparar Escalado').first().json;\n\nconsole.log('âœ… Escalado completado:', escalation.customerName);\n\n// Respuesta para el agente\nreturn {\n  success: true,\n  message: 'El encargado ha sido notificado y te contactarÃ¡ en breve.',\n  escalated: true,\n  escalation_id: $input.first().json.id\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1400, 300],
      "id": "return-success",
      "name": "âœ… Devolver Resultado"
    }
  ],
  "connections": {
    "â–¶ï¸ Start (Tool Call)": {
      "main": [[{"node": "ğŸ“‹ Preparar Escalado", "type": "main", "index": 0}]]
    },
    "ğŸ“‹ Preparar Escalado": {
      "main": [[{"node": "ğŸª Get Restaurant", "type": "main", "index": 0}]]
    },
    "ğŸª Get Restaurant": {
      "main": [[{"node": "ğŸš¨ Construir Alerta", "type": "main", "index": 0}]]
    },
    "ğŸš¨ Construir Alerta": {
      "main": [[{"node": "ğŸ“± Enviar WhatsApp Urgente", "type": "main", "index": 0}]]
    },
    "ğŸ“± Enviar WhatsApp Urgente": {
      "main": [[{"node": "ğŸ’¾ Registrar Escalado", "type": "main", "index": 0}]]
    },
    "ğŸ’¾ Registrar Escalado": {
      "main": [[{"node": "âœ… Devolver Resultado", "type": "main", "index": 0}]]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "tags": []
}

