{
  "name": "05 - Auto-LiberaciÃ³n 2h Antes",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "cronExpression",
              "expression": "*/10 * * * *"
            }
          ]
        }
      },
      "id": "3d5d86ef-54c3-40be-b1c6-9053c4aa2e4d",
      "name": "â° Cada 10 minutos",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [-1216, 336]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "reservations",
        "returnAll": true
      },
      "id": "f311bbe5-8c82-4c13-aab4-712dd3592521",
      "name": "ðŸ“Š Obtener Reservas Activas",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [-1008, 336],
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const now = new Date();\nconst TIMEZONE_OFFSET = 2;\nconst localNow = new Date(now.getTime() + (TIMEZONE_OFFSET * 60 * 60 * 1000));\nconst TWO_HOURS = 2 * 60 * 60 * 1000;\n\nconst validStatuses = ['pending', 'confirmed', 'pendiente', 'confirmada'];\n\nconst filtered = $input.all().filter(item => {\n  const r = item.json;\n  \n  if (!validStatuses.includes(r.status)) {\n    return false;\n  }\n  \n  const resDateTime = new Date(`${r.reservation_date}T${r.reservation_time}`);\n  const timeUntil = resDateTime.getTime() - localNow.getTime();\n  \n  return timeUntil >= 0 && timeUntil <= TWO_HOURS;\n});\n\nconsole.log(`âœ… ${filtered.length} reservas activas <2h`);\nreturn filtered;"
      },
      "id": "4da62755-3c78-42df-91b0-141aad0b0156",
      "name": "ðŸ” Filtrar <2h",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-784, 336]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $input.all().length }}",
              "value2": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "bf6016b8-6d24-448a-aa37-0a154f24cd21",
      "name": "â“ Â¿Hay Reservas?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [-560, 336]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "1bdee040-19f0-40e5-913d-f2b062265dec",
      "name": "ðŸ”„ Por Cada Reserva",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [-336, 240]
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "customer_confirmations",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "reservation_id",
              "condition": "eq",
              "keyValue": "={{ $json.id }}"
            },
            {
              "keyName": "confirmed",
              "condition": "eq",
              "keyValue": "true"
            }
          ]
        }
      },
      "id": "ade5ce3e-7d85-4845-8f9d-ad116e0ed02f",
      "name": "âœ… Â¿ConfirmÃ³?",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [-128, 144],
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $input.all().length }}",
              "value2": 0,
              "operator": {
                "type": "number",
                "operation": "equal"
              }
            }
          ]
        },
        "options": {}
      },
      "id": "9cb32946-58d8-449a-86f2-8e7555080ab5",
      "name": "â“ Â¿NO ConfirmÃ³?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [112, 240]
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "reservations",
        "updateKey": "id",
        "id": "={{ $('ðŸ”„ Por Cada Reserva').item.json.id }}",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "status",
              "fieldValue": "no_show"
            },
            {
              "fieldId": "updated_at",
              "fieldValue": "={{ $now.toISO() }}"
            }
          ]
        }
      },
      "id": "9dfb4e69-e475-468a-9528-cd9aaaaaacf2",
      "name": "ðŸš« Marcar No-Show",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [320, 128],
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "operation": "insert",
        "tableId": "noshow_actions",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "restaurant_id",
              "fieldValue": "={{ $('ðŸ”„ Por Cada Reserva').item.json.restaurant_id }}"
            },
            {
              "fieldId": "reservation_id",
              "fieldValue": "={{ $('ðŸ”„ Por Cada Reserva').item.json.id }}"
            },
            {
              "fieldId": "action_type",
              "fieldValue": "auto_release"
            },
            {
              "fieldId": "action_date",
              "fieldValue": "={{ $now.format('yyyy-MM-dd') }}"
            },
            {
              "fieldId": "action_description",
              "fieldValue": "Cliente no confirmÃ³ recordatorios - Liberado automÃ¡ticamente 2h antes"
            },
            {
              "fieldId": "success",
              "fieldValue": "true"
            },
            {
              "fieldId": "notes",
              "fieldValue": "=HISTORIAL COMPLETO:\n- Cliente: {{ $('ðŸ”„ Por Cada Reserva').item.json.customer_name }} ({{ $('ðŸ”„ Por Cada Reserva').item.json.customer_phone }})\n- Reserva original: {{ $('ðŸ”„ Por Cada Reserva').item.json.reservation_date }} {{ $('ðŸ”„ Por Cada Reserva').item.json.reservation_time }}, {{ $('ðŸ”„ Por Cada Reserva').item.json.party_size }} personas\n- Motivo: No respondiÃ³ a recordatorios 24h ni 4h\n- Liberado a las: {{ $now.format('HH:mm') }}\n- Estado: Slots liberados automÃ¡ticamente por trigger DB\n- AcciÃ³n: Reserva marcada como no_show, slots disponibles para nuevas reservas"
            }
          ]
        }
      },
      "id": "56914724-da07-44a7-b285-67fd0fe499e8",
      "name": "ðŸ“ Registrar AcciÃ³n",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [544, 128],
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const r = $('ðŸ”„ Por Cada Reserva').item.json;\nconsole.log(`âœ… ${r.customer_name} - No-Show registrado y slots liberados`);\nreturn { success: true, customer: r.customer_name };"
      },
      "id": "fbc8f2a8-85a1-4217-a9ce-20172687e88b",
      "name": "âœ… Log Ã‰xito",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [768, 128]
    },
    {
      "parameters": {
        "jsCode": "const r = $('ðŸ”„ Por Cada Reserva').item.json;\nconsole.log(`â„¹ï¸ ${r.customer_name} - Cliente confirmÃ³, no liberar`);\nreturn { skipped: true, customer: r.customer_name };"
      },
      "id": "b0544832-18a7-46a9-942f-678c9035033f",
      "name": "â„¹ï¸ Log Skip",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [320, 336]
    },
    {
      "parameters": {
        "jsCode": "console.log('â„¹ï¸ No hay reservas <2h para revisar');\nreturn { message: 'No reservations' };"
      },
      "id": "9bdcf2c1-3c10-409d-a2e7-fb927a61098d",
      "name": "â„¹ï¸ Log VacÃ­o",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-336, 432]
    }
  ],
  "connections": {
    "â° Cada 10 minutos": {
      "main": [[{"node": "ðŸ“Š Obtener Reservas Activas", "type": "main", "index": 0}]]
    },
    "ðŸ“Š Obtener Reservas Activas": {
      "main": [[{"node": "ðŸ” Filtrar <2h", "type": "main", "index": 0}]]
    },
    "ðŸ” Filtrar <2h": {
      "main": [[{"node": "â“ Â¿Hay Reservas?", "type": "main", "index": 0}]]
    },
    "â“ Â¿Hay Reservas?": {
      "main": [
        [{"node": "ðŸ”„ Por Cada Reserva", "type": "main", "index": 0}],
        [{"node": "â„¹ï¸ Log VacÃ­o", "type": "main", "index": 0}]
      ]
    },
    "ðŸ”„ Por Cada Reserva": {
      "main": [[{"node": "âœ… Â¿ConfirmÃ³?", "type": "main", "index": 0}]]
    },
    "âœ… Â¿ConfirmÃ³?": {
      "main": [[{"node": "â“ Â¿NO ConfirmÃ³?", "type": "main", "index": 0}]]
    },
    "â“ Â¿NO ConfirmÃ³?": {
      "main": [
        [{"node": "ðŸš« Marcar No-Show", "type": "main", "index": 0}],
        [{"node": "â„¹ï¸ Log Skip", "type": "main", "index": 0}]
      ]
    },
    "ðŸš« Marcar No-Show": {
      "main": [[{"node": "ðŸ“ Registrar AcciÃ³n", "type": "main", "index": 0}]]
    },
    "ðŸ“ Registrar AcciÃ³n": {
      "main": [[{"node": "âœ… Log Ã‰xito", "type": "main", "index": 0}]]
    },
    "âœ… Log Ã‰xito": {
      "main": [[{"node": "ðŸ”„ Por Cada Reserva", "type": "main", "index": 0}]]
    },
    "â„¹ï¸ Log Skip": {
      "main": [[{"node": "ðŸ”„ Por Cada Reserva", "type": "main", "index": 0}]]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-10-13T16:45:00.000Z",
  "versionId": "5.0-FINAL-CORRECTO"
}
