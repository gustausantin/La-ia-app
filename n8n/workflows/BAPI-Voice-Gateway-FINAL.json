{
  "name": "ğŸ™ï¸ BAPI Voice Gateway â€” FINAL",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "bapi-voice-gateway",
        "responseMode": "responseNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1.1,
      "position": [-800, 240],
      "id": "webhook-bapi",
      "name": "ğŸ“ Webhook BAPI",
      "webhookId": "bapi-voice-inbound"
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NODO: ğŸ“ Normalizar Input VAPI\n// PROPÃ“SITO: Extraer y validar datos de la llamada de VAPI\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst body = $input.first().json.body || $input.first().json;\n\nconsole.log('ğŸ“¥ VAPI Input completo:', JSON.stringify(body, null, 2));\n\n// âœ… EXTRAER DATOS DE LA LLAMADA (estructura VAPI)\nconst message = body.message || body;\nconst call = message.call || {};\nconst phoneNumber = message.phoneNumber || {};\nconst customer = call.customer || {};\n\n// TelÃ©fonos (mantener formato con +)\nconst customerPhone = customer.number || call.from || '';\nconst restaurantPhone = phoneNumber.number || call.to || '';\n\n// ID de llamada\nconst callId = call.id || '';\n\nconsole.log('âœ… Datos extraÃ­dos:', {\n  customerPhone,\n  restaurantPhone,\n  callId,\n  callStatus: call.status\n});\n\n// âœ… VALIDACIONES\nif (!restaurantPhone) {\n  throw new Error('âŒ No se pudo identificar el telÃ©fono del restaurante (phoneNumber.number). Input recibido: ' + JSON.stringify(phoneNumber));\n}\n\nif (!customerPhone) {\n  throw new Error('âŒ No se pudo identificar el telÃ©fono del cliente (call.customer.number). Input recibido: ' + JSON.stringify(customer));\n}\n\nreturn {\n  customer_phone: customerPhone,\n  restaurant_phone: restaurantPhone,\n  call_metadata: {\n    call_id: callId,\n    call_sid: call.transport?.callSid || '',\n    account_sid: call.transport?.accountSid || '',\n    status: call.status || 'unknown',\n    type: call.type || 'inboundPhoneCall',\n    timestamp: message.timestamp || new Date().toISOString(),\n    assistant_id: call.assistantId || ''\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-600, 240],
      "id": "normalize-input",
      "name": "ğŸ“ Normalizar Input BAPI"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "restaurants",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "active",
              "condition": "eq",
              "keyValue": "true"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [-400, 240],
      "id": "get-all-restaurants",
      "name": "ğŸ” Get All Restaurants",
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NODO: ğŸª Buscar Restaurante por TelÃ©fono VOZ\n// PROPÃ“SITO: Buscar en JSONB channels.voice.phone_number\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst normalized = $('ğŸ“ Normalizar Input BAPI').first().json;\nconst allRestaurants = $input.all();\n\nconst searchPhone = normalized.restaurant_phone;\n\nconsole.log('ğŸ” Buscando restaurante con telÃ©fono:', searchPhone);\nconsole.log('ğŸ“Š Total restaurantes activos:', allRestaurants.length);\n\n// âœ… BUSCAR en channels.voice.phone_number\nconst matched = allRestaurants.find(item => {\n  const restaurant = item.json;\n  const channels = restaurant.channels || {};\n  const voice = channels.voice || {};\n  const voicePhone = voice.phone_number || '';\n  \n  console.log(`  Checking: ${restaurant.name} â†’ ${voicePhone}`);\n  \n  return voicePhone === searchPhone;\n});\n\nif (!matched) {\n  console.error('âŒ No se encontrÃ³ restaurante con telÃ©fono:', searchPhone);\n  throw new Error(`Restaurante no encontrado para telÃ©fono: ${searchPhone}. Verifica channels.voice.phone_number en Supabase.`);\n}\n\nconst restaurant = matched.json;\n\nconsole.log('âœ… Restaurante encontrado:', restaurant.name);\nconsole.log('   ID:', restaurant.id);\n\nreturn {\n  ...normalized,\n  restaurant_id: restaurant.id,\n  restaurant_name: restaurant.name,\n  restaurant_data: restaurant\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-200, 240],
      "id": "find-restaurant",
      "name": "ğŸª Buscar Restaurante"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "customers",
        "filters": {
          "conditions": [
            {
              "keyName": "restaurant_id",
              "condition": "eq",
              "keyValue": "={{ $json.restaurant_id }}"
            },
            {
              "keyName": "phone",
              "condition": "eq",
              "keyValue": "={{ $json.customer_phone }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [0, 160],
      "id": "get-customer",
      "name": "ğŸ” Buscar Cliente",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "check-customer-exists",
              "leftValue": "={{ $input.all().length }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [200, 240],
      "id": "if-customer-exists",
      "name": "â“ Â¿Cliente Existe?"
    },
    {
      "parameters": {
        "tableId": "customers",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "restaurant_id",
              "fieldValue": "={{ $('ğŸª Buscar Restaurante').item.json.restaurant_id }}"
            },
            {
              "fieldId": "name",
              "fieldValue": "Cliente"
            },
            {
              "fieldId": "phone",
              "fieldValue": "={{ $('ğŸª Buscar Restaurante').item.json.customer_phone }}"
            },
            {
              "fieldId": "segment_auto_v2",
              "fieldValue": "nuevo"
            },
            {
              "fieldId": "preferred_channel",
              "fieldValue": "voice"
            },
            {
              "fieldId": "consent_whatsapp",
              "fieldValue": "true"
            },
            {
              "fieldId": "total_visits",
              "fieldValue": "0"
            },
            {
              "fieldId": "visits_count",
              "fieldValue": "0"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [400, 160],
      "id": "create-customer",
      "name": "â• Crear Cliente",
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NODO: ğŸ”— Fusionar Cliente\n// PROPÃ“SITO: Unificar cliente existente o reciÃ©n creado\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst restaurantData = $('ğŸª Buscar Restaurante').first().json;\nconst customerData = $input.first().json;\n\nconsole.log('ğŸ”— Fusionando datos del cliente:', customerData.id);\n\nreturn {\n  ...restaurantData,\n  customer_id: customerData.id,\n  customer_name: customerData.name || 'Cliente',\n  customer_email: customerData.email || null\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [600, 240],
      "id": "merge-customer",
      "name": "ğŸ”— Fusionar Cliente"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "reservations",
        "returnAll": true,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "restaurant_id",
              "condition": "eq",
              "keyValue": "={{ $json.restaurant_id }}"
            },
            {
              "keyName": "customer_phone",
              "condition": "eq",
              "keyValue": "={{ $json.customer_phone }}"
            },
            {
              "keyName": "status",
              "condition": "in",
              "keyValue": "pending,confirmed,pending_approval,seated"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [800, 240],
      "id": "get-active-reservations",
      "name": "ğŸ“… Get Reservas Activas",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// NODO: ğŸ“¦ Preparar Contexto para VAPI (camelCase)\n// PROPÃ“SITO: Formato compatible con VAPI Tool Response\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nconst mergedData = $('ğŸ”— Fusionar Cliente').first().json;\nconst reservations = $input.all().map(r => r.json);\nconst restaurant = mergedData.restaurant_data;\nconst settings = restaurant.settings || {};\n\nconsole.log('ğŸ“¦ Preparando contexto para VAPI (camelCase)');\nconsole.log('   Restaurante:', restaurant.name);\nconsole.log('   Cliente:', mergedData.customer_name);\nconsole.log('   Reservas activas:', reservations.length);\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 1. AGENT CONFIG\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst agentConfig = settings.agent || {};\nconst agentName = agentConfig.name || 'la asistente virtual';\nconst agentGender = agentConfig.gender || 'female';\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 2. HORARIOS\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst calendarSchedule = settings.calendar_schedule || [];\nconst dayNamesMap = {\n  'sunday': 'Dom', 'monday': 'Lun', 'tuesday': 'Mar',\n  'wednesday': 'MiÃ©', 'thursday': 'Jue', 'friday': 'Vie', 'saturday': 'SÃ¡b'\n};\n\nconst hoursSummary = calendarSchedule.length > 0\n  ? calendarSchedule.map(day => {\n      const dayName = dayNamesMap[day.day_of_week] || day.day_name || 'N/A';\n      return day.is_open ? `${dayName}: ${day.open_time}-${day.close_time}` : `${dayName}: CERRADO`;\n    }).join(', ')\n  : 'No configurado';\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 3. ZONAS (camelCase)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst zonesConfig = settings.zones || {};\nconst availableZones = [];\n\nObject.entries(zonesConfig).forEach(([zoneKey, zoneData]) => {\n  if (zoneData && zoneData.enabled === true) {\n    availableZones.push({\n      id: zoneKey,\n      name: zoneData.display_name || zoneKey,\n      description: zoneData.description || '',\n      icon: zoneData.icon || '',\n      sortOrder: zoneData.sort_order || 99\n    });\n  }\n});\n\navailableZones.sort((a, b) => a.sortOrder - b.sortOrder);\nconst defaultZone = settings.default_zone || 'interior';\nconst zonesSummaryVoice = availableZones.length > 0\n  ? availableZones.map(z => `${z.icon} ${z.name}`).join(', ')\n  : 'interior';\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 4. POLÃTICAS (camelCase)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst bookingSettings = settings.booking_settings || {};\nconst politicas = {\n  reservationDuration: settings.reservation_duration || 90,\n  slotDuration: settings.slot_interval || 30,\n  minAdvanceMinutes: settings.min_advance_minutes || 30,\n  advanceBookingDays: bookingSettings.advance_booking_days || 30,\n  maxPartySize: bookingSettings.max_party_size || 8,\n  cancellationPolicy: bookingSettings.cancellation_policy || '24h'\n};\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 5. RESERVAS ACTIVAS (camelCase)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst activeReservations = reservations.map(r => ({\n  reservationId: r.id,\n  date: r.reservation_date,\n  time: r.reservation_time,\n  partySize: r.party_size,\n  zone: r.preferred_zone,\n  status: r.status,\n  specialRequests: r.special_requests || null\n}));\n\nlet reservationsSummary = '';\nif (activeReservations.length > 0) {\n  reservationsSummary = `ESTE CLIENTE TIENE ${activeReservations.length} RESERVA(S) ACTIVA(S): `;\n  activeReservations.forEach((r, i) => {\n    reservationsSummary += `Reserva ${i + 1}: ${r.date} a las ${r.time} para ${r.partySize} personas en ${r.zone || 'zona no especificada'}. `;\n  });\n  reservationsSummary += 'Si el cliente modifica, usa estos datos existentes.';\n} else {\n  reservationsSummary = 'Este cliente NO tiene reservas activas.';\n}\n\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n// 6. CONTEXTO FINAL (TODO camelCase)\n// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nconst context = {\n  restaurantId: mergedData.restaurant_id,\n  restaurantName: restaurant.name,\n  customerId: mergedData.customer_id,\n  customerName: mergedData.customer_name,\n  customerPhone: mergedData.customer_phone,\n  agentName: agentName,\n  agentGender: agentGender,\n  address: restaurant.address || '',\n  phone: restaurant.phone || '',\n  email: restaurant.email || '',\n  horarios: hoursSummary,\n  zonasDisponibles: availableZones,\n  zonaPorDefecto: defaultZone,\n  zonesSummary: zonesSummaryVoice,\n  politicas: politicas,\n  reservasActivas: activeReservations,\n  tieneReservasActivas: activeReservations.length > 0,\n  totalReservasActivas: activeReservations.length,\n  customerActiveReservationsSummary: reservationsSummary,\n  channel: 'voice',\n  callMetadata: mergedData.call_metadata,\n  timestamp: mergedData.call_metadata.timestamp\n};\n\nconsole.log('âœ… Contexto camelCase preparado:');\nconsole.log('   - Agente:', agentName);\nconsole.log('   - Zonas:', availableZones.length);\nconsole.log('   - Reservas:', activeReservations.length);\n\nreturn context;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1000, 240],
      "id": "prepare-context",
      "name": "ğŸ“¦ Preparar Contexto BAPI"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              }
            ]
          }
        }
      },
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1200, 240],
      "id": "respond-to-bapi",
      "name": "âœ… Responder a BAPI"
    }
  ],
  "connections": {
    "ğŸ“ Webhook BAPI": {
      "main": [[{"node": "ğŸ“ Normalizar Input BAPI", "type": "main", "index": 0}]]
    },
    "ğŸ“ Normalizar Input BAPI": {
      "main": [[{"node": "ğŸ” Get All Restaurants", "type": "main", "index": 0}]]
    },
    "ğŸ” Get All Restaurants": {
      "main": [[{"node": "ğŸª Buscar Restaurante", "type": "main", "index": 0}]]
    },
    "ğŸª Buscar Restaurante": {
      "main": [[{"node": "ğŸ” Buscar Cliente", "type": "main", "index": 0}]]
    },
    "ğŸ” Buscar Cliente": {
      "main": [[{"node": "â“ Â¿Cliente Existe?", "type": "main", "index": 0}]]
    },
    "â“ Â¿Cliente Existe?": {
      "main": [
        [{"node": "â• Crear Cliente", "type": "main", "index": 0}],
        [{"node": "ğŸ”— Fusionar Cliente", "type": "main", "index": 0}]
      ]
    },
    "â• Crear Cliente": {
      "main": [[{"node": "ğŸ”— Fusionar Cliente", "type": "main", "index": 0}]]
    },
    "ğŸ”— Fusionar Cliente": {
      "main": [[{"node": "ğŸ“… Get Reservas Activas", "type": "main", "index": 0}]]
    },
    "ğŸ“… Get Reservas Activas": {
      "main": [[{"node": "ğŸ“¦ Preparar Contexto BAPI", "type": "main", "index": 0}]]
    },
    "ğŸ“¦ Preparar Contexto BAPI": {
      "main": [[{"node": "âœ… Responder a BAPI", "type": "main", "index": 0}]]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "meta": {
    "instanceId": "968c65341fc947850f62b4a42d249947219a244717952c0dbaf2b62952e73bd9"
  }
}

