# üîç AUDITOR√çA COMPLETA - SISTEMA DE CONSULTA DE DISPONIBILIDADES PARA AGENTE IA

**Fecha:** 15 de Octubre 2025  
**Estado:** üìã AN√ÅLISIS PREVIO - NO CODIFICAR  
**Objetivo:** Crear TOOL-7 para consultar disponibilidades desde WhatsApp/VAPI

---

## üìä RESUMEN EJECUTIVO

### ‚úÖ LO QUE TENEMOS (ACTUAL)

#### 1. **TABLA PRINCIPAL: `availability_slots`**
- ‚úÖ **Existe y funciona perfectamente**
- ‚úÖ **4,550+ slots** generados para 90 d√≠as
- ‚úÖ **Multi-tenant** con RLS habilitado
- ‚úÖ **Estados:** `free`, `reserved`, `blocked`
- ‚úÖ **Mantenimiento autom√°tico diario** (pg_cron a las 4 AM)

**Estructura:**
```sql
availability_slots
‚îú‚îÄ‚îÄ id (UUID)
‚îú‚îÄ‚îÄ restaurant_id (UUID) ‚Üê FILTRO OBLIGATORIO
‚îú‚îÄ‚îÄ slot_date (DATE) ‚Üê Fecha del slot
‚îú‚îÄ‚îÄ start_time (TIME) ‚Üê Hora inicio
‚îú‚îÄ‚îÄ end_time (TIME) ‚Üê Hora fin
‚îú‚îÄ‚îÄ table_id (UUID) ‚Üê FK a tables
‚îú‚îÄ‚îÄ shift_name (TEXT) ‚Üê "Comida", "Cena", etc.
‚îú‚îÄ‚îÄ status (TEXT) ‚Üê 'free', 'reserved', 'blocked'
‚îú‚îÄ‚îÄ duration_minutes (INT) ‚Üê Duraci√≥n (default: 90)
‚îú‚îÄ‚îÄ metadata (JSONB)
‚îî‚îÄ‚îÄ created_at, updated_at
```

**√çndices:**
```sql
idx_availability_slots_restaurant_date (restaurant_id, slot_date)
idx_availability_slots_status (status)
idx_availability_slots_table (table_id)
```

#### 2. **TABLAS DE SOPORTE**

**`tables`** - Mesas del restaurante
```sql
tables
‚îú‚îÄ‚îÄ id (UUID)
‚îú‚îÄ‚îÄ restaurant_id (UUID)
‚îú‚îÄ‚îÄ table_number (TEXT)
‚îú‚îÄ‚îÄ capacity (INT) ‚Üê Capacidad personas
‚îú‚îÄ‚îÄ zone (VARCHAR) ‚Üê 'terraza', 'interior', etc.
‚îú‚îÄ‚îÄ is_active (BOOLEAN)
‚îî‚îÄ‚îÄ location (TEXT)
```

**`restaurant_operating_hours`** - Horarios semanales
```sql
restaurant_operating_hours
‚îú‚îÄ‚îÄ restaurant_id (UUID)
‚îú‚îÄ‚îÄ day_of_week (INT) ‚Üê 0=domingo, 6=s√°bado
‚îú‚îÄ‚îÄ is_closed (BOOLEAN)
‚îî‚îÄ‚îÄ shifts (JSONB) ‚Üê Array de turnos
```

**`special_events`** - D√≠as especiales (festivos, cierres)
```sql
special_events
‚îú‚îÄ‚îÄ restaurant_id (UUID)
‚îú‚îÄ‚îÄ event_date (DATE)
‚îú‚îÄ‚îÄ is_closed (BOOLEAN)
‚îú‚îÄ‚îÄ event_type (TEXT) ‚Üê 'holiday', 'closure', etc.
‚îî‚îÄ‚îÄ description (TEXT)
```

#### 3. **SERVICIOS EXISTENTES**

**`AvailabilityService.js`** (Frontend)
- ‚úÖ `checkAvailability()` - Verifica disponibilidad para fecha/hora
- ‚úÖ `getAvailabilitySlots()` - Obtiene slots de un d√≠a
- ‚úÖ `getAvailableTimeSlots()` - Horarios agrupados por turno
- ‚úÖ `validateBookingTime()` - Valida restricciones

**`ConflictDetectionService.js`**
- ‚úÖ `validateReservationAvailability()` - Valida conflictos

**`ReservationValidationService.js`**
- ‚úÖ `getAvailableTables()` - Mesas disponibles sin depender de slots

#### 4. **FUNCIONES SQL (RPC)**

**Verificadas en c√≥digo:**
- ‚úÖ `check_availability(p_restaurant_id, p_date, p_time, p_party_size, p_duration_minutes)`
- ‚úÖ `generate_availability_slots_simple(p_restaurant_id, p_start_date, p_end_date)`
- ‚úÖ `get_unique_slot_dates(p_restaurant_id, p_from_date)`

---

## üéØ LO QUE NECESITAMOS CREAR

### **TOOL-7: Consultar Disponibilidad**

#### **Entrada (desde Agente IA):**
```json
{
  "reserva_fecha": "2025-10-16",
  "reserva_hora": "20:00",
  "reserva_invitados": 4,
  "reserva_ubicacion": "terraza" // OPCIONAL
}
```

#### **Proceso:**
1. ‚úÖ **Slot Exacto Disponible** ‚Üí Respuesta afirmativa
2. ‚ùå **Slot Exacto Ocupado** ‚Üí Buscar alternativas del mismo d√≠a
3. ‚ùå **Sin alternativas** ‚Üí Sugerir otro d√≠a

#### **Salida:**
```json
{
  "disponible": true/false,
  "mensaje": "Hay disponibilidad para...",
  "alternativas": ["20:30", "21:00", "21:30"], // Si aplica
  "sugerencia": "otro_dia" // Si no hay nada
}
```

---

## üîç AN√ÅLISIS DE DATOS REALES

### **¬øQU√â DATOS NECESITAMOS?**

#### 1. **FILTROS OBLIGATORIOS**
- ‚úÖ `restaurant_id` (UUID) ‚Üê Del contexto del agente
- ‚úÖ `reserva_fecha` (DATE) ‚Üê Del mensaje del cliente
- ‚úÖ `reserva_hora` (TIME) ‚Üê Del mensaje del cliente
- ‚úÖ `reserva_invitados` (INT) ‚Üê Del mensaje del cliente

#### 2. **FILTROS OPCIONALES**
- üî∂ `reserva_ubicacion` (TEXT) ‚Üê "terraza", "interior", etc.
  - **SI SE PROPORCIONA:** Filtrar por `tables.zone`
  - **SI NO:** Buscar en todas las zonas

#### 3. **CAMPOS A CONSULTAR**
```sql
SELECT 
  a.id,
  a.slot_date,
  a.start_time,
  a.end_time,
  a.status,
  a.shift_name,
  t.id as table_id,
  t.table_number,
  t.capacity,
  t.zone,
  t.location
FROM availability_slots a
INNER JOIN tables t ON a.table_id = t.id
WHERE 
  a.restaurant_id = :restaurant_id
  AND a.slot_date = :fecha
  AND a.start_time = :hora
  AND a.status = 'free'
  AND t.is_active = true
  AND t.capacity >= :party_size
  AND (:zona IS NULL OR t.zone ILIKE :zona)
ORDER BY a.start_time ASC
```

---

## üß© L√ìGICA DEL WORKFLOW

### **PASO 1: Validar Input**
```javascript
// Verificar campos requeridos
const required = ['reserva_fecha', 'reserva_hora', 'reserva_invitados'];
const missing = required.filter(f => !input[f]);
if (missing.length > 0) {
  throw new Error(`Campos faltantes: ${missing.join(', ')}`);
}

// Normalizar fecha (YYYY-MM-DD)
const fecha = normalizeDate(input.reserva_fecha);

// Normalizar hora (HH:MM)
const hora = normalizeTime(input.reserva_hora);

// Parsear invitados
const invitados = parseInt(input.reserva_invitados, 10);
```

### **PASO 2: Buscar Slot Exacto**
```javascript
// Query a Supabase
const { data: slotsExactos, error } = await $supabase
  .from('availability_slots')
  .select(`
    id,
    slot_date,
    start_time,
    end_time,
    status,
    shift_name,
    tables!inner (
      id,
      table_number,
      capacity,
      zone,
      location,
      is_active
    )
  `)
  .eq('restaurant_id', restaurant_id)
  .eq('slot_date', fecha)
  .eq('start_time', hora)
  .eq('status', 'free')
  .eq('tables.is_active', true)
  .gte('tables.capacity', invitados);

// Si hay zona espec√≠fica, filtrar
if (input.reserva_ubicacion) {
  query = query.ilike('tables.zone', `%${input.reserva_ubicacion}%`);
}

if (error) throw error;
```

### **PASO 3: Evaluar Resultado**

#### **CASO A: Slot Exacto Disponible**
```javascript
if (slotsExactos && slotsExactos.length > 0) {
  return {
    disponible: true,
    mensaje: `Perfecto! Tenemos disponibilidad para ${invitados} personas el ${fecha} a las ${hora}.`,
    detalles: {
      fecha: fecha,
      hora: hora,
      personas: invitados,
      mesas_disponibles: slotsExactos.length,
      zona: slotsExactos[0].tables.zone
    }
  };
}
```

#### **CASO B: Slot Ocupado ‚Üí Buscar Alternativas**
```javascript
// Buscar otros horarios del mismo d√≠a
const { data: alternativas, error: altError } = await $supabase
  .from('availability_slots')
  .select(`
    start_time,
    tables!inner (capacity, zone, is_active)
  `)
  .eq('restaurant_id', restaurant_id)
  .eq('slot_date', fecha)
  .eq('status', 'free')
  .eq('tables.is_active', true)
  .gte('tables.capacity', invitados);

if (input.reserva_ubicacion) {
  query = query.ilike('tables.zone', `%${input.reserva_ubicacion}%`);
}

if (error) throw error;

// Agrupar por hora y devolver horarios √∫nicos
const horasDisponibles = [...new Set(alternativas.map(a => a.start_time))].sort();

if (horasDisponibles.length > 0) {
  return {
    disponible: false,
    mensaje: `Lo siento, no hay disponibilidad a las ${hora}. Te ofrezco estas alternativas para el ${fecha}:`,
    alternativas: horasDisponibles.slice(0, 5), // M√°ximo 5 opciones
    detalles: {
      fecha: fecha,
      hora_solicitada: hora,
      personas: invitados
    }
  };
}
```

#### **CASO C: Sin Disponibilidad en el D√≠a**
```javascript
return {
  disponible: false,
  mensaje: `Lo siento, no tenemos disponibilidad para ${invitados} personas el ${fecha}. ¬øTe gustar√≠a que busque para otro d√≠a?`,
  sugerencia: 'otro_dia',
  detalles: {
    fecha_solicitada: fecha,
    personas: invitados
  }
};
```

---

## üõ°Ô∏è VALIDACIONES Y MANEJO DE ERRORES

### **1. Validaci√≥n de Fecha**
```javascript
// ‚úÖ Verificar formato
if (!/^\d{4}-\d{2}-\d{2}$/.test(fecha)) {
  throw new Error('Formato de fecha inv√°lido. Usar YYYY-MM-DD');
}

// ‚úÖ Verificar que no sea pasado
const hoy = new Date().toISOString().split('T')[0];
if (fecha < hoy) {
  throw new Error('No se puede reservar en fechas pasadas');
}

// ‚úÖ Verificar antelaci√≥n m√°xima (90 d√≠as)
const maxDate = new Date();
maxDate.setDate(maxDate.getDate() + 90);
const maxDateStr = maxDate.toISOString().split('T')[0];
if (fecha > maxDateStr) {
  throw new Error('No se puede reservar con m√°s de 90 d√≠as de antelaci√≥n');
}
```

### **2. Validaci√≥n de Hora**
```javascript
// ‚úÖ Verificar formato HH:MM
if (!/^\d{2}:\d{2}$/.test(hora)) {
  throw new Error('Formato de hora inv√°lido. Usar HH:MM');
}

// ‚úÖ Verificar rango v√°lido
const [hh, mm] = hora.split(':').map(Number);
if (hh < 0 || hh > 23 || mm < 0 || mm > 59) {
  throw new Error('Hora fuera de rango v√°lido');
}
```

### **3. Validaci√≥n de Party Size**
```javascript
// ‚úÖ Verificar rango
if (invitados < 1 || invitados > 12) {
  throw new Error('N√∫mero de invitados debe estar entre 1 y 12');
}
```

### **4. Manejo de Errores de Supabase**
```javascript
try {
  const { data, error } = await $supabase...;
  
  if (error) {
    console.error('‚ùå Error Supabase:', error);
    throw new Error(`Error consultando disponibilidad: ${error.message}`);
  }
  
  if (!data || data.length === 0) {
    console.warn('‚ö†Ô∏è Sin resultados para:', { restaurant_id, fecha, hora });
  }
  
} catch (err) {
  console.error('‚ùå Excepci√≥n:', err);
  return {
    disponible: false,
    error: true,
    mensaje: 'Error al consultar disponibilidad. Por favor intenta de nuevo.',
    detalles: {
      error_message: err.message
    }
  };
}
```

---

## üîó INTEGRACI√ìN CON SUPER AGENT

### **Llamada desde Workflow 3:**
```javascript
// En el nodo de herramientas, cuando GPT-4o llama a "consultar_disponibilidad"
const toolResult = await $execution.executeWorkflow('TOOL-7-consultar-disponibilidad', {
  restaurant_id: $json.restaurant_id,
  reserva_fecha: toolCall.arguments.fecha,
  reserva_hora: toolCall.arguments.hora,
  reserva_invitados: toolCall.arguments.invitados,
  reserva_ubicacion: toolCall.arguments.ubicacion || null
});
```

### **Respuesta al Agente:**
```json
{
  "toolCallId": "call_abc123",
  "result": {
    "disponible": true,
    "mensaje": "Perfecto! Tenemos disponibilidad...",
    "alternativas": [...],
    "detalles": {...}
  }
}
```

---

## üìã CHECKLIST DE IMPLEMENTACI√ìN

### **ANTES DE CREAR EL WORKFLOW:**
- [x] ‚úÖ Verificar estructura de `availability_slots` en Supabase
- [x] ‚úÖ Verificar estructura de `tables` en Supabase
- [x] ‚úÖ Confirmar que existen datos reales (4,550+ slots)
- [x] ‚úÖ Revisar `AvailabilityService.js` para entender l√≥gica frontend
- [x] ‚úÖ Revisar funciones SQL existentes
- [x] ‚úÖ Confirmar multi-tenant (filtro por `restaurant_id`)

### **AL CREAR EL WORKFLOW:**
- [ ] üî∂ **NODO 1:** Webhook/Trigger para recibir input
- [ ] üî∂ **NODO 2:** Validar y normalizar input
- [ ] üî∂ **NODO 3:** Buscar slot exacto (Supabase Node)
- [ ] üî∂ **NODO 4:** IF - ¬øSlot disponible?
  - [ ] ‚Üí **TRUE:** Formatear respuesta positiva
  - [ ] ‚Üí **FALSE:** Buscar alternativas
- [ ] üî∂ **NODO 5:** Buscar alternativas del mismo d√≠a
- [ ] üî∂ **NODO 6:** IF - ¬øHay alternativas?
  - [ ] ‚Üí **TRUE:** Formatear respuesta con alternativas
  - [ ] ‚Üí **FALSE:** Respuesta "sin disponibilidad"
- [ ] üî∂ **NODO 7:** Respond to Workflow (return result)

### **AL PROBAR:**
- [ ] ‚ö†Ô∏è Probar con slot exacto disponible
- [ ] ‚ö†Ô∏è Probar con slot ocupado ‚Üí alternativas
- [ ] ‚ö†Ô∏è Probar sin disponibilidad en el d√≠a
- [ ] ‚ö†Ô∏è Probar con zona espec√≠fica (terraza/interior)
- [ ] ‚ö†Ô∏è Probar con fecha pasada (debe fallar)
- [ ] ‚ö†Ô∏è Probar con fecha futura > 90 d√≠as (debe fallar)
- [ ] ‚ö†Ô∏è Probar con party_size > capacidad m√°xima mesa

---

## üö® REGLAS DE ORO APLICADAS

### **NORMA 1: Ajustes Quir√∫rgicos**
‚úÖ **NO** vamos a modificar la estructura existente  
‚úÖ **NO** vamos a simplificar el sistema de disponibilidades  
‚úÖ **S√ç** vamos a crear una herramienta que USE el sistema existente

### **NORMA 2: Datos Reales**
‚úÖ **TODOS** los datos vienen de `availability_slots`  
‚úÖ **CERO** hardcoding de valores  
‚úÖ **CERO** datos ficticios o moqueados

### **NORMA 3: Multi-Tenant**
‚úÖ **SIEMPRE** filtrar por `restaurant_id`  
‚úÖ **NUNCA** hardcodear restaurant_id  
‚úÖ Funciona para **TODOS** los restaurantes

### **NORMA 4: Revisar Supabase Antes**
‚úÖ **CONFIRMADO:** `availability_slots` existe  
‚úÖ **CONFIRMADO:** `tables` existe  
‚úÖ **CONFIRMADO:** √çndices correctos  
‚úÖ **CONFIRMADO:** Datos reales (4,550+ slots)

---

## üí° RECOMENDACIONES

### **1. Usar Supabase Node vs. Code Node**
- ‚úÖ **Preferir Supabase Node** para queries simples (mejor performance, m√°s legible)
- ‚ö†Ô∏è **Code Node solo** si necesitas l√≥gica compleja de transformaci√≥n

### **2. Estructura del Workflow**
```
[Webhook] 
  ‚Üí [Validar Input]
  ‚Üí [Buscar Slot Exacto (Supabase)]
  ‚Üí [IF: ¬øDisponible?]
      ‚îú‚îÄ TRUE ‚Üí [Respuesta Positiva]
      ‚îî‚îÄ FALSE ‚Üí [Buscar Alternativas (Supabase)]
          ‚Üí [IF: ¬øHay Alternativas?]
              ‚îú‚îÄ TRUE ‚Üí [Respuesta con Alternativas]
              ‚îî‚îÄ FALSE ‚Üí [Respuesta "Otro D√≠a"]
```

### **3. Optimizaciones**
- ‚úÖ Usar `LIMIT 1` cuando solo necesites saber si existe disponibilidad
- ‚úÖ Usar `SELECT DISTINCT start_time` para alternativas (evita duplicados)
- ‚úÖ Ordenar por `start_time ASC` (horarios cronol√≥gicos)
- ‚úÖ Limitar alternativas a 5 m√°ximo (no abrumar al cliente)

### **4. Mensajes al Cliente**
```javascript
// ‚úÖ BIEN: Claro y accionable
"Perfecto! Tenemos disponibilidad para 4 personas el viernes 16 a las 20:00."

// ‚úÖ BIEN: Alternativas claras
"Lo siento, no hay mesa a las 20:00. Te ofrezco estas opciones para el mismo d√≠a: 20:30, 21:00, 21:30."

// ‚úÖ BIEN: Sin disponibilidad
"Lo siento, no tenemos disponibilidad para 4 personas el viernes 16. ¬øTe gustar√≠a que busque para otro d√≠a?"

// ‚ùå MAL: Vago
"No disponible"

// ‚ùå MAL: T√©cnico
"Error: No se encontraron slots libres en availability_slots"
```

---

## üìä DATOS DE EJEMPLO (PRODUCCI√ìN ACTUAL)

### **Caso 1: Slot Exacto Disponible**
```json
{
  "restaurant_id": "d6b63130-1ebf-4284-98fc-a3b31a85d9d1",
  "reserva_fecha": "2025-10-18",
  "reserva_hora": "20:00",
  "reserva_invitados": 4
}
```
**Resultado esperado:** ‚úÖ Disponibilidad confirmada

### **Caso 2: Slot Ocupado ‚Üí Alternativas**
```json
{
  "restaurant_id": "d6b63130-1ebf-4284-98fc-a3b31a85d9d1",
  "reserva_fecha": "2025-10-18",
  "reserva_hora": "20:00",
  "reserva_invitados": 4
}
```
**Resultado esperado:** ‚ö†Ô∏è Alternativas (20:30, 21:00, 21:30)

### **Caso 3: Sin Disponibilidad**
```json
{
  "restaurant_id": "d6b63130-1ebf-4284-98fc-a3b31a85d9d1",
  "reserva_fecha": "2025-12-31",
  "reserva_hora": "21:00",
  "reserva_invitados": 10
}
```
**Resultado esperado:** ‚ùå Sugerir otro d√≠a

---

## ‚úÖ CONCLUSI√ìN

### **RESUMEN:**
1. ‚úÖ **Sistema de disponibilidades completo** ya existe
2. ‚úÖ **Datos reales** (4,550+ slots) en producci√≥n
3. ‚úÖ **Tablas correctas** (`availability_slots`, `tables`)
4. ‚úÖ **Multi-tenant** con RLS habilitado
5. ‚úÖ **Servicios frontend** para referencia

### **PR√ìXIMO PASO:**
üöÄ **CREAR WORKFLOW TOOL-7** siguiendo esta documentaci√≥n

### **TIEMPO ESTIMADO:**
‚è±Ô∏è **2-3 horas** para implementaci√≥n completa y testing

---

**√öltima actualizaci√≥n:** 15 de Octubre 2025  
**Estado:** ‚úÖ AUDITOR√çA COMPLETA  
**Listo para:** üöÄ IMPLEMENTACI√ìN


