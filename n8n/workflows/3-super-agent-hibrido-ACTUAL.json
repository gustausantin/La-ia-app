{
  "nodes": [
    {
      "parameters": {},
      "id": "16b080ee-ad3f-4961-99b4-742802dd5368",
      "name": "‚ñ∂Ô∏è Start (from Gateway)",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [
        -1168,
        -96
      ]
    },
    {
      "parameters": {
        "jsCode": "// Preparar datos para el clasificador\nconst data = $input.item.json;\n\nconsole.log('üì• Datos recibidos del Gateway:', {\n  customer: data.customer_name,\n  phone: data.customer_phone,\n  message: data.user_message?.substring(0, 100)\n});\n\nreturn {\n  conversation_id: data.conversation_id,\n  customer_id: data.customer_id,\n  customer_name: data.customer_name,\n  customer_phone: data.customer_phone,\n  restaurant_id: data.restaurant_id,\n  channel: data.channel,\n  user_message: data.user_message,\n  timestamp: data.timestamp\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -976,
        -96
      ],
      "id": "15f3e0c0-28b3-4e2d-8a08-cc7d5bd544d0",
      "name": "üìã Preparar Input"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {
          "maxTokens": 200,
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -768,
        144
      ],
      "id": "83a6d972-3fd3-4332-8f79-eb076871f823",
      "name": "üß† LLM Classifier (GPT-4o-mini)",
      "credentials": {
        "openAiApi": {
          "id": "zwtmjTlXACMvkqZx",
          "name": "OpenAi La-IA"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Parsear clasificaci√≥n del LLM\nconst inputData = $('üìã Preparar Input').item.json;\nconst llmResponse = $input.item.json.response || $input.item.json.text || '{}';\n\n// Limpiar markdown si lo hay\nlet cleanedResponse = llmResponse.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n\n// Parsear JSON\nlet classification;\ntry {\n  classification = JSON.parse(cleanedResponse);\n  console.log('‚úÖ Clasificaci√≥n exitosa:', classification);\n} catch (e) {\n  console.error('‚ùå Error parseando clasificaci√≥n:', e);\n  console.error('Respuesta recibida:', cleanedResponse);\n  classification = {\n    intent: 'consulta_general',\n    entities: {},\n    sentiment: 'neutral',\n    confidence: 0.5,\n    reasoning: 'Error en clasificaci√≥n, usando default'\n  };\n}\n\nreturn {\n  ...inputData,\n  classification: classification,\n  intent: classification.intent,\n  entities: classification.entities,\n  sentiment: classification.sentiment,\n  confidence: classification.confidence\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -480,
        -96
      ],
      "id": "0b573a19-ec5e-4a9b-a477-4db63b45f662",
      "name": "üìä Parsear Clasificaci√≥n"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "reservations",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "customer_phone",
              "condition": "eq",
              "keyValue": "={{ $json.customer_phone }}"
            },
            {
              "keyName": "restaurant_id",
              "condition": "eq",
              "keyValue": "={{ $json.restaurant_id }}"
            },
            {
              "keyName": "status",
              "condition": "in",
              "keyValue": "pending,confirmed,pending_approval"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -208,
        -240
      ],
      "id": "46da1939-7991-43a8-898b-f2618cfc3720",
      "name": "üìÖ Obtener Reservas Cliente",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "restaurants",
        "filters": {
          "conditions": [
            {
              "keyName": "id",
              "keyValue": "={{ $('üìä Parsear Clasificaci√≥n').item.json.restaurant_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -208,
        -32
      ],
      "id": "503a606d-f30c-48bc-8c22-0ea052481d38",
      "name": "üè™ Obtener Info Restaurante",
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "restaurant_operating_hours",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "restaurant_id",
              "condition": "eq",
              "keyValue": "={{ $('üìä Parsear Clasificaci√≥n').item.json.restaurant_id }}"
            },
            {
              "keyName": "is_open",
              "condition": "eq",
              "keyValue": "true"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -208,
        192
      ],
      "id": "5f76ac50-b16b-49d9-8a18-4bad25d06be0",
      "name": "üïê Obtener Horarios",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Fusionar todo el contexto enriquecido\nconst classifiedData = $('üìä Parsear Clasificaci√≥n').item.json;\nconst reservations = $('üìÖ Obtener Reservas Cliente').all().map(r => r.json);\nconst restaurant = $('üè™ Obtener Info Restaurante').item.json;\nconst operatingHours = $('üïê Obtener Horarios').all().map(h => h.json);\n\nconst settings = restaurant.settings || {};\nconst channels = restaurant.channels || {};\n\n// Preparar resumen de reservas activas\nconst reservationsSummary = reservations.length > 0 \n  ? reservations.map(r => `- ID: ${r.id.substring(0, 8)}... | ${r.reservation_date} a las ${r.reservation_time} | ${r.party_size} personas | Estado: ${r.status}`).join('\\n')\n  : 'No tiene reservas activas';\n\n// Preparar horarios\nconst hoursSummary = operatingHours.length > 0\n  ? operatingHours.map(h => `${h.day_of_week}: ${h.open_time} - ${h.close_time}`).join(', ')\n  : 'No disponible';\n\n// Contexto final enriquecido\nconst enrichedContext = {\n  // Datos originales\n  conversation_id: classifiedData.conversation_id,\n  customer_id: classifiedData.customer_id,\n  customer_name: classifiedData.customer_name,\n  customer_phone: classifiedData.customer_phone,\n  restaurant_id: classifiedData.restaurant_id,\n  channel: classifiedData.channel,\n  user_message: classifiedData.user_message,\n  timestamp: classifiedData.timestamp,\n  \n  // Clasificaci√≥n del LLM\n  classification: {\n    intent: classifiedData.intent,\n    entities: classifiedData.entities,\n    sentiment: classifiedData.sentiment,\n    confidence: classifiedData.confidence,\n    reasoning: classifiedData.classification.reasoning\n  },\n  \n  // Contexto del cliente\n  customer_context: {\n    has_active_reservations: reservations.length > 0,\n    reservations_count: reservations.length,\n    reservations: reservations,\n    reservations_summary: reservationsSummary\n  },\n  \n  // Contexto del restaurante\n  restaurant_context: {\n    id: restaurant.id,\n    name: restaurant.name,\n    address: restaurant.address,\n    phone: restaurant.phone,\n    email: restaurant.email,\n    whatsapp: channels.whatsapp?.phone_number || '',\n    operating_hours: operatingHours,\n    hours_summary: hoursSummary,\n    settings: settings,\n    agent_name: settings.agent_name || 'el asistente virtual'\n  }\n};\n\nconsole.log('‚úÖ Contexto enriquecido completo:', {\n  intent: enrichedContext.classification.intent,\n  confidence: enrichedContext.classification.confidence,\n  active_reservations: enrichedContext.customer_context.reservations_count,\n  sentiment: enrichedContext.classification.sentiment\n});\n\nreturn enrichedContext;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        64,
        -48
      ],
      "id": "549b50f0-01da-4fde-b558-ad90237fd229",
      "name": "üîó Fusionar Contexto Enriquecido"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Eres el asistente virtual de **{{ $json.restaurant_context.name }}**, un restaurante profesional.\n\n---\n\n## üìã CONTEXTO DEL CLIENTE\n- **Nombre**: {{ $json.customer_name }}\n- **Tel√©fono**: {{ $json.customer_phone }}\n- **Reservas activas**: {{ $json.customer_context.reservations_count }}\n\n{{ $json.customer_context.reservations_summary }}\n\n---\n\n## üè™ INFORMACI√ìN DEL RESTAURANTE\n- **Nombre**: {{ $json.restaurant_context.name }}\n- **Direcci√≥n**: {{ $json.restaurant_context.address }}\n- **Tel√©fono**: {{ $json.restaurant_context.phone }}\n- **Email**: {{ $json.restaurant_context.email }}\n- **Horarios**: {{ $json.restaurant_context.hours_summary }}\n\n---\n\n## üß† CLASIFICACI√ìN PRE-PROCESADA (del LLM Classifier)\n- **Intenci√≥n detectada**: {{ $json.classification.intent }}\n- **Confianza**: {{ $json.classification.confidence }}\n- **Sentimiento**: {{ $json.classification.sentiment }}\n- **Razonamiento**: {{ $json.classification.reasoning }}\n\n**Entidades extra√≠das**:\n{{#if $json.classification.entities.date}}- Fecha: {{ $json.classification.entities.date }}{{/if}}\n{{#if $json.classification.entities.time}}- Hora: {{ $json.classification.entities.time }}{{/if}}\n{{#if $json.classification.entities.party_size}}- Personas: {{ $json.classification.entities.party_size }}{{/if}}\n{{#if $json.classification.entities.reservation_id}}- ID Reserva: {{ $json.classification.entities.reservation_id }}{{/if}}\n\n---\n\n## üõ†Ô∏è HERRAMIENTAS DISPONIBLES\nDispones de las siguientes herramientas especializadas:\n\n1. **create_reservation**: Crear una nueva reserva (requiere: date, time, party_size)\n2. **modify_reservation**: Modificar una reserva existente (requiere: reservation_id)\n3. **cancel_reservation**: Cancelar una reserva (requiere: reservation_id)\n4. **check_availability**: Consultar disponibilidad (requiere: date, time, party_size)\n5. **get_restaurant_info**: Obtener informaci√≥n del restaurante\n\n---\n\n## üìù INSTRUCCIONES DE COMPORTAMIENTO\n\n**Tu misi√≥n**:\n- Ayudar al cliente de forma amable, profesional y eficiente\n- Usar las herramientas cuando sea necesario seg√∫n la intenci√≥n clasificada\n- Mantener una conversaci√≥n natural y fluida\n- Si la clasificaci√≥n indica \"nueva_reserva\" y tienes todas las entidades (fecha, hora, personas), usa directamente create_reservation\n- Si falta informaci√≥n, preg√∫ntala de forma amable\n- Si el sentimiento es \"urgent\" o \"negative\", prioriza y s√© m√°s emp√°tico\n- Puedes usar m√∫ltiples herramientas en una misma conversaci√≥n si es necesario\n\n**Tono de voz**:\n- Profesional pero cercano\n- Breve y al grano\n- Emp√°tico si el cliente est√° molesto\n\n---\n\n## üí¨ MENSAJE DEL CLIENTE\n{{ $json.user_message }}\n\n---\n\n**AHORA RESPONDE AL CLIENTE DE FORMA NATURAL, USANDO LAS HERRAMIENTAS CUANDO SEA NECESARIO:**",
        "options": {
          "systemMessage": "=Eres {{ $json.restaurant_context.agent_name || 'el asistente virtual' }}, la asistente de IA del restaurante \"{{ $json.restaurant_context.name }}\". Tu misi√≥n es ser la mejor recepcionista posible: amable, eficiente, precisa y profesional. Tu objetivo es la excelencia absoluta en cada interacci√≥n por {{ $json.channel === 'whatsapp' ? 'WhatsApp' : 'tel√©fono' }}.\n\n---\n\nüìú DIRECTIVA CENTRAL: LA CHECKLIST DE RESERVA\n\nTu objetivo principal es completar una \"Checklist de Reserva\". No puedes considerar tu trabajo terminado hasta que todos los puntos de esta checklist est√©n marcados.\n\n**Checklist de Reserva Obligatoria:**\n[ ] Datos b√°sicos recopilados (d√≠a, hora, personas, ubicaci√≥n/mesa).\n[ ] Disponibilidad confirmada con la herramienta check_availability.\n[ ] Nombre de la reserva obtenido.\n[ ] Notas adicionales obtenidas o confirmadas que no hay.\n[ ] Todas las preguntas del cliente respondidas usando las herramientas de consulta.\n[ ] Llamada final a la herramienta create_reservation realizada.\n\n---\n\nüé≠ PERSONALIDAD Y TONO\n\n**Caracter√≠sticas principales:**\n- **Profesional pero cercana**: Equilibrio perfecto entre formalidad y calidez.\n- **Paciente y clara**: Nunca te apresuras, siempre explicas bien.\n- **Resolutiva y positiva**: Encuentras soluciones, no problemas.\n- **Confiable y tranquilizadora**: Transmites seguridad en cada interacci√≥n.\n\n**Estilo de comunicaci√≥n:**\n- Frases concisas, naturales y directas.\n- **Una pregunta a la vez**: Nunca agobies al cliente.\n- Nunca des todas las opciones de entrada; deja que el cliente se explique y luego, si hace falta, gu√≠a t√∫.\n- Lenguaje natural: Evita jerga t√©cnica y evita sonar a formulario.\n- Actitud proactiva: Te anticipas a las necesidades, pero nunca interrumpes ni bombardeas con preguntas.\n- Si el cliente pide algo fuera de las reglas (d√≠a no disponible, n√∫mero de personas incorrecto, etc.), lo corriges con amabilidad y explicas las opciones reales.\n\n---\n\nüß† PRINCIPIOS FUNDAMENTALES\n\n**Memoria de Elefante:**\n- Nunca olvidas informaci√≥n ya proporcionada.\n- Nunca repites preguntas sobre datos ya obtenidos.\n- Mant√©n el contexto durante toda la conversaci√≥n.\n\n**Claridad Absoluta:**\n- Una pregunta por turno; espera siempre respuesta antes de continuar.\n- Confirmaciones claras: Resume antes de proceder.\n- Comunicaci√≥n directa y comprensible; sin ambig√ºedades.\n\n**Precisi√≥n Total:**\n- PROHIBIDO inventar informaci√≥n que no tengas en tu contexto o herramientas.\n- Solo das datos verificados.\n- Si no sabes algo, usa el protocolo de respuesta segura.\n\n**Protocolo de respuesta segura:**\n\"Lo siento, no dispongo de esa informaci√≥n espec√≠fica. Mi especialidad es gestionar reservas. ¬øPuedo ayudarte con algo m√°s?\"\n\n---\n\nüìö INFORMACI√ìN DEL RESTAURANTE\n\n**Datos del restaurante:**\n- Nombre: {{ $json.restaurant_context.name }}\n- Direcci√≥n: {{ $json.restaurant_context.address }}\n- Tel√©fono: {{ $json.restaurant_context.phone }}\n- Email: {{ $json.restaurant_context.email }}\n\n**Horarios de operaci√≥n:**\n{{ $json.restaurant_context.hours_summary }}\n\n**Configuraci√≥n de reservas:**\n- Duraci√≥n est√°ndar: {{ $json.restaurant_context.settings.reservation_duration || 90 }} minutos\n- Capacidad m√°xima por mesa: {{ $json.restaurant_context.settings.max_party_size || 8 }} personas\n- D√≠as disponibles: Consulta con la herramienta check_availability\n\n---\n\nüìã CONTEXTO DEL CLIENTE (YA DISPONIBLE)\n\n**Informaci√≥n del cliente:**\n- Nombre: {{ $json.customer_name }}\n- Tel√©fono: {{ $json.customer_phone }}\n\n{{#if $json.customer_context.has_active_reservations}}\n**Reservas activas del cliente:**\n{{ $json.customer_context.reservations_summary }}\n\nSi el cliente menciona \"mi reserva\" sin especificar, se refiere a alguna de estas.\n{{else}}\n**Este cliente NO tiene reservas activas actualmente.**\n{{/if}}\n\n---\n\nüß† CLASIFICACI√ìN PRE-PROCESADA (del LLM Classifier)\n\nYa se ha analizado el mensaje del cliente y se ha detectado:\n- **Intenci√≥n**: {{ $json.classification.intent }}\n- **Confianza**: {{ $json.classification.confidence }}\n- **Sentimiento**: {{ $json.classification.sentiment }}\n- **Razonamiento**: {{ $json.classification.reasoning }}\n\n**Entidades extra√≠das:**\n{{#if $json.classification.entities.date}}- Fecha: {{ $json.classification.entities.date }}{{/if}}\n{{#if $json.classification.entities.time}}- Hora: {{ $json.classification.entities.time }}{{/if}}\n{{#if $json.classification.entities.party_size}}- Personas: {{ $json.classification.entities.party_size }}{{/if}}\n{{#if $json.classification.entities.reservation_id}}- ID Reserva: {{ $json.classification.entities.reservation_id }}{{/if}}\n\n**Usa esta informaci√≥n PRE-PROCESADA para ser m√°s eficiente**, pero siempre confirma verbalmente con el cliente antes de actuar.\n\n---\n\nüõ†Ô∏è HERRAMIENTAS DISPONIBLES Y USO OBLIGATORIO\n\nTienes acceso a las siguientes herramientas especializadas. Es tu responsabilidad llamarlas con los par√°metros correctos.\n\n**1. check_availability**\n- **Funci√≥n**: Consulta si hay mesas disponibles en tiempo real.\n- **Uso**: DEBES usarla inmediatamente despu√©s de que el cliente te haya confirmado verbalmente los datos de la reserva (fecha, hora, personas).\n- **Par√°metros**:\n  - `date` (string): Fecha en formato YYYY-MM-DD\n  - `time` (string): Hora en formato HH:MM (24h)\n  - `party_size` (number): N√∫mero de personas\n\n**2. create_reservation**\n- **Funci√≥n**: Crea una nueva reserva en el sistema.\n- **Uso**: DEBES usarla como acci√≥n final, despu√©s de confirmar disponibilidad y obtener el nombre del cliente.\n- **Par√°metros**:\n  - `reservation_date` (string): Fecha en formato YYYY-MM-DD\n  - `reservation_time` (string): Hora en formato HH:MM\n  - `party_size` (number): N√∫mero de personas\n  - `special_requests` (string): Notas adicionales (puede ser vac√≠o \"\")\n\n**3. modify_reservation**\n- **Funci√≥n**: Modifica una reserva existente.\n- **Uso**: Cuando el cliente quiera cambiar fecha, hora o n√∫mero de personas.\n- **Par√°metros**:\n  - `reservation_id` (string): UUID de la reserva (usa la que tiene el cliente activa)\n  - `new_date` (string): Nueva fecha YYYY-MM-DD (opcional)\n  - `new_time` (string): Nueva hora HH:MM (opcional)\n  - `new_party_size` (number): Nuevo n√∫mero de personas (opcional)\n\n**4. cancel_reservation**\n- **Funci√≥n**: Cancela una reserva existente.\n- **Uso**: Cuando el cliente quiera cancelar su reserva.\n- **Par√°metros**:\n  - `reservation_id` (string): UUID de la reserva\n  - `cancellation_reason` (string): Motivo de cancelaci√≥n (opcional)\n\n**5. get_restaurant_info**\n- **Funci√≥n**: Obtiene informaci√≥n del restaurante (men√∫, servicios, parking, etc.).\n- **Uso**: Cuando el cliente pregunte por informaci√≥n general.\n- **Par√°metros**:\n  - `info_type` (string): Tipo de info: 'menu', 'servicios', 'ubicacion', 'horarios', 'parking', 'contacto'\n\n---\n\n*** FORMATO DE LLAMADA A HERRAMIENTAS (¬°MUY IMPORTANTE!) ***\n\nCuando llames a una herramienta, proporciona los par√°metros como un objeto JSON plano.\n\nEJEMPLO CORRECTO:\n```json\n{\n  \"date\": \"2025-10-15\",\n  \"time\": \"20:00\",\n  \"party_size\": 4\n}\n```\n\n---\n\nüó£Ô∏è FLUJO DE CONVERSACI√ìN PROFESIONAL\n\n**PASO 1: Saludo y detecci√≥n de intenci√≥n**\n\nMensaje de apertura profesional:\n\"¬°Hola {{ $json.customer_name }}! Soy {{ $json.restaurant_context.agent_name || 'el asistente' }} de {{ $json.restaurant_context.name }}. ¬øEn qu√© puedo ayudarte?\"\n\nSi ya has detectado la intenci√≥n (gracias al clasificador), puedes ser m√°s directo:\n- **nueva_reserva**: \"Perfecto, te ayudo encantada con tu reserva. ¬øQu√© d√≠a te gustar√≠a venir?\"\n- **modificar_reserva**: \"Claro, te ayudo a modificar tu reserva. ¬øQu√© te gustar√≠a cambiar?\"\n- **cancelar_reserva**: \"Entendido, voy a ayudarte con la cancelaci√≥n. ¬øEs sobre tu reserva del {{ primera_reserva_activa }}?\"\n- **consulta_menu**: \"Por supuesto, te ayudo con el men√∫. ¬øQu√© te gustar√≠a saber?\"\n\n**PASO 2: Proceso de reserva conversacional**\n\nRecoge los datos esenciales, **uno a uno**, con preguntas naturales:\n\n1. **Fecha**: \"¬øQu√© d√≠a te gustar√≠a venir?\"\n   - Si el clasificador ya extrajo una fecha, conf√≠rmala: \"¬øQuieres venir el {{ fecha_extra√≠da }}, correcto?\"\n   - Si elige un d√≠a no disponible, explica con amabilidad qu√© d√≠as est√°n disponibles.\n\n2. **Hora**: \"¬øA qu√© hora prefieres?\"\n   - Si ya tienes la hora del clasificador, conf√≠rmala.\n   - Si elige una hora no v√°lida, sugiere las horas disponibles.\n\n3. **N√∫mero de personas**: \"¬øCu√°ntos ser√©is?\"\n   - Si ya lo sabes, conf√≠rmalo.\n   - Si el n√∫mero no es v√°lido (muy grande o muy peque√±o), explica las opciones.\n\n**Siempre deja que el cliente responda antes de avanzar.**\n\nSi el cliente da varios datos a la vez, resume y confirma:\n\"Perfecto, entonces para {{ personas }} personas el {{ d√≠a }} a las {{ hora }}, ¬øcorrecto?\"\n\n**PASO 3: Verificaci√≥n y confirmaci√≥n**\n\nAntes de consultar disponibilidad:\n\"Genial, d√©jame confirmar: ser√≠a para {{ personas }} personas el {{ d√≠a }} a las {{ hora }}, ¬øverdad?\"\n\nSolo despu√©s de confirmaci√≥n expl√≠cita del cliente, contin√∫a.\n\n**PASO 4: Consulta de disponibilidad**\n\n\"Perfecto, dame un segundo que lo compruebo en el sistema...\"\n\nUsa la herramienta **check_availability**.\n\n- Si hay disponibilidad: \"¬°Estupendo! S√≠ tenemos disponibilidad para esa fecha y hora.\"\n- Si no hay disponibilidad: \"Veo que esa hora ya est√° completa. ¬øTe ir√≠a bien {{ hora_alternativa }}, o prefieres otro d√≠a?\"\n\n**PASO 5: Cierre de reserva**\n\nSi hay sitio, pide el nombre (si no lo tienes ya):\n\"Perfecto, {{ $json.customer_name }}. ¬øAlguna petici√≥n especial o nota que quieras a√±adir?\"\n\nCuando tengas todo:\n\"Genial. D√©jame confirmar tu reserva...\"\n\nUsa la herramienta **create_reservation** (es silenciosa, no avises al cliente).\n\nDespu√©s de ejecutarla:\n\"¬°Listo, {{ $json.customer_name }}! Tu reserva est√° confirmada para el {{ d√≠a }} a las {{ hora }} para {{ personas }} personas. Recibir√°s un WhatsApp de confirmaci√≥n en breve. ¬øPuedo ayudarte en algo m√°s?\"\n\n**PASO 6: Gesti√≥n de consultas en cualquier momento**\n\nSi el cliente hace una pregunta sobre men√∫, servicios, parking, etc.:\n- Usa la herramienta **get_restaurant_info** con el tipo correcto.\n- Responde de forma natural.\n- Luego retoma la reserva donde la dejaste.\n\n**PASO 7: Despedida profesional**\n\n\"Ha sido un placer ayudarte, {{ $json.customer_name }}. ¬°Que tengas un excelente d√≠a y nos vemos pronto en {{ $json.restaurant_context.name }}!\"\n\n---\n\nüîÑ ESCALADO\n\n**Cu√°ndo escalar:**\n- Cliente solicita hablar con una persona.\n- Muestra gran insatisfacci√≥n.\n- Situaci√≥n fuera de tu alcance.\n\n**Respuesta de escalado:**\n\"Por supuesto, te paso con el encargado. Un momento, por favor.\"\n\n(En producci√≥n, esto transferir√≠a la conversaci√≥n a un humano)\n\n---\n\n‚ùå PROHIBICIONES ESTRICTAS\n\n**NO Hagas:**\n- Usar jerga t√©cnica (\"funci√≥n\", \"par√°metro\", \"sistema\", \"herramienta\", etc.).\n- Decir frases robotizadas tipo \"Dime d√≠a, hora, personas\" en una sola pregunta.\n- Pedir datos que ya te han dado.\n- Repetir preguntas sobre datos ya obtenidos.\n- Inventar informaci√≥n que no est√© en tu contexto o herramientas.\n- Bombardear con preguntas o dar todas las opciones antes de que el cliente las pida.\n- Sonar como un bot o un formulario.\n\n**S√ç Haz:**\n- Escucha siempre primero.\n- Corrige solo cuando sea necesario y con amabilidad.\n- Mant√©n la conversaci√≥n fluida, humana y profesional.\n- Ofrece ayuda extra solo si ves que el cliente duda o lo necesita.\n- Usa las herramientas de forma transparente (el cliente no debe saber que existen).\n- Confirma siempre antes de ejecutar acciones irreversibles.\n\n---\n\nüéØ OBJETIVOS DE √âXITO\n\n- **Experiencia fluida**: Conversaci√≥n natural, sin fricciones.\n- **Datos precisos**: Informaci√≥n correcta y verificada.\n- **Cliente satisfecho**: Resoluci√≥n efectiva de necesidades.\n- **Reserva completada**: Proceso exitoso de principio a fin.\n- **Checklist completa**: Todos los puntos marcados.\n\n---\n\n**Recuerda:** Eres la recepcionista ideal: profesional, simp√°tica, natural y resolutiva. No eres un robot, ni un formulario, ni una m√°quina de preguntas. Tu trabajo es que cada cliente se sienta escuchado y bien atendido.\n\n---\n\nüí¨ MENSAJE DEL CLIENTE (a responder ahora):\n{{ $json.user_message }}\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        304,
        -48
      ],
      "id": "d866d913-a3d0-496b-b4a1-95dfa53307ae",
      "name": "ü§ñ Super Agent (GPT-4o)"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('üîó Fusionar Contexto Enriquecido').item.json.conversation_id }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        368,
        160
      ],
      "id": "3b6cfe5c-c805-4161-b9fb-183e59f07279",
      "name": "üí≠ Memory (por conversaci√≥n)"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o"
        },
        "options": {
          "maxTokens": 500,
          "temperature": 0.7
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        224,
        160
      ],
      "id": "739279f3-fdc3-4429-b65a-e498c845f5fd",
      "name": "OpenAI GPT-4o",
      "credentials": {
        "openAiApi": {
          "id": "zwtmjTlXACMvkqZx",
          "name": "OpenAi La-IA"
        }
      }
    },
    {
      "parameters": {
        "name": "create_reservation",
        "description": "Crea una nueva reserva en el restaurante. Usa esta herramienta cuando el cliente quiera hacer una reserva y tengas fecha, hora y n√∫mero de personas.",
        "workflowId": {
          "__rl": true,
          "value": "TOOL_CREATE_RESERVATION_ID",
          "mode": "id"
        },
        "fields": {
          "values": [
            {
              "name": "reservation_date"
            },
            {
              "name": "reservation_time"
            },
            {
              "name": "party_size"
            },
            {
              "name": "special_requests"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 1.2,
      "position": [
        992,
        560
      ],
      "id": "28a4751f-b94b-4393-b0f2-0e6c08b94d1e",
      "name": "üîß Tool: Crear Reserva"
    },
    {
      "parameters": {
        "name": "modify_reservation",
        "description": "Modifica una reserva existente. Usa esta herramienta cuando el cliente quiera cambiar fecha, hora o n√∫mero de personas de su reserva.",
        "workflowId": {
          "__rl": true,
          "value": "TOOL_MODIFY_RESERVATION_ID",
          "mode": "id"
        },
        "fields": {
          "values": [
            {
              "name": "reservation_id"
            },
            {
              "name": "new_date"
            },
            {
              "name": "new_time"
            },
            {
              "name": "new_party_size"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 1.2,
      "position": [
        832,
        560
      ],
      "id": "564ec96d-c0e1-45e4-9311-168e7da3d191",
      "name": "üîß Tool: Modificar Reserva"
    },
    {
      "parameters": {
        "name": "cancel_reservation",
        "description": "Cancela una reserva existente. Usa esta herramienta cuando el cliente quiera cancelar su reserva.",
        "workflowId": {
          "__rl": true,
          "value": "TOOL_CANCEL_RESERVATION_ID",
          "mode": "id"
        },
        "fields": {
          "values": [
            {
              "name": "reservation_id"
            },
            {
              "name": "cancellation_reason"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 1.2,
      "position": [
        656,
        560
      ],
      "id": "d03ba8a4-8744-4153-9f05-d9e934531cf9",
      "name": "üîß Tool: Cancelar Reserva"
    },
    {
      "parameters": {
        "name": "check_availability",
        "description": "Consulta la disponibilidad del restaurante para una fecha, hora y n√∫mero de personas espec√≠ficos. √ösala cuando el cliente pregunte si hay disponibilidad ANTES de crear la reserva.",
        "workflowId": {
          "__rl": true,
          "value": "TOOL_CHECK_AVAILABILITY_ID",
          "mode": "id"
        },
        "fields": {
          "values": [
            {
              "name": "date"
            },
            {
              "name": "time"
            },
            {
              "name": "party_size"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 1.2,
      "position": [
        496,
        560
      ],
      "id": "31900d07-d40e-4858-97aa-f4b0aef16e7c",
      "name": "üîß Tool: Consultar Disponibilidad"
    },
    {
      "parameters": {
        "name": "get_restaurant_info",
        "description": "Obtiene informaci√≥n del restaurante: horarios, men√∫, servicios, ubicaci√≥n, pol√≠ticas, etc. √ösala cuando el cliente pregunte informaci√≥n general.",
        "workflowId": {
          "__rl": true,
          "value": "TOOL_GET_INFO_ID",
          "mode": "id"
        },
        "fields": {
          "values": [
            {
              "name": "info_type"
            }
          ]
        }
      },
      "type": "@n8n/n8n-nodes-langchain.toolWorkflow",
      "typeVersion": 1.2,
      "position": [
        336,
        560
      ],
      "id": "1974d1f9-2ac5-4fbb-aa3a-80d76709f0e6",
      "name": "üîß Tool: Info Restaurante"
    },
    {
      "parameters": {
        "jsCode": "// Procesar respuesta del Super Agent\nconst agentResponse = $input.item.json;\nconst contextData = $('üîó Fusionar Contexto Enriquecido').item.json;\n\nconst finalMessage = agentResponse.output || agentResponse.text || 'Lo siento, no pude procesar tu solicitud. ¬øPodr√≠as reformular tu mensaje?';\n\nconsole.log('üì§ Respuesta del Super Agent:', finalMessage.substring(0, 150));\n\nreturn {\n  conversation_id: contextData.conversation_id,\n  customer_id: contextData.customer_id,\n  customer_phone: contextData.customer_phone,\n  customer_name: contextData.customer_name,\n  restaurant_id: contextData.restaurant_id,\n  channel: contextData.channel,\n  agent_response: finalMessage,\n  classification: contextData.classification,\n  timestamp: new Date().toISOString(),\n  \n  // Para env√≠o de WhatsApp\n  whatsapp_from: contextData.restaurant_context.whatsapp,\n  whatsapp_to: contextData.customer_phone\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        672,
        -48
      ],
      "id": "1312437a-0af7-4428-8f81-1cafec0b3431",
      "name": "üì§ Procesar Respuesta"
    },
    {
      "parameters": {
        "tableId": "agent_messages",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "conversation_id",
              "fieldValue": "={{ $json.conversation_id }}"
            },
            {
              "fieldId": "restaurant_id",
              "fieldValue": "={{ $json.restaurant_id }}"
            },
            {
              "fieldId": "direction",
              "fieldValue": "outbound"
            },
            {
              "fieldId": "sender",
              "fieldValue": "agent"
            },
            {
              "fieldId": "message_text",
              "fieldValue": "={{ $json.agent_response }}"
            },
            {
              "fieldId": "timestamp",
              "fieldValue": "={{ $json.timestamp }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        912,
        -112
      ],
      "id": "2bde45a1-5f57-4564-9569-2084a08ca8a0",
      "name": "üíæ Guardar Respuesta en BD",
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "agent_conversations",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "interaction_type",
              "fieldValue": "={{ $('üì§ Procesar Respuesta').item.json.classification.intent }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "active"
            },
            {
              "fieldId": "metadata",
              "fieldValue": "={{ JSON.stringify({ classification: $('üì§ Procesar Respuesta').item.json.classification, last_response_at: new Date().toISOString() }) }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        912,
        112
      ],
      "id": "1ff7959b-2549-4a53-bc47-2a5ae632bee7",
      "name": "üîÑ Actualizar Conversaci√≥n",
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.twilio.com/2010-04-01/Accounts/{{ $env.TWILIO_ACCOUNT_SID }}/Messages.json",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "From",
              "value": "=whatsapp:{{ $('üì§ Procesar Respuesta').item.json.whatsapp_from }}"
            },
            {
              "name": "To",
              "value": "=whatsapp:{{ $('üì§ Procesar Respuesta').item.json.whatsapp_to }}"
            },
            {
              "name": "Body",
              "value": "={{ $('üì§ Procesar Respuesta').item.json.agent_response }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1120,
        -112
      ],
      "id": "a1d57ea7-f177-47fa-b6c4-41ae346b68e5",
      "name": "üì± Enviar WhatsApp"
    },
    {
      "parameters": {
        "messages": {
          "messageValues": [
            {
              "message": "=Eres un clasificador experto de intenciones para un sistema de gesti√≥n de restaurantes. Tu √∫nica tarea es analizar el mensaje del cliente y devolver un JSON estructurado con la intenci√≥n, entidades extra√≠das y nivel de confianza.\n\n---\n\n## üìã CONTEXTO DISPONIBLE\n\n**Cliente:**\n- Nombre: {{ $json.customer_name }}\n- Tel√©fono: {{ $json.customer_phone }}\n\n**Fecha y hora actual:**\n- Fecha: {{ $now.format('yyyy-MM-dd') }} ({{ $now.format('EEEE') }})\n- Hora: {{ $now.format('HH:mm') }}\n\n**Mensaje del cliente:**\n\"{{ $json.user_message }}\"\n\n---\n\n## üéØ TU TAREA\n\nAnaliza el mensaje y devuelve un JSON con esta estructura exacta:\n\n```json\n{\n  \"intent\": \"nueva_reserva\",\n  \"entities\": {\n    \"date\": \"YYYY-MM-DD\",\n    \"time\": \"HH:MM\",\n    \"party_size\": 4,\n    \"reservation_id\": null\n  },\n  \"sentiment\": \"positive\",\n  \"confidence\": 0.95,\n  \"reasoning\": \"El cliente solicita expl√≠citamente una reserva con fecha y hora espec√≠ficas\"\n}\n```\n\n---\n\n## üìù INTENCIONES POSIBLES\n\n1. **nueva_reserva**: El cliente quiere hacer una nueva reserva\n   - Ejemplos: \"Quiero reservar\", \"Una mesa para 4\", \"Disponibilidad para hoy\", \"Ten√©is sitio ma√±ana?\"\n\n2. **modificar_reserva**: El cliente quiere cambiar una reserva existente\n   - Ejemplos: \"Cambiar mi reserva\", \"Mover la reserva de ma√±ana\", \"Modificar hora\", \"En vez de 4 seremos 6\"\n\n3. **cancelar_reserva**: El cliente quiere cancelar una reserva\n   - Ejemplos: \"Cancelar mi reserva\", \"No puedo ir\", \"Anular la mesa\", \"Tengo que cancelar\"\n\n4. **consulta_reserva**: El cliente pregunta por una reserva existente\n   - Ejemplos: \"Tengo reserva?\", \"Mi reserva es a qu√© hora?\", \"Confirmar reserva\", \"Cu√°l es mi reserva?\"\n\n5. **consulta_menu**: El cliente pregunta sobre el men√∫, platos, precios\n   - Ejemplos: \"Qu√© tienen de men√∫?\", \"Precio del men√∫\", \"Tienen opciones veganas?\", \"Qu√© platos tienen?\"\n\n6. **consulta_general**: Preguntas sobre ubicaci√≥n, horarios, servicios\n   - Ejemplos: \"D√≥nde est√°n?\", \"Horario de apertura\", \"Tienen terraza?\", \"C√≥mo llegar?\"\n\n7. **saludo**: Saludos sin intenci√≥n clara\n   - Ejemplos: \"Hola\", \"Buenos d√≠as\", \"Qu√© tal\", \"Hey\"\n\n---\n\n## üîç EXTRACCI√ìN DE ENTIDADES\n\n### **date** (string: YYYY-MM-DD o null)\n- Busca menciones de fechas: \"hoy\", \"ma√±ana\", \"pasado ma√±ana\", \"viernes\", \"el 15\", \"15 de octubre\"\n- Calcula la fecha exacta bas√°ndote en la fecha actual proporcionada\n- Ejemplos:\n  - \"ma√±ana\" ‚Üí calcular fecha de ma√±ana en formato YYYY-MM-DD\n  - \"viernes\" ‚Üí pr√≥ximo viernes en formato YYYY-MM-DD\n  - \"15 de octubre\" ‚Üí 2025-10-15\n  - \"el d√≠a 20\" ‚Üí 2025-10-20 (asumiendo mes actual si no se especifica)\n\n### **time** (string: HH:MM o null)\n- Busca menciones de horas: \"a las 8\", \"20:00\", \"8 de la noche\", \"mediod√≠a\"\n- Convierte siempre a formato 24h HH:MM\n- Ejemplos:\n  - \"a las 8 de la noche\" ‚Üí \"20:00\"\n  - \"8pm\" ‚Üí \"20:00\"\n  - \"mediod√≠a\" ‚Üí \"12:00\"\n  - \"a las 9\" ‚Üí \"21:00\" (si contexto indica noche) o \"09:00\" (si contexto indica ma√±ana)\n\n### **party_size** (number o null)\n- Busca menciones de n√∫mero de personas: \"para 4\", \"somos 6\", \"una mesa de 2\"\n- Extrae el n√∫mero exacto\n- Ejemplos:\n  - \"para 4 personas\" ‚Üí 4\n  - \"somos 6\" ‚Üí 6\n  - \"una mesa de 2\" ‚Üí 2\n  - \"para dos\" ‚Üí 2\n\n### **reservation_id** (string: UUID o null)\n- Solo si el cliente menciona un ID espec√≠fico de reserva o c√≥digo de confirmaci√≥n\n- En la mayor√≠a de casos ser√° null\n- Si menciona \"mi reserva\" sin ID, dejar en null (el sistema lo resolver√° despu√©s)\n\n---\n\n## üòä AN√ÅLISIS DE SENTIMIENTO\n\nClasifica el sentimiento del mensaje:\n\n- **positive**: Cliente amable, educado, entusiasta\n  - \"Me encantar√≠a reservar\", \"Muchas gracias\", \"Qu√© bien!\"\n\n- **neutral**: Cliente directo, sin emociones claras\n  - \"Quiero reservar\", \"Necesito una mesa\", \"Informaci√≥n horarios\"\n\n- **negative**: Cliente molesto, frustrado, decepcionado\n  - \"Esto es un desastre\", \"Muy mal servicio\", \"Estoy molesto\"\n\n- **urgent**: Cliente con urgencia, prisa, necesidad inmediata\n  - \"URGENTE\", \"Para hoy mismo\", \"Ya mismo\", \"Necesito ahora\"\n\n---\n\n## üìä NIVEL DE CONFIANZA (0.0 a 1.0)\n\nEval√∫a qu√© tan seguro est√°s de la clasificaci√≥n:\n\n- **0.9 - 1.0**: Mensaje muy claro, intenci√≥n expl√≠cita\n  - \"Quiero hacer una reserva para 4 personas ma√±ana a las 20:00\"\n\n- **0.7 - 0.9**: Mensaje claro, intenci√≥n evidente\n  - \"Necesito una mesa para ma√±ana\"\n\n- **0.5 - 0.7**: Mensaje con algo de ambig√ºedad\n  - \"Hola, para ma√±ana?\"\n\n- **0.0 - 0.5**: Mensaje muy ambiguo o poco claro\n  - \"Hola\", \"Info\"\n\n---\n\n## ‚ö†Ô∏è REGLAS IMPORTANTES\n\n1. **Fecha relativa**: Si dice \"hoy\", \"ma√±ana\", \"pasado ma√±ana\", calcula la fecha exacta usando la fecha actual proporcionada\n2. **Hora impl√≠cita**: Si dice \"a las 8\" sin especificar AM/PM, asume que es por la noche (20:00) si es contexto de restaurante\n3. **Prioridad**: Si el mensaje tiene m√∫ltiples intenciones, prioriza la m√°s espec√≠fica (ej: cancelar > consultar)\n4. **Entities null**: Si no puedes extraer una entidad con confianza, d√©jala en null\n5. **Sin markdown**: Responde SOLO con el JSON, sin ```json ni explicaciones adicionales\n\n---\n\n## ‚úÖ EJEMPLOS DE OUTPUT CORRECTO\n\n### Ejemplo 1:\n**Input**: \"Hola, quiero reservar una mesa para 4 personas ma√±ana a las 20:00\"\n**Output**:\n```json\n{\n  \"intent\": \"nueva_reserva\",\n  \"entities\": {\n    \"date\": \"2025-10-14\",\n    \"time\": \"20:00\",\n    \"party_size\": 4,\n    \"reservation_id\": null\n  },\n  \"sentiment\": \"positive\",\n  \"confidence\": 0.98,\n  \"reasoning\": \"Intenci√≥n clara de nueva reserva con todos los datos especificados\"\n}\n```\n\n### Ejemplo 2:\n**Input**: \"Necesito cancelar mi reserva\"\n**Output**:\n```json\n{\n  \"intent\": \"cancelar_reserva\",\n  \"entities\": {\n    \"date\": null,\n    \"time\": null,\n    \"party_size\": null,\n    \"reservation_id\": null\n  },\n  \"sentiment\": \"neutral\",\n  \"confidence\": 0.95,\n  \"reasoning\": \"Solicitud expl√≠cita de cancelaci√≥n sin datos adicionales\"\n}\n```\n\n### Ejemplo 3:\n**Input\": \"Ten√©is opciones veganas?\"\n**Output**:\n```json\n{\n  \"intent\": \"consulta_menu\",\n  \"entities\": {\n    \"date\": null,\n    \"time\": null,\n    \"party_size\": null,\n    \"reservation_id\": null\n  },\n  \"sentiment\": \"neutral\",\n  \"confidence\": 0.92,\n  \"reasoning\": \"Pregunta espec√≠fica sobre el men√∫\"\n}\n```\n\n### Ejemplo 4:\n**Input**: \"URGENTE necesito mesa para hoy a las 9\"\n**Output**:\n```json\n{\n  \"intent\": \"nueva_reserva\",\n  \"entities\": {\n    \"date\": \"2025-10-13\",\n    \"time\": \"21:00\",\n    \"party_size\": null,\n    \"reservation_id\": null\n  },\n  \"sentiment\": \"urgent\",\n  \"confidence\": 0.90,\n  \"reasoning\": \"Solicitud urgente de reserva para hoy, asumiendo 21:00 por contexto de cena\"\n}\n```\n\n---\n\n## üéØ AHORA ANALIZA Y RESPONDE\n\nAnaliza el mensaje del cliente proporcionado arriba y devuelve el JSON de clasificaci√≥n.\n\n**IMPORTANTE**: Responde √öNICAMENTE con el JSON, sin markdown, sin texto adicional, sin explicaciones.\n\n"
            }
          ]
        },
        "batching": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.7,
      "position": [
        -768,
        -96
      ],
      "id": "d9ae4260-d3fa-4a5a-abd9-1e3bef9c3102",
      "name": "Basic LLM Chain"
    }
  ],
  "connections": {
    "‚ñ∂Ô∏è Start (from Gateway)": {
      "main": [
        [
          {
            "node": "üìã Preparar Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìã Preparar Input": {
      "main": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üß† LLM Classifier (GPT-4o-mini)": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "üìä Parsear Clasificaci√≥n": {
      "main": [
        [
          {
            "node": "üìÖ Obtener Reservas Cliente",
            "type": "main",
            "index": 0
          },
          {
            "node": "üè™ Obtener Info Restaurante",
            "type": "main",
            "index": 0
          },
          {
            "node": "üïê Obtener Horarios",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üìÖ Obtener Reservas Cliente": {
      "main": [
        [
          {
            "node": "üîó Fusionar Contexto Enriquecido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üè™ Obtener Info Restaurante": {
      "main": [
        [
          {
            "node": "üîó Fusionar Contexto Enriquecido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üïê Obtener Horarios": {
      "main": [
        [
          {
            "node": "üîó Fusionar Contexto Enriquecido",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üîó Fusionar Contexto Enriquecido": {
      "main": [
        [
          {
            "node": "ü§ñ Super Agent (GPT-4o)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ü§ñ Super Agent (GPT-4o)": {
      "main": [
        [
          {
            "node": "üì§ Procesar Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üí≠ Memory (por conversaci√≥n)": {
      "ai_memory": [
        [
          {
            "node": "ü§ñ Super Agent (GPT-4o)",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI GPT-4o": {
      "ai_languageModel": [
        [
          {
            "node": "ü§ñ Super Agent (GPT-4o)",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "üîß Tool: Crear Reserva": {
      "ai_tool": [
        [
          {
            "node": "ü§ñ Super Agent (GPT-4o)",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "üîß Tool: Modificar Reserva": {
      "ai_tool": [
        [
          {
            "node": "ü§ñ Super Agent (GPT-4o)",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "üîß Tool: Cancelar Reserva": {
      "ai_tool": [
        [
          {
            "node": "ü§ñ Super Agent (GPT-4o)",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "üîß Tool: Consultar Disponibilidad": {
      "ai_tool": [
        [
          {
            "node": "ü§ñ Super Agent (GPT-4o)",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "üîß Tool: Info Restaurante": {
      "ai_tool": [
        [
          {
            "node": "ü§ñ Super Agent (GPT-4o)",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "üì§ Procesar Respuesta": {
      "main": [
        [
          {
            "node": "üíæ Guardar Respuesta en BD",
            "type": "main",
            "index": 0
          },
          {
            "node": "üîÑ Actualizar Conversaci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "üíæ Guardar Respuesta en BD": {
      "main": [
        [
          {
            "node": "üì± Enviar WhatsApp",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain": {
      "main": [
        [
          {
            "node": "üìä Parsear Clasificaci√≥n",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "968c65341fc947850f62b4a42d249947219a244717952c0dbaf2b62952e73bd9"
  }
}
