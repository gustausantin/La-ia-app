{
  "name": "07 - RAG Search Tool (Simple)",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -800,
        0
      ],
      "id": "13197e7d-15fc-45af-bb13-1c3e04394bcc",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// 🔍 VALIDAR INPUT DEL SUPER AGENT\n// =============================================\n\nconst input = $input.first().json;\n\nconsole.log('📥 Input recibido:', JSON.stringify(input, null, 2));\n\n// ========== VALIDACIONES ==========\nif (!input.restaurant_id) {\n  throw new Error('❌ restaurant_id es obligatorio');\n}\n\nif (!input.query) {\n  throw new Error('❌ query es obligatorio (pregunta del cliente)');\n}\n\nconsole.log('✅ Validación correcta');\nconsole.log('🏪 Restaurant ID:', input.restaurant_id);\nconsole.log('❓ Query:', input.query);\n\nreturn {\n  restaurant_id: input.restaurant_id,\n  query: input.query\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -600,
        0
      ],
      "id": "a73a984a-faef-482b-b478-91bc5f95fe6b",
      "name": "🔍 Validar Input"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "restaurant_knowledge_files",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "restaurant_id",
              "condition": "equals",
              "keyValue": "={{ $json.restaurant_id }}"
            },
            {
              "keyName": "status",
              "condition": "equals",
              "keyValue": "completed"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -400,
        0
      ],
      "id": "b1c2d3e4-f5a6-7890-b1c2-d3e4f5a67890",
      "name": "📥 Buscar Archivos",
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// 📄 EXTRAER Y CONCATENAR CONTENIDO\n// =============================================\n\nconst files = $input.all();\nconst validationData = $('🔍 Validar Input').first().json;\n\nconsole.log('📥 Archivos encontrados:', files.length);\n\nif (!files || files.length === 0) {\n  console.log('❌ No hay archivos procesados para este restaurante');\n  return {\n    success: false,\n    found: false,\n    answer: 'Lo siento, aún no tengo información cargada sobre el restaurante. El propietario debe subir los documentos primero.',\n    query: validationData.query\n  };\n}\n\n// Concatenar todo el contenido de todos los archivos\nlet allContent = '';\nconst filesList = [];\n\nfiles.forEach((file) => {\n  const data = file.json;\n  \n  // Aquí necesitamos descargar el contenido del archivo de Supabase Storage\n  // Por ahora, asumimos que ya tenemos el contenido en texto\n  // (En el workflow real, necesitaremos un nodo HTTP Request para descargar)\n  \n  filesList.push({\n    name: data.file_name,\n    category: data.category,\n    file_path: data.file_path\n  });\n});\n\nconsole.log('📚 Archivos a procesar:', filesList.length);\nconsole.log('📄 Archivos:', filesList.map(f => f.name).join(', '));\n\nreturn {\n  restaurant_id: validationData.restaurant_id,\n  query: validationData.query,\n  files: filesList,\n  files_count: filesList.length\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -200,
        0
      ],
      "id": "c2d3e4f5-a6b7-8901-c2d3-e4f5a6b78901",
      "name": "📄 Preparar Lista de Archivos"
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        0,
        0
      ],
      "id": "d3e4f5a6-b7c8-9012-d3e4-f5a6b7c89012",
      "name": "🔁 Loop Archivos"
    },
    {
      "parameters": {
        "url": "=https://slwyaivbjyjcndcebbn.supabase.co/storage/v1/object/public/restaurant-knowledge/{{ $json.files[$('🔁 Loop Archivos').context.currentRunIndex].file_path }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        200,
        0
      ],
      "id": "e4f5a6b7-c8d9-0123-e4f5-a6b7c8d90123",
      "name": "⬇️ Descargar Archivo"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// 📝 EXTRAER TEXTO DEL ARCHIVO\n// =============================================\n\nconst fileData = $input.first();\nconst fileName = $('📄 Preparar Lista de Archivos').first().json.files[$('🔁 Loop Archivos').context.currentRunIndex].name;\nconst category = $('📄 Preparar Lista de Archivos').first().json.files[$('🔁 Loop Archivos').context.currentRunIndex].category;\n\n// El contenido viene en text\nconst content = fileData.json.data || fileData.json.text || JSON.stringify(fileData.json);\n\nconsole.log('📄 Procesando archivo:', fileName);\nconsole.log('📁 Categoría:', category);\nconsole.log('📏 Longitud:', content.length);\n\nreturn {\n  file_name: fileName,\n  category: category,\n  content: content\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        400,
        0
      ],
      "id": "f5a6b7c8-d9e0-1234-f5a6-b7c8d9e01234",
      "name": "📝 Extraer Texto"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// 📚 CONCATENAR TODO EL CONTENIDO\n// =============================================\n\nconst allFiles = $input.all();\nconst validationData = $('🔍 Validar Input').first().json;\n\nconsole.log('📚 Total de archivos procesados:', allFiles.length);\n\n// Concatenar todo\nlet fullContent = '=== INFORMACIÓN DEL RESTAURANTE ===\\n\\n';\n\nallFiles.forEach((file) => {\n  const data = file.json;\n  fullContent += `\\n--- ${data.file_name} (${data.category}) ---\\n${data.content}\\n\\n`;\n});\n\nconsole.log('✅ Contenido total concatenado');\nconsole.log('📏 Caracteres totales:', fullContent.length);\n\nreturn {\n  restaurant_id: validationData.restaurant_id,\n  query: validationData.query,\n  full_content: fullContent,\n  files_processed: allFiles.length\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        600,
        0
      ],
      "id": "a6b7c8d9-e0f1-2345-a6b7-c8d9e0f12345",
      "name": "📚 Concatenar Todo"
    },
    {
      "parameters": {
        "model": "gpt-4o-mini",
        "options": {
          "systemMessage": "=Eres un asistente que responde preguntas basándote ÚNICAMENTE en el contenido proporcionado.\n\nREGLAS CRÍTICAS:\n1. SOLO usa la información del contenido que te proporcionan\n2. Si la información NO está en el contenido, di: \"No tengo esa información\"\n3. NUNCA inventes, asumas o agregues información externa\n4. Responde en el MISMO IDIOMA que la pregunta\n5. Sé claro, conciso y amigable"
        },
        "text": "=CONTENIDO DEL RESTAURANTE:\n\n{{ $json.full_content }}\n\n---\n\nPREGUNTA DEL CLIENTE:\n{{ $json.query }}"
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        800,
        0
      ],
      "id": "b7c8d9e0-f1a2-3456-b7c8-d9e0f1a23456",
      "name": "🤖 GPT-4o-mini",
      "credentials": {
        "openAiApi": {
          "id": "zwtmjTlXACMvkqZx",
          "name": "OpenAi La-IA"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// ✅ PREPARAR RESPUESTA FINAL\n// =============================================\n\nconst llmResponse = $input.first().json;\nconst previousData = $('📚 Concatenar Todo').first().json;\n\nconst answer = llmResponse.text || llmResponse.output || llmResponse.response || '';\n\nconsole.log('✅ Respuesta generada');\nconsole.log('📏 Longitud respuesta:', answer.length);\n\nreturn {\n  success: true,\n  found: true,\n  answer: answer,\n  query: previousData.query,\n  files_used: previousData.files_processed\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1000,
        0
      ],
      "id": "c8d9e0f1-a2b3-4567-c8d9-e0f1a2b34567",
      "name": "✅ Preparar Respuesta"
    }
  ],
  "connections": {
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "🔍 Validar Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "🔍 Validar Input": {
      "main": [
        [
          {
            "node": "📥 Buscar Archivos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "📥 Buscar Archivos": {
      "main": [
        [
          {
            "node": "📄 Preparar Lista de Archivos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "📄 Preparar Lista de Archivos": {
      "main": [
        [
          {
            "node": "🔁 Loop Archivos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "🔁 Loop Archivos": {
      "main": [
        [
          {
            "node": "⬇️ Descargar Archivo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "⬇️ Descargar Archivo": {
      "main": [
        [
          {
            "node": "📝 Extraer Texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "📝 Extraer Texto": {
      "main": [
        [
          {
            "node": "🔁 Loop Archivos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "🔁 Loop Archivos": {
      "main": [
        null,
        [
          {
            "node": "📚 Concatenar Todo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "📚 Concatenar Todo": {
      "main": [
        [
          {
            "node": "🤖 GPT-4o-mini",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "🤖 GPT-4o-mini": {
      "main": [
        [
          {
            "node": "✅ Preparar Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "968c65341fc947850f62b4a42d249947219a244717952c0dbaf2b62952e73bd9"
  }
}

