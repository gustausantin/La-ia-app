{
  "name": "07 - RAG Search Tool (Simple)",
  "nodes": [
    {
      "parameters": {},
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -800,
        0
      ],
      "id": "13197e7d-15fc-45af-bb13-1c3e04394bcc",
      "name": "When Executed by Another Workflow"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// ğŸ” VALIDAR INPUT DEL SUPER AGENT\n// =============================================\n\nconst input = $input.first().json;\n\nconsole.log('ğŸ“¥ Input recibido:', JSON.stringify(input, null, 2));\n\n// ========== VALIDACIONES ==========\nif (!input.restaurant_id) {\n  throw new Error('âŒ restaurant_id es obligatorio');\n}\n\nif (!input.query) {\n  throw new Error('âŒ query es obligatorio (pregunta del cliente)');\n}\n\nconsole.log('âœ… ValidaciÃ³n correcta');\nconsole.log('ğŸª Restaurant ID:', input.restaurant_id);\nconsole.log('â“ Query:', input.query);\n\nreturn {\n  restaurant_id: input.restaurant_id,\n  query: input.query\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -600,
        0
      ],
      "id": "a73a984a-faef-482b-b478-91bc5f95fe6b",
      "name": "ğŸ” Validar Input"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "restaurant_knowledge_files",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "restaurant_id",
              "condition": "equals",
              "keyValue": "={{ $json.restaurant_id }}"
            },
            {
              "keyName": "status",
              "condition": "equals",
              "keyValue": "completed"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -400,
        0
      ],
      "id": "b1c2d3e4-f5a6-7890-b1c2-d3e4f5a67890",
      "name": "ğŸ“¥ Buscar Archivos",
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// ğŸ“„ EXTRAER Y CONCATENAR CONTENIDO\n// =============================================\n\nconst files = $input.all();\nconst validationData = $('ğŸ” Validar Input').first().json;\n\nconsole.log('ğŸ“¥ Archivos encontrados:', files.length);\n\nif (!files || files.length === 0) {\n  console.log('âŒ No hay archivos procesados para este restaurante');\n  return {\n    success: false,\n    found: false,\n    answer: 'Lo siento, aÃºn no tengo informaciÃ³n cargada sobre el restaurante. El propietario debe subir los documentos primero.',\n    query: validationData.query\n  };\n}\n\n// Concatenar todo el contenido de todos los archivos\nlet allContent = '';\nconst filesList = [];\n\nfiles.forEach((file) => {\n  const data = file.json;\n  \n  // AquÃ­ necesitamos descargar el contenido del archivo de Supabase Storage\n  // Por ahora, asumimos que ya tenemos el contenido en texto\n  // (En el workflow real, necesitaremos un nodo HTTP Request para descargar)\n  \n  filesList.push({\n    name: data.file_name,\n    category: data.category,\n    file_path: data.file_path\n  });\n});\n\nconsole.log('ğŸ“š Archivos a procesar:', filesList.length);\nconsole.log('ğŸ“„ Archivos:', filesList.map(f => f.name).join(', '));\n\nreturn {\n  restaurant_id: validationData.restaurant_id,\n  query: validationData.query,\n  files: filesList,\n  files_count: filesList.length\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -200,
        0
      ],
      "id": "c2d3e4f5-a6b7-8901-c2d3-e4f5a6b78901",
      "name": "ğŸ“„ Preparar Lista de Archivos"
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        0,
        0
      ],
      "id": "d3e4f5a6-b7c8-9012-d3e4-f5a6b7c89012",
      "name": "ğŸ” Loop Archivos"
    },
    {
      "parameters": {
        "url": "=https://slwyaivbjyjcndcebbn.supabase.co/storage/v1/object/public/restaurant-knowledge/{{ $json.files[$('ğŸ” Loop Archivos').context.currentRunIndex].file_path }}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        200,
        0
      ],
      "id": "e4f5a6b7-c8d9-0123-e4f5-a6b7c8d90123",
      "name": "â¬‡ï¸ Descargar Archivo"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// ğŸ“ EXTRAER TEXTO DEL ARCHIVO\n// =============================================\n\nconst fileData = $input.first();\nconst fileName = $('ğŸ“„ Preparar Lista de Archivos').first().json.files[$('ğŸ” Loop Archivos').context.currentRunIndex].name;\nconst category = $('ğŸ“„ Preparar Lista de Archivos').first().json.files[$('ğŸ” Loop Archivos').context.currentRunIndex].category;\n\n// El contenido viene en text\nconst content = fileData.json.data || fileData.json.text || JSON.stringify(fileData.json);\n\nconsole.log('ğŸ“„ Procesando archivo:', fileName);\nconsole.log('ğŸ“ CategorÃ­a:', category);\nconsole.log('ğŸ“ Longitud:', content.length);\n\nreturn {\n  file_name: fileName,\n  category: category,\n  content: content\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        400,
        0
      ],
      "id": "f5a6b7c8-d9e0-1234-f5a6-b7c8d9e01234",
      "name": "ğŸ“ Extraer Texto"
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// ğŸ“š CONCATENAR TODO EL CONTENIDO\n// =============================================\n\nconst allFiles = $input.all();\nconst validationData = $('ğŸ” Validar Input').first().json;\n\nconsole.log('ğŸ“š Total de archivos procesados:', allFiles.length);\n\n// Concatenar todo\nlet fullContent = '=== INFORMACIÃ“N DEL RESTAURANTE ===\\n\\n';\n\nallFiles.forEach((file) => {\n  const data = file.json;\n  fullContent += `\\n--- ${data.file_name} (${data.category}) ---\\n${data.content}\\n\\n`;\n});\n\nconsole.log('âœ… Contenido total concatenado');\nconsole.log('ğŸ“ Caracteres totales:', fullContent.length);\n\nreturn {\n  restaurant_id: validationData.restaurant_id,\n  query: validationData.query,\n  full_content: fullContent,\n  files_processed: allFiles.length\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        600,
        0
      ],
      "id": "a6b7c8d9-e0f1-2345-a6b7-c8d9e0f12345",
      "name": "ğŸ“š Concatenar Todo"
    },
    {
      "parameters": {
        "model": "gpt-4o-mini",
        "options": {
          "systemMessage": "=Eres un asistente que responde preguntas basÃ¡ndote ÃšNICAMENTE en el contenido proporcionado.\n\nREGLAS CRÃTICAS:\n1. SOLO usa la informaciÃ³n del contenido que te proporcionan\n2. Si la informaciÃ³n NO estÃ¡ en el contenido, di: \"No tengo esa informaciÃ³n\"\n3. NUNCA inventes, asumas o agregues informaciÃ³n externa\n4. Responde en el MISMO IDIOMA que la pregunta\n5. SÃ© claro, conciso y amigable"
        },
        "text": "=CONTENIDO DEL RESTAURANTE:\n\n{{ $json.full_content }}\n\n---\n\nPREGUNTA DEL CLIENTE:\n{{ $json.query }}"
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        800,
        0
      ],
      "id": "b7c8d9e0-f1a2-3456-b7c8-d9e0f1a23456",
      "name": "ğŸ¤– GPT-4o-mini",
      "credentials": {
        "openAiApi": {
          "id": "zwtmjTlXACMvkqZx",
          "name": "OpenAi La-IA"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// =============================================\n// âœ… PREPARAR RESPUESTA FINAL\n// =============================================\n\nconst llmResponse = $input.first().json;\nconst previousData = $('ğŸ“š Concatenar Todo').first().json;\n\nconst answer = llmResponse.text || llmResponse.output || llmResponse.response || '';\n\nconsole.log('âœ… Respuesta generada');\nconsole.log('ğŸ“ Longitud respuesta:', answer.length);\n\nreturn {\n  success: true,\n  found: true,\n  answer: answer,\n  query: previousData.query,\n  files_used: previousData.files_processed\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1000,
        0
      ],
      "id": "c8d9e0f1-a2b3-4567-c8d9-e0f1a2b34567",
      "name": "âœ… Preparar Respuesta"
    }
  ],
  "connections": {
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "ğŸ” Validar Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Validar Input": {
      "main": [
        [
          {
            "node": "ğŸ“¥ Buscar Archivos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“¥ Buscar Archivos": {
      "main": [
        [
          {
            "node": "ğŸ“„ Preparar Lista de Archivos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“„ Preparar Lista de Archivos": {
      "main": [
        [
          {
            "node": "ğŸ” Loop Archivos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Loop Archivos": {
      "main": [
        [
          {
            "node": "â¬‡ï¸ Descargar Archivo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "â¬‡ï¸ Descargar Archivo": {
      "main": [
        [
          {
            "node": "ğŸ“ Extraer Texto",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“ Extraer Texto": {
      "main": [
        [
          {
            "node": "ğŸ” Loop Archivos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ” Loop Archivos": {
      "main": [
        null,
        [
          {
            "node": "ğŸ“š Concatenar Todo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ“š Concatenar Todo": {
      "main": [
        [
          {
            "node": "ğŸ¤– GPT-4o-mini",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ğŸ¤– GPT-4o-mini": {
      "main": [
        [
          {
            "node": "âœ… Preparar Respuesta",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "968c65341fc947850f62b4a42d249947219a244717952c0dbaf2b62952e73bd9"
  }
}

