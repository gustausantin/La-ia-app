{
  "nodes": [
    {
      "parameters": {
        "jsCode": "// ═══════════════════════════════════════════════════════════════\n// NODO: 🏪 Buscar Restaurante\n// PROPÓSITO: Obtener datos del restaurante desde la base de datos\n// ═══════════════════════════════════════════════════════════════\n\nconst restaurantId = $input.first().json.restaurant_id;\nconst restaurantData = $input.first().json.restaurant_data;\n\nconsole.log('🏪 Datos del restaurante:', restaurantId);\n\nreturn {\n  ...restaurantData,\n  restaurant_id: restaurantId\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-280, 64],
      "id": "restaurant-node",
      "name": "🏪 Buscar Restaurante"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "customers",
        "id": "={{ $json.customer_id }}"
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [-280, 180],
      "id": "customer-node",
      "name": "👤 Buscar Cliente",
      "credentials": {
        "supabaseApi": {
          "id": "9pdl4V7ImejCLZWo",
          "name": "Supabase La-IA"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// ═══════════════════════════════════════════════════════════════\n// NODO: 🧹 Limpiar y Estructurar para Prompt\n// PROPÓSITO: Combinar y limpiar todos los datos\n// ═══════════════════════════════════════════════════════════════\n\nconst fusionarClientesData = $('🏪 Buscar Restaurante').first().json;\nconst customerData = $('👤 Buscar Cliente').first().json || $input.first().json;\nconst reservasData = $('📅 Get Reservas Activas').first().json;\n\nconsole.log('🧹 Limpiando y estructurando datos para el prompt...');\n\n// Extraer información clave del restaurante\nconst restaurante = {\n  id: fusionarClientesData.id || fusionarClientesData.restaurant_id,\n  nombre: fusionarClientesData.name || fusionarClientesData.restaurant_name,\n  telefono: fusionarClientesData.phone,\n  email: fusionarClientesData.email,\n  direccion: fusionarClientesData.address,\n  ciudad: fusionarClientesData.city,\n  tipoCocina: fusionarClientesData.cuisine_type\n};\n\n// Extraer información del cliente\nconst cliente = {\n  id: customerData.id,\n  nombre: customerData.name,\n  email: customerData.email,\n  telefono: customerData.phone\n};\n\n// Procesar reservas existentes\nconst reservasExistentes = reservasData.items || [];\n\n// Estructurar información limpia para el prompt\nconst informacionLimpia = {\n  restaurante: restaurante,\n  cliente: cliente,\n  reservasExistentes: reservasExistentes.length,\n  detalleReservas: reservasExistentes.map(r => ({\n    fecha: r.reservation_date,\n    hora: r.reservation_time,\n    personas: r.party_size,\n    estado: r.status,\n    zona: r.preferred_zone || 'no especificada',\n    notas: r.special_requests || 'ninguna'\n  })),\n  contexto: {\n    hasReservas: reservasExistentes.length > 0,\n    ultimaReserva: reservasExistentes.length > 0 ? {\n      fecha: reservasExistentes[reservasExistentes.length - 1].reservation_date,\n      estado: reservasExistentes[reservasExistentes.length - 1].status\n    } : null\n  }\n};\n\nreturn informacionLimpia;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [176, 64],
      "id": "cleanup-node",
      "name": "🧹 Limpiar y Estructurar"
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "reservations",
        "returnAll": true,
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {\n              \"keyName\": \"restaurant_id\",\n              \"condition\": \"eq\",\n              \"keyValue\": \"={{ $json.restaurant_id || $json.id }}\"\n            },\n            {\n              \"keyName\": \"customer_phone\",\n              \"condition\": \"eq\",\n              \"keyValue\": \"={{ $json.customer_phone }}\"\n            }\n          ]\n        }\n      },\n      \"type\": \"n8n-nodes-base.supabase\",\n      \"typeVersion\": 1,\n      \"position\": [0, 64],\n      \"id\": \"ed5652c8-5b20-4cf2-9a7d-a2e56cb5620d\",\n      \"name\": \"📅 Get Reservas Activas\",\n      \"alwaysOutputData\": true,\n      \"credentials\": {\n        \"supabaseApi\": {\n          \"id\": \"9pdl4V7ImejCLZWo\",\n          \"name\": \"Supabase La-IA\"\n        }\n      },\n      \"continueOnFail\": true\n    }\n  ],\n  \"connections\": {\n    \"🏪 Buscar Restaurante\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"📅 Get Reservas Activas\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"👤 Buscar Cliente\": {\n      \"main\": [\n        []\n      ]\n    },\n    \"📅 Get Reservas Activas\": {\n      \"main\": [\n        [\n          {\n            \"node\": \"🧹 Limpiar y Estructurar\",\n            \"type\": \"main\",\n            \"index\": 0\n          }\n        ]\n      ]\n    },\n    \"🧹 Limpiar y Estructurar\": {\n      \"main\": [\n        []\n      ]\n    }\n  }\n}"
